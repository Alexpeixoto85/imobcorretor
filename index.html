<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ImobiPro - Gestão Imobiliária</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            /* Cores Imobiliárias */
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #64748b;
            --accent: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #0f172a;
            --light: #f8fafc;
            --surface: #ffffff;
            --border: #e2e8f0;
            --property-sale: #3b82f6;
            --property-rent: #10b981;
            --property-featured: #f59e0b;
            
            /* Dimensões */
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
            --header-height: calc(60px + var(--safe-top));
            --nav-height: calc(65px + var(--safe-bottom));
            --radius-lg: 16px;
            --radius-md: 12px;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-float: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
            color: var(--dark);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            user-select: none;
        }

        /* --- Header --- */
        header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: var(--safe-top) 16px 10px;
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 50;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            box-shadow: var(--shadow-sm);
        }

        .brand {
            font-size: 1.25rem;
            font-weight: 800;
            color: var(--dark);
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .brand span { color: var(--primary); }
        
        .header-actions { display: flex; gap: 12px; }
        .icon-btn {
            background: none; border: none; font-size: 1.2rem;
            color: var(--secondary); padding: 8px;
            border-radius: 50%; transition: 0.2s;
        }
        .icon-btn:active { background: #f1f5f9; color: var(--primary); transform: scale(0.95); }

        /* --- Main Content --- */
        main {
            flex: 1;
            overflow-y: auto;
            padding: calc(var(--header-height) + 16px) 16px calc(var(--nav-height) + 80px);
            scroll-behavior: smooth;
        }

        .view { display: none; animation: fadeIn 0.3s ease; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Stats Cards --- */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--surface);
            padding: 16px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            display: flex;
            flex-direction: column;
            gap: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .stat-card:active { transform: scale(0.98); box-shadow: var(--shadow-sm); }

        .stat-icon {
            width: 32px; height: 32px;
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.9rem;
        }
        .stat-value { font-size: 1.5rem; font-weight: 700; color: var(--dark); line-height: 1; }
        .stat-label { font-size: 0.8rem; color: var(--secondary); font-weight: 500; }

        /* Chart */
        .chart-container {
            background: var(--surface);
            border-radius: var(--radius-md);
            padding: 16px;
            box-shadow: var(--shadow-sm);
            margin-bottom: 24px;
            height: 300px;
            position: relative;
        }

        /* Colors */
        .bg-blue { background: #dbeafe; color: var(--primary); }
        .bg-green { background: #d1fae5; color: var(--success); }
        .bg-orange { background: #ffedd5; color: var(--warning); }
        .bg-red { background: #fee2e2; color: var(--danger); }
        .bg-purple { background: #f3e8ff; color: #8b5cf6; }
        .bg-cyan { background: #cffafe; color: #06b6d4; }

        /* --- Section Titles --- */
        .section-title {
            font-size: 1.1rem; font-weight: 700; margin-bottom: 12px;
            display: flex; justify-content: space-between; align-items: center;
        }

        /* --- Search --- */
        .search-container {
            position: relative; margin-bottom: 16px;
        }
        .search-input {
            width: 100%; padding: 12px 12px 12px 40px;
            border: 1px solid var(--border); border-radius: var(--radius-md);
            background: var(--surface); font-size: 1rem; outline: none;
            -webkit-appearance: none;
        }
        .search-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .search-icon {
            position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
            color: var(--secondary);
        }

        /* --- Property Card --- */
        .property-card {
            background: var(--surface);
            border-radius: var(--radius-md);
            margin-bottom: 16px;
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
            border-left: 4px solid transparent;
            transition: transform 0.2s;
            cursor: pointer;
        }
        .property-card:active { transform: scale(0.98); }

        .property-image {
            width: 100%; height: 180px;
            object-fit: cover;
            background: #e2e8f0;
            display: flex; align-items: center; justify-content: center;
            color: var(--secondary);
            position: relative;
        }

        .property-badge {
            position: absolute; top: 12px; left: 12px;
            padding: 4px 10px; border-radius: 20px;
            font-size: 0.7rem; font-weight: 700;
            z-index: 2;
        }
        .badge-sale { background: var(--property-sale); color: white; }
        .badge-rent { background: var(--property-rent); color: white; }
        .badge-featured { background: var(--property-featured); color: white; }

        .property-content { padding: 16px; }
        .property-title { 
            font-weight: 700; font-size: 1rem; color: var(--dark);
            margin-bottom: 4px; line-height: 1.3;
        }
        .property-address { 
            font-size: 0.85rem; color: var(--secondary); 
            margin-bottom: 8px; display: flex; align-items: center; gap: 4px;
        }
        .property-features {
            display: flex; gap: 12px; margin-bottom: 12px;
        }
        .feature {
            display: flex; flex-direction: column; align-items: center;
            font-size: 0.75rem; color: var(--secondary);
        }
        .feature i { font-size: 1rem; margin-bottom: 2px; color: var(--primary); }
        
        .property-price {
            font-size: 1.3rem; font-weight: 800; color: var(--primary);
            margin-bottom: 8px;
        }
        .property-price .period { font-size: 0.9rem; color: var(--secondary); }

        .property-actions {
            display: flex; gap: 8px; margin-top: 12px;
            padding-top: 12px; border-top: 1px solid var(--border);
        }
        .btn-sm {
            flex: 1; padding: 8px; border-radius: 8px;
            border: none; font-size: 0.85rem; font-weight: 600;
            display: flex; align-items: center; justify-content: center; gap: 6px;
            cursor: pointer;
        }
        .btn-light { background: #f1f5f9; color: var(--secondary); }
        .btn-primary-soft { background: #dbeafe; color: var(--primary); }
        .btn-whatsapp { background: #dcfce7; color: #16a34a; }
        .btn-cyan { background: #cffafe; color: #0e7490; }

        /* --- Client Card --- */
        .client-card {
            background: var(--surface);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: transform 0.2s;
            position: relative;
        }
        .client-card:active { transform: scale(0.98); }

        .client-header {
            display: flex; justify-content: space-between; align-items: flex-start;
            margin-bottom: 12px;
        }
        .client-name { font-weight: 700; font-size: 1rem; color: var(--dark); }
        .client-type {
            font-size: 0.7rem; padding: 3px 8px; border-radius: 99px;
            font-weight: 600;
        }
        .type-buyer { background: #dbeafe; color: var(--primary); }
        .type-seller { background: #f3e8ff; color: var(--accent); }
        .type-both { background: #fef3c7; color: #b45309; }

        .client-info {
            display: flex; flex-direction: column; gap: 6px;
        }
        .client-row {
            display: flex; align-items: center; gap: 8px;
            font-size: 0.85rem; color: var(--secondary);
        }

        .client-actions {
            display: flex; gap: 8px; margin-top: 12px;
            padding-top: 12px; border-top: 1px solid var(--border);
        }

        .btn-whatsapp-client {
            background: #25D366;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: transform 0.2s;
            flex: 1;
            justify-content: center;
        }
        
        .btn-whatsapp-client:active {
            transform: scale(0.95);
        }

        /* --- Schedule Card --- */
        .schedule-card {
            background: var(--surface);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-sm);
            border-left: 4px solid var(--primary);
            cursor: pointer;
        }

        .schedule-header {
            display: flex; justify-content: space-between; margin-bottom: 8px;
        }
        .schedule-type { 
            font-size: 0.75rem; padding: 3px 8px; border-radius: 4px;
            font-weight: 600; background: #dbeafe; color: var(--primary);
        }
        .schedule-urgent { background: #fee2e2; color: var(--danger); }
        
        .schedule-time {
            font-size: 0.85rem; color: var(--secondary);
            display: flex; align-items: center; gap: 6px;
            margin-bottom: 8px;
        }
        .schedule-title { font-weight: 600; color: var(--dark); margin-bottom: 4px; }
        .schedule-notes { font-size: 0.85rem; color: var(--secondary); }

        /* --- Bottom Navigation --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            height: var(--nav-height);
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid var(--border);
            display: flex; justify-content: space-around;
            padding-bottom: var(--safe-bottom);
            z-index: 50;
        }

        .nav-item {
            flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            color: #94a3b8; text-decoration: none;
            font-size: 0.7rem; font-weight: 500;
            gap: 4px; transition: 0.2s;
        }
        .nav-item i { font-size: 1.25rem; margin-bottom: 2px; }
        .nav-item.active { color: var(--primary); }

        /* --- Floating Action Button --- */
        .fab {
            position: fixed;
            bottom: calc(var(--nav-height) + 16px);
            right: 16px;
            width: 56px; height: 56px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem;
            box-shadow: var(--shadow-float);
            z-index: 40;
            border: none;
            transition: transform 0.2s;
        }
        .fab:active { transform: scale(0.9) rotate(90deg); }

        /* --- Modals --- */
        .modal-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            z-index: 100;
            display: none; opacity: 0;
            transition: opacity 0.3s;
        }
        .modal-overlay.active { display: flex; opacity: 1; }

        .modal-sheet {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--surface);
            border-radius: 20px 20px 0 0;
            padding: 24px 16px calc(24px + var(--safe-bottom));
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            max-height: 90vh;
            overflow-y: auto;
            z-index: 101;
        }
        .modal-overlay.active + .modal-sheet { transform: translateY(0); }

        .sheet-handle {
            width: 40px; height: 4px; background: #cbd5e1;
            border-radius: 2px; margin: 0 auto 20px;
        }

        /* --- Forms --- */
        .form-group { margin-bottom: 16px; }
        .form-label { 
            display: block; font-size: 0.9rem; font-weight: 600; 
            margin-bottom: 6px; color: var(--dark); 
        }
        .form-control {
            width: 100%; padding: 14px;
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 1rem;
            background: #f8fafc;
            -webkit-appearance: none;
        }
        .form-control:focus { background: white; border-color: var(--primary); outline: none; }
        textarea.form-control { min-height: 100px; resize: none; }
        select.form-control { color: var(--dark); }

        .form-row {
            display: flex; gap: 12px;
        }
        .form-row .form-group { flex: 1; }

        .btn-block {
            width: 100%; padding: 16px;
            border: none; border-radius: 12px;
            font-size: 1rem; font-weight: 700;
            background: var(--primary); color: white;
            margin-top: 10px;
        }

        /* --- Property Details --- */
        .details-card {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-md);
        }
        
        .details-header {
            display: flex; justify-content: space-between;
            align-items: flex-start; margin-bottom: 20px;
            padding-bottom: 15px; border-bottom: 1px solid var(--border);
        }
        
        .details-title {
            font-size: 1.3rem; font-weight: 800;
            color: var(--dark);
        }
        
        .details-price {
            font-size: 1.5rem; font-weight: 800;
            color: var(--primary);
        }
        
        .details-section {
            margin-bottom: 20px;
        }
        
        .details-section-title {
            font-size: 0.9rem; font-weight: 700;
            color: var(--primary); text-transform: uppercase;
            letter-spacing: 0.5px; margin-bottom: 8px;
            display: flex; align-items: center; gap: 8px;
        }
        
        .details-info-grid {
            display: grid; grid-template-columns: repeat(2, 1fr);
            gap: 12px; margin-bottom: 16px;
        }
        
        .info-item {
            display: flex; flex-direction: column; gap: 4px;
        }
        
        .info-label {
            font-size: 0.8rem; color: var(--secondary);
            font-weight: 500;
        }
        
        .info-value {
            font-size: 1rem; color: var(--dark);
            font-weight: 600;
        }
        
        .details-actions {
            display: flex; gap: 12px; margin-top: 24px;
            padding-top: 20px; border-top: 1px solid var(--border);
        }
        
        .btn-details {
            flex: 1; padding: 12px; border-radius: 10px;
            border: none; font-weight: 600;
            display: flex; align-items: center;
            justify-content: center; gap: 8px;
            cursor: pointer; transition: transform 0.2s;
        }
        
        .btn-details:active { transform: scale(0.95); }
        
        .btn-details-primary {
            background: var(--primary); color: white;
        }
        
        .btn-details-whatsapp {
            background: #25D366; color: white;
        }
        
        .btn-details-secondary {
            background: var(--light); color: var(--secondary);
        }

        /* --- Image Gallery --- */
        .image-gallery {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }

        .image-gallery-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            height: 120px;
            background: #f1f5f9;
            cursor: pointer;
        }

        .image-gallery-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s;
        }

        .image-gallery-item:hover .image-gallery-img {
            transform: scale(1.05);
        }

        .remove-image-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            cursor: pointer;
            z-index: 2;
        }

        .add-image-btn {
            border: 2px dashed var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-image-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .add-image-btn i {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .image-counter {
            font-size: 0.7rem;
            color: var(--secondary);
            margin-bottom: 8px;
        }

        /* --- Utility --- */
        .empty-state { 
            text-align: center; padding: 40px 20px; 
            color: var(--secondary); 
        }
        .empty-state i { font-size: 3rem; margin-bottom: 16px; opacity: 0.3; }
        
        .toast {
            position: fixed; top: var(--header-height); left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: var(--dark); color: white;
            padding: 12px 24px; border-radius: 50px;
            font-size: 0.9rem; font-weight: 500;
            box-shadow: var(--shadow-float); z-index: 200;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; align-items: center; gap: 8px;
            white-space: nowrap;
        }
        .toast.show { transform: translateX(-50%) translateY(20px); }

        .badge {
            display: inline-block; padding: 2px 8px;
            border-radius: 10px; font-size: 0.7rem;
            font-weight: 700;
        }
        
        .badge-primary { background: var(--primary); color: white; }
        .badge-success { background: var(--success); color: white; }
        .badge-warning { background: var(--warning); color: white; }
        .badge-danger { background: var(--danger); color: white; }
        
        @keyframes pulse { 
            0% { opacity: 1; } 
            50% { opacity: 0.6; } 
            100% { opacity: 1; } 
        }
        
        .highlight { color: var(--primary); font-weight: 700; }

        /* --- Carousel --- */
        .carousel-container {
            position: relative;
            width: 100%;
            height: 250px;
            margin-bottom: 20px;
            border-radius: 12px;
            overflow: hidden;
        }

        .carousel-slide {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .carousel-slide:hover {
            transform: scale(1.02);
        }

        .carousel-slide.active {
            display: block;
        }

        .carousel-nav {
            position: absolute;
            bottom: 15px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 8px;
        }

        .carousel-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: background 0.3s;
        }

        .carousel-dot.active {
            background: white;
        }

        .carousel-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1rem;
            z-index: 1;
            transition: background 0.3s;
        }

        .carousel-arrow:hover {
            background: rgba(0, 0, 0, 0.7);
        }

        .carousel-arrow.prev {
            left: 10px;
        }

        .carousel-arrow.next {
            right: 10px;
        }

        /* --- PDF Button --- */
        .btn-pdf {
            background: #ef4444;
            color: white;
        }

        .btn-pdf:hover {
            background: #dc2626;
        }

        /* --- Image Fullscreen Viewer --- */
        .fullscreen-viewer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .fullscreen-viewer.active {
            display: flex;
            opacity: 1;
        }

        .fullscreen-image-container {
            width: 100%;
            height: 80vh;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .fullscreen-image {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 4px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            animation: zoomIn 0.3s ease;
        }

        @keyframes zoomIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .fullscreen-nav {
            position: absolute;
            top: 50%;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            transform: translateY(-50%);
            pointer-events: none;
        }

        .fullscreen-nav button {
            pointer-events: auto;
            background: rgba(0, 0, 0, 0.5);
            border: none;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: background 0.3s;
        }

        .fullscreen-nav button:hover {
            background: rgba(0, 0, 0, 0.8);
        }

        .fullscreen-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.5);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 1001;
            transition: background 0.3s;
        }

        .fullscreen-close:hover {
            background: rgba(0, 0, 0, 0.8);
        }

        .fullscreen-counter {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            text-align: center;
            color: white;
            font-size: 1rem;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 16px;
            border-radius: 20px;
            display: inline-block;
            width: fit-content;
            margin: 0 auto;
        }

        .fullscreen-thumbnails {
            display: flex;
            gap: 10px;
            padding: 15px;
            overflow-x: auto;
            max-width: 90%;
            margin-top: 10px;
        }

        .fullscreen-thumbnail {
            width: 60px;
            height: 60px;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.3s, transform 0.3s;
            flex-shrink: 0;
            border: 2px solid transparent;
        }

        .fullscreen-thumbnail:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }

        .fullscreen-thumbnail.active {
            opacity: 1;
            border-color: var(--primary);
            transform: scale(1.05);
        }

        .fullscreen-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* WhatsApp quick action */
        .whatsapp-quick {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #25D366;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 2;
            transition: transform 0.2s;
        }

        .whatsapp-quick:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body>

    <header>
        <div class="brand">
            <i class="fas fa-home" style="color: var(--primary);"></i>
            <span>Imobi</span>Pro
        </div>
        <div class="header-actions">
            <button class="icon-btn" onclick="App.backup.exportData()"><i class="fas fa-cloud-download-alt"></i></button>
            <button class="icon-btn" onclick="UI.openSettings()"><i class="fas fa-cog"></i></button>
        </div>
    </header>

    <div id="toast" class="toast">
        <i class="fas fa-check-circle"></i> <span>Ação realizada!</span>
    </div>

    <!-- Image Fullscreen Viewer -->
    <div class="fullscreen-viewer" id="fullscreen-viewer">
        <button class="fullscreen-close" onclick="UI.closeFullscreen()">
            <i class="fas fa-times"></i>
        </button>
        
        <div class="fullscreen-image-container">
            <img id="fullscreen-current-image" class="fullscreen-image" src="" alt="Imagem em tela cheia">
            
            <div class="fullscreen-nav">
                <button onclick="UI.prevFullscreenImage()">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button onclick="UI.nextFullscreenImage()">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
        
        <div class="fullscreen-counter">
            <span id="fullscreen-counter">1</span> / <span id="fullscreen-total">1</span>
        </div>
        
        <div class="fullscreen-thumbnails" id="fullscreen-thumbnails">
            <!-- Thumbnails will be added here -->
        </div>
    </div>

    <main>
        <!-- Dashboard View -->
        <div id="dashboard-view" class="view active">
            <div class="section-title">Visão Geral</div>
            <div class="stats-grid">
                <div class="stat-card" onclick="UI.navigate('imoveis')">
                    <div class="stat-icon bg-blue"><i class="fas fa-building"></i></div>
                    <div class="stat-value" id="dash-total-imoveis">0</div>
                    <div class="stat-label">Imóveis</div>
                </div>
                <div class="stat-card" onclick="UI.navigate('clientes')">
                    <div class="stat-icon bg-green"><i class="fas fa-users"></i></div>
                    <div class="stat-value" id="dash-total-clientes">0</div>
                    <div class="stat-label">Clientes</div>
                </div>
                <div class="stat-card" onclick="UI.navigate('agenda')">
                    <div class="stat-icon bg-orange"><i class="fas fa-calendar-alt"></i></div>
                    <div class="stat-value" id="dash-visitas">0</div>
                    <div class="stat-label">Visitas Hoje</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-red"><i class="fas fa-chart-line"></i></div>
                    <div class="stat-value" id="dash-vendas">R$ 0</div>
                    <div class="stat-label">Vendas Mês</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-cyan"><i class="fas fa-handshake"></i></div>
                    <div class="stat-value" id="dash-negociacoes">0</div>
                    <div class="stat-label">Negociações</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-purple"><i class="fas fa-star"></i></div>
                    <div class="stat-value" id="dash-destaques">0</div>
                    <div class="stat-label">Destaques</div>
                </div>
            </div>

            <div class="section-title">
                Próximas Visitas
                <span class="badge badge-primary" id="visitas-badge" style="display:none">!</span>
            </div>
            <div id="visitas-list">
                <!-- Lista de visitas será preenchida aqui -->
            </div>
            
            <div class="section-title">
                Negociações Recentes
                <span class="badge badge-warning" id="negociacoes-badge" style="display:none">!</span>
            </div>
            <div id="negociacoes-list">
                <!-- Lista de negociações será preenchida aqui -->
            </div>
        </div>

        <!-- Imóveis View -->
        <div id="imoveis-view" class="view">
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" placeholder="Buscar imóveis..." oninput="UI.renderImoveis(this.value)">
            </div>
            <div class="form-row" style="margin-bottom: 16px;">
                <select class="form-control" onchange="UI.filterImoveis(this.value, document.getElementById('filter-status').value)">
                    <option value="">Todos os tipos</option>
                    <option value="apartamento">Apartamento</option>
                    <option value="casa">Casa</option>
                    <option value="terreno">Terreno</option>
                    <option value="comercial">Comercial</option>
                </select>
                <select class="form-control" id="filter-status" onchange="UI.filterImoveis(document.querySelector('select').value, this.value)">
                    <option value="">Todos os status</option>
                    <option value="disponivel">Disponível</option>
                    <option value="vendido">Vendido</option>
                    <option value="alugado">Alugado</option>
                    <option value="reservado">Reservado</option>
                </select>
            </div>
            <div id="imoveis-list"></div>
        </div>

        <!-- Clientes View -->
        <div id="clientes-view" class="view">
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" placeholder="Buscar clientes..." oninput="UI.renderClientes(this.value)">
            </div>
            <div id="clientes-list"></div>
        </div>

        <!-- Agenda View -->
        <div id="agenda-view" class="view">
            <div class="section-title">
                Agenda
                <button class="icon-btn" style="background: var(--primary); color: white; border-radius: 8px;" onclick="UI.openNewVisita()">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            <div id="agenda-list"></div>
        </div>

        <!-- Relatórios View -->
        <div id="relatorios-view" class="view">
            <div class="section-title">Desempenho Mensal</div>
            <div class="chart-container">
                <canvas id="performanceChart"></canvas>
            </div>

            <div class="section-title">Resumo Financeiro</div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon bg-green"><i class="fas fa-money-bill-wave"></i></div>
                    <div class="stat-value" id="rel-vendas-mes">R$ 0</div>
                    <div class="stat-label">Vendas Mês</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-blue"><i class="fas fa-hand-holding-usd"></i></div>
                    <div class="stat-value" id="rel-alugueis-mes">R$ 0</div>
                    <div class="stat-label">Aluguéis Mês</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-orange"><i class="fas fa-chart-pie"></i></div>
                    <div class="stat-value" id="rel-comissao">R$ 0</div>
                    <div class="stat-label">Comissão</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-purple"><i class="fas fa-bullseye"></i></div>
                    <div class="stat-value" id="rel-conversao">0%</div>
                    <div class="stat-label">Conversão</div>
                </div>
            </div>
        </div>
    </main>

    <button class="fab" onclick="UI.openNewImovel()" id="main-fab">
        <i class="fas fa-plus"></i>
    </button>

    <nav class="bottom-nav">
        <a href="#" class="nav-item active" data-target="dashboard-view" onclick="UI.switchTab(this)">
            <i class="fas fa-home"></i> <span>Início</span>
        </a>
        <a href="#" class="nav-item" data-target="imoveis-view" onclick="UI.switchTab(this)">
            <i class="fas fa-building"></i> <span>Imóveis</span>
        </a>
        <a href="#" class="nav-item" data-target="clientes-view" onclick="UI.switchTab(this)">
            <i class="fas fa-users"></i> <span>Clientes</span>
        </a>
        <a href="#" class="nav-item" data-target="agenda-view" onclick="UI.switchTab(this)">
            <i class="fas fa-calendar-alt"></i> <span>Agenda</span>
        </a>
        <a href="#" class="nav-item" data-target="relatorios-view" onclick="UI.switchTab(this)">
            <i class="fas fa-chart-bar"></i> <span>Relatórios</span>
        </a>
    </nav>

    <!-- Modal de Detalhes do Imóvel -->
    <div class="modal-overlay" id="overlay-imovel-details"></div>
    <div class="modal-sheet" id="sheet-imovel-details">
        <div class="sheet-handle"></div>
        <div id="imovel-details-content">
            <!-- Conteúdo será preenchido dinamicamente -->
        </div>
    </div>

    <!-- Modal de Cliente -->
    <div class="modal-overlay" id="overlay-cliente"></div>
    <div class="modal-sheet" id="sheet-cliente">
        <div class="sheet-handle"></div>
        <h3 class="section-title" id="title-cliente">Novo Cliente</h3>
        <form id="form-cliente" onsubmit="App.cliente.save(event)">
            <input type="hidden" id="c-id">
            <div class="form-group">
                <label class="form-label">Nome Completo</label>
                <input type="text" id="c-nome" class="form-control" required>
            </div>
            <div class="form-group">
                <label class="form-label">Tipo de Cliente</label>
                <select id="c-tipo" class="form-control" required>
                    <option value="comprador">Comprador</option>
                    <option value="vendedor">Vendedor</option>
                    <option value="ambos">Comprador/Vendedor</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Telefone (WhatsApp)</label>
                <input type="tel" id="c-telefone" class="form-control" placeholder="(00) 00000-0000" required oninput="Utils.maskPhone(this)">
            </div>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" id="c-email" class="form-control">
            </div>
            <div class="form-group">
                <label class="form-label">Faixa de Preço (Interesse)</label>
                <input type="text" id="c-faixa-preco" class="form-control" placeholder="Ex: R$ 300.000 - 500.000">
            </div>
            <div class="form-group">
                <label class="form-label">Observações</label>
                <textarea id="c-observacoes" class="form-control" placeholder="Anotações sobre o cliente..."></textarea>
            </div>
            <button type="submit" class="btn-block">Salvar Cliente</button>
            <button type="button" class="btn-block" style="background: var(--light); color: var(--secondary); margin-top: 8px;" onclick="UI.closeModals()">Cancelar</button>
        </form>
    </div>

    <!-- Modal de Imóvel -->
    <div class="modal-overlay" id="overlay-imovel"></div>
    <div class="modal-sheet" id="sheet-imovel">
        <div class="sheet-handle"></div>
        <h3 class="section-title" id="title-imovel">Novo Imóvel</h3>
        <form id="form-imovel" onsubmit="App.imovel.save(event)">
            <input type="hidden" id="i-id">
            
            <!-- Galeria de Imagens -->
            <div class="form-group">
                <label class="form-label">Fotos do Imóvel (Máx. 15)</label>
                <div class="image-counter">Fotos adicionadas: <span id="image-counter">0</span>/15</div>
                <div class="image-gallery" id="image-gallery">
                    <div class="image-gallery-item add-image-btn" onclick="document.getElementById('i-imagem-input').click()">
                        <i class="fas fa-plus"></i>
                        <span>Adicionar Foto</span>
                    </div>
                </div>
                <input type="file" id="i-imagem-input" accept="image/*" multiple style="display: none;" onchange="App.imovel.handleMultipleImages(this)">
                <input type="hidden" id="i-imagens-data">
            </div>

            <div class="form-group">
                <label class="form-label">Título do Anúncio</label>
                <input type="text" id="i-titulo" class="form-control" placeholder="Ex: Apartamento 3 quartos com vista..." required>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Tipo</label>
                    <select id="i-tipo" class="form-control" required>
                        <option value="apartamento">Apartamento</option>
                        <option value="casa">Casa</option>
                        <option value="terreno">Terreno</option>
                        <option value="comercial">Comercial</option>
                        <option value="kitnet">Kitnet</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Transação</label>
                    <select id="i-transacao" class="form-control" required onchange="App.imovel.toggleAluguelFields()">
                        <option value="venda">Venda</option>
                        <option value="aluguel">Aluguel</option>
                        <option value="ambos">Venda/Aluguel</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Preço de Venda (R$)</label>
                    <input type="text" id="i-preco-venda" class="form-control" placeholder="0,00" oninput="Utils.maskMoney(this)">
                </div>
                <div class="form-group" id="i-aluguel-group" style="display: none;">
                    <label class="form-label">Preço de Aluguel (R$)</label>
                    <input type="text" id="i-preco-aluguel" class="form-control" placeholder="0,00" oninput="Utils.maskMoney(this)">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Endereço Completo</label>
                <input type="text" id="i-endereco" class="form-control" placeholder="Rua, número, bairro, cidade" required>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Área (m²)</label>
                    <input type="number" id="i-area" class="form-control" placeholder="Ex: 120">
                </div>
                <div class="form-group">
                    <label class="form-label">Quartos</label>
                    <input type="number" id="i-quartos" class="form-control" placeholder="Ex: 3">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Banheiros</label>
                    <input type="number" id="i-banheiros" class="form-control" placeholder="Ex: 2">
                </div>
                <div class="form-group">
                    <label class="form-label">Vagas</label>
                    <input type="number" id="i-vagas" class="form-control" placeholder="Ex: 2">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Status</label>
                <select id="i-status" class="form-control">
                    <option value="disponivel">Disponível</option>
                    <option value="reservado">Reservado</option>
                    <option value="vendido">Vendido</option>
                    <option value="alugado">Alugado</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Descrição</label>
                <textarea id="i-descricao" class="form-control" placeholder="Descreva o imóvel, comodidades, localização..."></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Observações Internas</label>
                <textarea id="i-observacoes" class="form-control" placeholder="Informações privadas sobre o imóvel..."></textarea>
            </div>

            <button type="submit" class="btn-block">Salvar Imóvel</button>
            <button type="button" class="btn-block" style="background: var(--light); color: var(--secondary); margin-top: 8px;" onclick="UI.closeModals()">Cancelar</button>
        </form>
    </div>

    <!-- Modal de Visita/Agenda -->
    <div class="modal-overlay" id="overlay-visita"></div>
    <div class="modal-sheet" id="sheet-visita">
        <div class="sheet-handle"></div>
        <h3 class="section-title" id="title-visita">Agendar Visita</h3>
        <form id="form-visita" onsubmit="App.agenda.save(event)">
            <input type="hidden" id="v-id">
            
            <div class="form-group">
                <label class="form-label">Tipo</label>
                <select id="v-tipo" class="form-control" required>
                    <option value="visita">Visita ao Imóvel</option>
                    <option value="reuniao">Reunião com Cliente</option>
                    <option value="documentacao">Assinatura de Documentos</option>
                    <option value="outro">Outro</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Cliente</label>
                <select id="v-cliente" class="form-control" required>
                    <option value="">Selecione...</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Imóvel (para visitas)</label>
                <select id="v-imovel" class="form-control">
                    <option value="">Selecione...</option>
                </select>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Data</label>
                    <input type="date" id="v-data" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Horário</label>
                    <input type="time" id="v-horario" class="form-control" required>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Local/Endereço</label>
                <input type="text" id="v-local" class="form-control" placeholder="Endereço da visita ou reunião">
            </div>

            <div class="form-group">
                <label class="form-label">Observações</label>
                <textarea id="v-observacoes" class="form-control" placeholder="Detalhes sobre a visita..."></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Status</label>
                <select id="v-status" class="form-control">
                    <option value="agendado">Agendado</option>
                    <option value="confirmado">Confirmado</option>
                    <option value="realizado">Realizado</option>
                    <option value="cancelado">Cancelado</option>
                </select>
            </div>

            <button type="submit" class="btn-block">Salvar Agendamento</button>
            <button type="button" class="btn-block" style="background: var(--light); color: var(--secondary); margin-top: 8px;" onclick="UI.closeModals()">Cancelar</button>
        </form>
    </div>

    <!-- Modal de Configurações -->
    <div class="modal-overlay" id="overlay-settings"></div>
    <div class="modal-sheet" id="sheet-settings">
        <div class="sheet-handle"></div>
        <h3 class="section-title">Configurações</h3>
        <form id="form-settings" onsubmit="App.settings.save(event)">
            
            <div class="form-group">
                <label class="form-label">Nome do Corretor</label>
                <input type="text" id="s-nome" class="form-control" placeholder="Seu nome completo">
            </div>
            <div class="form-group">
                <label class="form-label">CRECI</label>
                <input type="text" id="s-creci" class="form-control" placeholder="Número do CRECI">
            </div>
            <div class="form-group">
                <label class="form-label">Telefone</label>
                <input type="tel" id="s-telefone" class="form-control" oninput="Utils.maskPhone(this)">
            </div>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" id="s-email" class="form-control">
            </div>
            <div class="form-group">
                <label class="form-label">Imobiliária</label>
                <input type="text" id="s-imobiliaria" class="form-control" placeholder="Nome da imobiliária">
            </div>
            <div class="form-group">
                <label class="form-label">Taxa de Comissão (%)</label>
                    <input type="number" id="s-comissao" class="form-control" placeholder="5" min="0" max="100" step="0.1">
            </div>

            <hr style="border: 0; border-top: 1px solid var(--border); margin: 16px 0;">
            <button type="button" class="btn-block" style="background: var(--danger);" onclick="App.backup.clearData()">
                <i class="fas fa-trash"></i> Resetar Tudo
            </button>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button type="button" class="btn-block" style="background: var(--secondary); margin: 0;" onclick="App.backup.importTrigger()">Importar Backup</button>
                <input type="file" id="import-file" style="display: none;" accept=".json" onchange="App.backup.importData(this)">
                <button type="submit" class="btn-block" style="background: var(--primary); margin: 0;">Salvar Configurações</button>
            </div>
        </form>
    </div>

    <script>
        // --- UTILITÁRIOS ---
        const Utils = {
            id: () => Date.now().toString(36) + Math.random().toString(36).substr(2),
            formatCurrency: (val) => val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }),
            parseCurrency: (str) => parseFloat(str.replace('R$', '').replace('.', '').replace(',', '.').trim()) || 0,
            formatDate: (dateStr) => {
                if(!dateStr) return '-';
                const [y, m, d] = dateStr.split('-');
                return `${d}/${m}/${y}`;
            },
            formatDateTime: (dateStr, timeStr) => {
                if(!dateStr) return '-';
                const date = new Date(`${dateStr}T${timeStr || '00:00'}`);
                return date.toLocaleDateString('pt-BR') + ' ' + date.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
            },
            maskPhone: (input) => {
                let v = input.value.replace(/\D/g, "");
                v = v.replace(/^(\d{2})(\d)/g, "($1) $2");
                v = v.replace(/(\d)(\d{4})$/, "$1-$2");
                input.value = v.substring(0, 15);
            },
            formatPhone: (phone) => {
                if(!phone) return '';
                const nums = phone.replace(/\D/g, "");
                if(nums.length === 10) {
                    return `(${nums.substring(0,2)}) ${nums.substring(2,6)}-${nums.substring(6)}`;
                } else if(nums.length === 11) {
                    return `(${nums.substring(0,2)}) ${nums.substring(2,7)}-${nums.substring(7)}`;
                }
                return phone;
            },
            maskMoney: (input) => {
                let v = input.value.replace(/\D/g, "");
                v = (v / 100).toFixed(2) + "";
                v = v.replace(".", ",");
                v = v.replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
                input.value = v;
            },
            toast: (msg, type = 'success') => {
                const t = document.getElementById('toast');
                t.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> <span>${msg}</span>`;
                t.style.background = type === 'success' ? 'var(--dark)' : 'var(--danger)';
                t.classList.add('show');
                setTimeout(() => t.classList.remove('show'), 3000);
            },
            readImage: (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            },
            compressImage: (base64, quality = 0.7, maxWidth = 1200) => {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.src = base64;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.onerror = () => resolve(base64);
                });
            },
            getToday: () => {
                const today = new Date();
                return today.toISOString().split('T')[0];
            },
            getTodayTime: () => {
                const today = new Date();
                return today.toISOString().split('T')[1].substring(0, 5);
            },
            isToday: (dateStr) => {
                if(!dateStr) return false;
                return dateStr === Utils.getToday();
            },
            getTipoText: (tipo) => {
                const tipos = {
                    'apartamento': 'Apartamento',
                    'casa': 'Casa',
                    'terreno': 'Terreno',
                    'comercial': 'Comercial',
                    'kitnet': 'Kitnet'
                };
                return tipos[tipo] || tipo;
            },
            getStatusText: (status) => {
                const statuses = {
                    'disponivel': 'Disponível',
                    'reservado': 'Reservado',
                    'vendido': 'Vendido',
                    'alugado': 'Alugado'
                };
                return statuses[status] || status;
            },
            getTipoClienteText: (tipo) => {
                const tipos = {
                    'comprador': 'Comprador',
                    'vendedor': 'Vendedor',
                    'ambos': 'Comprador/Vendedor'
                };
                return tipos[tipo] || tipo;
            },
            getTipoVisitaText: (tipo) => {
                const tipos = {
                    'visita': 'Visita ao Imóvel',
                    'reuniao': 'Reunião',
                    'documentacao': 'Documentação',
                    'outro': 'Outro'
                };
                return tipos[tipo] || tipo;
            },
            getStatusVisitaText: (status) => {
                const statuses = {
                    'agendado': 'Agendado',
                    'confirmado': 'Confirmado',
                    'realizado': 'Realizado',
                    'cancelado': 'Cancelado'
                };
                return statuses[status] || status;
            },
            generatePDF: async (imovel) => {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('p', 'mm', 'a4');
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const pageHeight = doc.internal.pageSize.getHeight();
                    const margin = 15;
                    let yPos = margin;
                    
                    // Configurações
                    const settings = Storage.getSettings();
                    
                    // Cabeçalho
                    doc.setFontSize(20);
                    doc.setTextColor(37, 99, 235);
                    doc.text('FICHA TÉCNICA DO IMÓVEL', pageWidth/2, yPos, {align: 'center'});
                    yPos += 10;
                    
                    doc.setFontSize(12);
                    doc.setTextColor(100, 116, 139);
                    doc.text(`${settings.imobiliaria || 'Imobiliária'} | CRECI: ${settings.creci || '---'}`, pageWidth/2, yPos, {align: 'center'});
                    yPos += 15;
                    
                    // Linha divisória
                    doc.setDrawColor(37, 99, 235);
                    doc.setLineWidth(0.5);
                    doc.line(margin, yPos, pageWidth - margin, yPos);
                    yPos += 10;
                    
                    // Informações principais
                    doc.setFontSize(16);
                    doc.setTextColor(15, 23, 42);
                    doc.text(imovel.titulo, margin, yPos);
                    yPos += 8;
                    
                    doc.setFontSize(12);
                    doc.setTextColor(100, 116, 139);
                    doc.text(`Endereço: ${imovel.endereco}`, margin, yPos);
                    yPos += 8;
                    
                    // Preço
                    doc.setFontSize(14);
                    doc.setTextColor(37, 99, 235);
                    let precoText = '';
                    if(imovel.precoVenda) precoText += `Venda: ${Utils.formatCurrency(imovel.precoVenda)} `;
                    if(imovel.precoAluguel) precoText += `Aluguel: ${Utils.formatCurrency(imovel.precoAluguel)}/mês`;
                    doc.text(precoText, margin, yPos);
                    yPos += 10;
                    
                    // Características
                    doc.setFontSize(12);
                    doc.setTextColor(15, 23, 42);
                    const features = [
                        `Tipo: ${Utils.getTipoText(imovel.tipo)}`,
                        `Área: ${imovel.area || 0}m²`,
                        `Quartos: ${imovel.quartos || 0}`,
                        `Banheiros: ${imovel.banheiros || 0}`,
                        `Vagas: ${imovel.vagas || 0}`,
                        `Status: ${Utils.getStatusText(imovel.status)}`
                    ];
                    
                    features.forEach(feature => {
                        doc.text(`• ${feature}`, margin, yPos);
                        yPos += 6;
                    });
                    
                    yPos += 5;
                    
                    // Descrição
                    if(imovel.descricao) {
                        doc.setFontSize(11);
                        doc.setTextColor(100, 116, 139);
                        const descLines = doc.splitTextToSize(imovel.descricao, pageWidth - 2*margin);
                        doc.text('Descrição:', margin, yPos);
                        yPos += 5;
                        doc.text(descLines, margin, yPos);
                        yPos += descLines.length * 5 + 5;
                    }
                    
                    // Verificar se precisa de nova página para imagens
                    if(yPos > pageHeight - 100) {
                        doc.addPage();
                        yPos = margin;
                    }
                    
                    // Adicionar imagens
                    if(imovel.imagens && imovel.imagens.length > 0) {
                        doc.setFontSize(14);
                        doc.setTextColor(15, 23, 42);
                        doc.text('Fotos do Imóvel:', margin, yPos);
                        yPos += 10;
                        
                        const imgWidth = (pageWidth - 2*margin - 10) / 2;
                        const imgHeight = imgWidth * 0.75;
                        let imgX = margin;
                        
                        for(let i = 0; i < imovel.imagens.length; i++) {
                            if(i > 0 && i % 2 === 0) {
                                if(yPos + imgHeight > pageHeight - margin) {
                                    doc.addPage();
                                    yPos = margin;
                                } else {
                                    yPos += imgHeight + 5;
                                    imgX = margin;
                                }
                            }
                            
                            try {
                                // Converter base64 para blob e reduzir tamanho para PDF
                                const base64Data = imovel.imagens[i];
                                const img = new Image();
                                img.src = base64Data;
                                
                                await new Promise((resolve) => {
                                    img.onload = () => {
                                        const canvas = document.createElement('canvas');
                                        canvas.width = 400;
                                        canvas.height = 300;
                                        const ctx = canvas.getContext('2d');
                                        ctx.drawImage(img, 0, 0, 400, 300);
                                        
                                        const compressedBase64 = canvas.toDataURL('image/jpeg', 0.7);
                                        doc.addImage(compressedBase64, 'JPEG', imgX, yPos, imgWidth, imgHeight);
                                        resolve();
                                    };
                                    img.onerror = resolve;
                                });
                                
                            } catch(err) {
                                console.error('Erro ao adicionar imagem:', err);
                            }
                            
                            imgX += imgWidth + 10;
                            
                            // Adicionar número da foto
                            doc.setFontSize(8);
                            doc.setTextColor(100, 116, 139);
                            doc.text(`Foto ${i+1}`, imgX - imgWidth - 10 + 5, yPos + imgHeight + 5);
                        }
                        
                        yPos += imgHeight + 15;
                    }
                    
                    // Rodapé com informações da imobiliária
                    if(yPos > pageHeight - 30) {
                        doc.addPage();
                        yPos = margin;
                    }
                    
                    doc.setDrawColor(226, 232, 240);
                    doc.setLineWidth(0.5);
                    doc.line(margin, yPos, pageWidth - margin, yPos);
                    yPos += 10;
                    
                    doc.setFontSize(10);
                    doc.setTextColor(100, 116, 139);
                    doc.text(`Corretor: ${settings.nome || '---'}`, margin, yPos);
                    doc.text(`Telefone: ${settings.telefone || '---'}`, pageWidth/2, yPos);
                    yPos += 5;
                    doc.text(`Email: ${settings.email || '---'}`, margin, yPos);
                    doc.text(`Data do documento: ${new Date().toLocaleDateString('pt-BR')}`, pageWidth/2, yPos);
                    
                    // Salvar PDF
                    const fileName = `ficha_imovel_${imovel.titulo.substring(0, 20).replace(/[^a-z0-9]/gi, '_')}.pdf`;
                    doc.save(fileName);
                    
                    Utils.toast('PDF gerado com sucesso!');
                    
                } catch(err) {
                    console.error('Erro ao gerar PDF:', err);
                    Utils.toast('Erro ao gerar PDF', 'error');
                }
            },
            openWhatsApp: (phoneNumber, message = '') => {
                if (!phoneNumber) {
                    Utils.toast('Número de telefone não informado', 'error');
                    return;
                }
                
                // Remover formatação do telefone
                const cleanNumber = phoneNumber.replace(/\D/g, '');
                
                // Verificar se tem DDI (Brasil = 55)
                let finalNumber = cleanNumber;
                if (cleanNumber.length === 11 && cleanNumber.startsWith('0')) {
                    finalNumber = '55' + cleanNumber.substring(1);
                } else if (cleanNumber.length === 10) {
                    finalNumber = '55' + cleanNumber;
                } else if (cleanNumber.length === 13 && cleanNumber.startsWith('55')) {
                    finalNumber = cleanNumber;
                } else {
                    // Tentar adivinhar o formato
                    finalNumber = '55' + cleanNumber;
                }
                
                const encodedMessage = encodeURIComponent(message);
                const whatsappUrl = `https://wa.me/${finalNumber}${message ? `?text=${encodedMessage}` : ''}`;
                
                window.open(whatsappUrl, '_blank');
            },
            generateWhatsAppMessage: (cliente, settings) => {
                let message = `Olá ${cliente.nome.split(' ')[0]}! Tudo bem?\n\n`;
                message += `Aqui é ${settings.nome || 'o corretor'} da ${settings.imobiliaria || 'imobiliária'}.\n\n`;
                
                if (cliente.tipo === 'comprador') {
                    message += `Estou entrando em contato sobre o seu interesse em imóveis. `;
                    if (cliente.faixaPreco) {
                        message += `Lembrei que você busca algo na faixa de ${cliente.faixaPreco}.\n\n`;
                    }
                    message += `Tenho algumas opções que podem te interessar. Podemos conversar?`;
                } else if (cliente.tipo === 'vendedor') {
                    message += `Estou acompanhando o seu imóvel. `;
                    message += `Temos novidades sobre a negociação. Podemos conversar?`;
                } else {
                    message += `Estou entrando em contato para conversarmos sobre imóveis. `;
                    message += `Podemos agendar uma conversa?`;
                }
                
                message += `\n\n📞 ${settings.telefone || ''}`;
                message += `\n🏢 ${settings.imobiliaria || ''}`;
                message += `\n👨‍💼 ${settings.nome || ''} | CRECI: ${settings.creci || ''}`;
                
                return message;
            }
        };

        // --- STORAGE MANAGER ---
        const Storage = {
            get: (key) => JSON.parse(localStorage.getItem(`imobipro_${key}`)) || [],
            set: (key, data) => localStorage.setItem(`imobipro_${key}`, JSON.stringify(data)),
            getSettings: () => JSON.parse(localStorage.getItem('imobipro_settings')) || { 
                nome: 'Seu Nome',
                creci: '12345-SP',
                telefone: '(11) 99999-9999',
                email: 'seuemail@imobiliaria.com',
                imobiliaria: 'Imobiliária Exemplo',
                comissao: 5
            },
            saveSettings: (data) => localStorage.setItem('imobipro_settings', JSON.stringify(data))
        };

        // --- UI MANAGER ---
        const UI = {
            data: { 
                clientes: [], 
                imoveis: [], 
                visitas: [] 
            },
            chartInstance: null,
            currentCarouselIndex: 0,
            currentCarouselImages: [],
            fullscreenImages: [],
            fullscreenCurrentIndex: 0,
            
            init: () => {
                UI.data.clientes = Storage.get('clientes');
                UI.data.imoveis = Storage.get('imoveis');
                UI.data.visitas = Storage.get('visitas');
                UI.renderDashboard();
                
                // Tabs listeners
                document.querySelectorAll('.bottom-nav .nav-item').forEach(el => {
                    el.addEventListener('click', (e) => e.preventDefault());
                });
            },

            switchTab: (el) => {
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                
                el.classList.add('active');
                const target = el.getAttribute('data-target');
                document.getElementById(target).classList.add('active');

                // Toggle FAB visibility
                const fab = document.getElementById('main-fab');
                if(target === 'dashboard-view' || target === 'imoveis-view') {
                    fab.style.display = 'flex';
                    fab.onclick = UI.openNewImovel;
                } else if (target === 'clientes-view') {
                    fab.style.display = 'flex';
                    fab.onclick = () => UI.openNewCliente(false);
                } else if (target === 'agenda-view') {
                    fab.style.display = 'flex';
                    fab.onclick = UI.openNewVisita;
                } else {
                    fab.style.display = 'none';
                }

                if(target === 'clientes-view') UI.renderClientes();
                if(target === 'imoveis-view') UI.renderImoveis();
                if(target === 'agenda-view') UI.renderAgenda();
                if(target === 'relatorios-view') UI.renderRelatorios();
            },

            navigate: (tabName) => {
                const el = document.querySelector(`.nav-item[data-target="${tabName}-view"]`);
                if(el) UI.switchTab(el);
            },

            // --- RENDER FUNCTIONS ---
            renderDashboard: () => {
                const { clientes, imoveis, visitas } = UI.data;
                
                // Estatísticas básicas
                document.getElementById('dash-total-clientes').innerText = clientes.length;
                document.getElementById('dash-total-imoveis').innerText = imoveis.length;
                
                // Visitas para hoje
                const hoje = Utils.getToday();
                const visitasHoje = visitas.filter(v => v.data === hoje && v.status !== 'cancelado');
                document.getElementById('dash-visitas').innerText = visitasHoje.length;
                
                // Total de vendas do mês
                const hojeObj = new Date();
                const mesAtual = hojeObj.getMonth();
                const anoAtual = hojeObj.getFullYear();
                
                const vendasMes = imoveis.filter(i => 
                    i.status === 'vendido' || i.status === 'alugado'
                ).filter(i => {
                    if(!i.dataVenda) return false;
                    const dataVenda = new Date(i.dataVenda);
                    return dataVenda.getMonth() === mesAtual && dataVenda.getFullYear() === anoAtual;
                });
                
                const totalVendas = vendasMes.reduce((acc, i) => acc + (i.precoVenda || i.precoAluguel || 0), 0);
                document.getElementById('dash-vendas').innerText = Utils.formatCurrency(totalVendas);
                
                // Negociações ativas
                const negociacoes = imoveis.filter(i => i.status === 'reservado').length;
                document.getElementById('dash-negociacoes').innerText = negociacoes;
                
                // Imóveis em destaque
                const destaques = imoveis.filter(i => i.destaque).length;
                document.getElementById('dash-destaques').innerText = destaques;
                
                // Render visitas de hoje
                const visitasList = document.getElementById('visitas-list');
                if(visitasHoje.length === 0) {
                    visitasList.innerHTML = `<div class="empty-state"><i class="fas fa-calendar-check"></i><p>Nenhuma visita agendada para hoje!</p></div>`;
                } else {
                    visitasList.innerHTML = visitasHoje.map(v => UI.createVisitaCard(v)).join('');
                }
                
                // Render negociações recentes
                const negociacoesList = document.getElementById('negociacoes-list');
                const imoveisReservados = imoveis.filter(i => i.status === 'reservado').slice(0, 3);
                
                if(imoveisReservados.length === 0) {
                    negociacoesList.innerHTML = `<div class="empty-state"><i class="fas fa-handshake"></i><p>Nenhuma negociação ativa!</p></div>`;
                } else {
                    negociacoesList.innerHTML = imoveisReservados.map(i => UI.createNegociacaoCard(i)).join('');
                }
                
                // Badges
                document.getElementById('visitas-badge').style.display = visitasHoje.length > 0 ? 'inline-block' : 'none';
                document.getElementById('negociacoes-badge').style.display = imoveisReservados.length > 0 ? 'inline-block' : 'none';
            },

            createVisitaCard: (v) => {
                const cliente = UI.data.clientes.find(c => c.id === v.clienteId) || { nome: 'Cliente não encontrado' };
                const imovel = UI.data.imoveis.find(i => i.id === v.imovelId) || { titulo: 'Imóvel não especificado' };
                
                const isUrgent = v.status === 'agendado' && v.data === Utils.getToday();
                
                return `
                    <div class="schedule-card ${isUrgent ? 'schedule-urgent' : ''}" onclick="UI.showVisitaDetails('${v.id}')">
                        <div class="schedule-header">
                            <div class="schedule-type">${Utils.getTipoVisitaText(v.tipo)}</div>
                            <span class="badge ${v.status === 'realizado' ? 'badge-success' : v.status === 'cancelado' ? 'badge-danger' : 'badge-primary'}">
                                ${Utils.getStatusVisitaText(v.status)}
                            </span>
                        </div>
                        <div class="schedule-time">
                            <i class="far fa-calendar"></i> ${Utils.formatDate(v.data)} <i class="far fa-clock"></i> ${v.horario}
                        </div>
                        <div class="schedule-title">${cliente.nome}</div>
                        <div class="schedule-notes">
                            ${v.tipo === 'visita' ? `Visita: ${imovel.titulo.substring(0, 30)}...` : v.observacoes || ''}
                        </div>
                    </div>
                `;
            },

            createNegociacaoCard: (i) => {
                const preco = i.precoVenda ? Utils.formatCurrency(i.precoVenda) : Utils.formatCurrency(i.precoAluguel) + '/mês';
                
                return `
                    <div class="property-card" onclick="UI.showImovelDetails('${i.id}')">
                        <div class="property-image">
                            ${i.imagens && i.imagens.length > 0 ? 
                                `<img src="${i.imagens[0]}" style="width:100%;height:100%;object-fit:cover; cursor: pointer;" onclick="event.stopPropagation(); UI.openFullscreen('${i.id}', 0)">` : 
                                `<i class="fas fa-home" style="font-size:3rem;"></i>`
                            }
                            <div class="property-badge badge-warning">RESERVADO</div>
                        </div>
                        <div class="property-content">
                            <div class="property-title">${i.titulo}</div>
                            <div class="property-address">
                                <i class="fas fa-map-marker-alt"></i> ${i.endereco.substring(0, 40)}...
                            </div>
                            <div class="property-price">${preco}</div>
                        </div>
                    </div>
                `;
            },

            renderClientes: (filter = '') => {
                const list = document.getElementById('clientes-list');
                let filtered = UI.data.clientes;
                
                if(filter) {
                    filtered = filtered.filter(c => 
                        c.nome.toLowerCase().includes(filter.toLowerCase()) ||
                        c.email.toLowerCase().includes(filter.toLowerCase()) ||
                        c.telefone.toLowerCase().includes(filter.toLowerCase())
                    );
                }
                
                if(filtered.length === 0) {
                    list.innerHTML = `<div class="empty-state"><i class="fas fa-user-plus"></i><p>Nenhum cliente encontrado.</p></div>`;
                    return;
                }

                list.innerHTML = filtered.map(c => `
                    <div class="client-card" onclick="UI.showClienteDetails('${c.id}')">
                        <div class="whatsapp-quick" onclick="event.stopPropagation(); App.cliente.whatsapp('${c.id}')">
                            <i class="fab fa-whatsapp"></i>
                        </div>
                        <div class="client-header">
                            <div class="client-name">${c.nome}</div>
                            <span class="client-type type-${c.tipo}">${Utils.getTipoClienteText(c.tipo)}</span>
                        </div>
                        <div class="client-info">
                            <div class="client-row"><i class="fas fa-phone"></i> ${c.telefone}</div>
                            ${c.email ? `<div class="client-row"><i class="fas fa-envelope"></i> ${c.email}</div>` : ''}
                            ${c.faixaPreco ? `<div class="client-row"><i class="fas fa-search-dollar"></i> ${c.faixaPreco}</div>` : ''}
                        </div>
                        <div class="client-actions">
                            <button class="btn-whatsapp-client" onclick="event.stopPropagation(); App.cliente.whatsapp('${c.id}')">
                                <i class="fab fa-whatsapp"></i> WhatsApp
                            </button>
                            <button class="btn-sm btn-light" onclick="event.stopPropagation(); App.cliente.edit('${c.id}')">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                        </div>
                    </div>
                `).join('');
            },

            renderImoveis: (filter = '', tipoFilter = '', statusFilter = '') => {
                const list = document.getElementById('imoveis-list');
                let filtered = UI.data.imoveis;
                
                // Aplicar filtros
                if(filter) {
                    filtered = filtered.filter(i => 
                        i.titulo.toLowerCase().includes(filter.toLowerCase()) ||
                        i.endereco.toLowerCase().includes(filter.toLowerCase())
                    );
                }
                
                if(tipoFilter) {
                    filtered = filtered.filter(i => i.tipo === tipoFilter);
                }
                
                if(statusFilter) {
                    filtered = filtered.filter(i => i.status === statusFilter);
                }
                
                // Ordenar por data de criação (mais recentes primeiro)
                filtered.sort((a,b) => new Date(b.dataCriacao) - new Date(a.dataCriacao));

                if(filtered.length === 0) {
                    list.innerHTML = `<div class="empty-state"><i class="fas fa-home"></i><p>Nenhum imóvel encontrado.</p></div>`;
                    return;
                }

                list.innerHTML = filtered.map(i => UI.createImovelCard(i)).join('');
            },

            filterImoveis: (tipo, status) => {
                UI.renderImoveis(document.querySelector('.search-input').value, tipo, status);
            },

            createImovelCard: (i) => {
                let badgeClass = 'badge-sale';
                let badgeText = 'VENDA';
                
                if(i.transacao === 'aluguel') {
                    badgeClass = 'badge-rent';
                    badgeText = 'ALUGUEL';
                } else if(i.transacao === 'ambos') {
                    badgeClass = 'badge-featured';
                    badgeText = 'VENDA/ALUG';
                }
                
                if(i.status === 'vendido' || i.status === 'alugado') {
                    badgeClass = 'badge-success';
                    badgeText = i.status === 'vendido' ? 'VENDIDO' : 'ALUGADO';
                } else if(i.status === 'reservado') {
                    badgeClass = 'badge-warning';
                    badgeText = 'RESERVADO';
                }
                
                const preco = i.precoVenda ? 
                    Utils.formatCurrency(i.precoVenda) : 
                    Utils.formatCurrency(i.precoAluguel) + ' <span class="period">/mês</span>';
                
                const mainImageClick = i.imagens && i.imagens.length > 0 ? 
                    `onclick="event.stopPropagation(); UI.openFullscreen('${i.id}', 0)"` : '';
                
                return `
                    <div class="property-card" onclick="UI.showImovelDetails('${i.id}')">
                        <div class="property-image">
                            ${i.imagens && i.imagens.length > 0 ? 
                                `<img src="${i.imagens[0]}" style="width:100%;height:100%;object-fit:cover; cursor: pointer;" ${mainImageClick}>` : 
                                `<i class="fas fa-home" style="font-size:3rem;"></i>`
                            }
                            <div class="property-badge ${badgeClass}">${badgeText}</div>
                        </div>
                        <div class="property-content">
                            <div class="property-title">${i.titulo}</div>
                            <div class="property-address">
                                <i class="fas fa-map-marker-alt"></i> ${i.endereco.substring(0, 40)}...
                            </div>
                            <div class="property-features">
                                <div class="feature">
                                    <i class="fas fa-bed"></i>
                                    <span>${i.quartos || 0} quarto${i.quartos !== 1 ? 's' : ''}</span>
                                </div>
                                <div class="feature">
                                    <i class="fas fa-bath"></i>
                                    <span>${i.banheiros || 0} banheiro${i.banheiros !== 1 ? 's' : ''}</span>
                                </div>
                                <div class="feature">
                                    <i class="fas fa-car"></i>
                                    <span>${i.vagas || 0} vaga${i.vagas !== 1 ? 's' : ''}</span>
                                </div>
                                <div class="feature">
                                    <i class="fas fa-ruler-combined"></i>
                                    <span>${i.area || 0}m²</span>
                                </div>
                            </div>
                            <div class="property-price">${preco}</div>
                            <div class="property-actions">
                                <button class="btn-sm btn-light" onclick="event.stopPropagation(); App.imovel.edit('${i.id}')">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                                <button class="btn-sm btn-primary-soft" onclick="event.stopPropagation(); UI.openNewVisitaFromImovel('${i.id}')">
                                    <i class="fas fa-calendar-plus"></i> Visita
                                </button>
                                <button class="btn-sm btn-whatsapp" onclick="event.stopPropagation(); App.whatsapp.shareImovel('${i.id}')">
                                    <i class="fab fa-whatsapp"></i> Compartilhar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            },

            showImovelDetails: (id) => {
                const i = UI.data.imoveis.find(x => x.id === id);
                if(!i) return;
                
                let statusBadge = '';
                if(i.status === 'disponivel') statusBadge = `<span class="badge badge-success">DISPONÍVEL</span>`;
                if(i.status === 'reservado') statusBadge = `<span class="badge badge-warning">RESERVADO</span>`;
                if(i.status === 'vendido') statusBadge = `<span class="badge badge-primary">VENDIDO</span>`;
                if(i.status === 'alugado') statusBadge = `<span class="badge badge-primary">ALUGADO</span>`;
                
                const precoVenda = i.precoVenda ? Utils.formatCurrency(i.precoVenda) : '-';
                const precoAluguel = i.precoAluguel ? Utils.formatCurrency(i.precoAluguel) + '/mês' : '-';
                
                // Carousel para múltiplas imagens
                let carouselHTML = '';
                if(i.imagens && i.imagens.length > 0) {
                    UI.currentCarouselImages = i.imagens;
                    UI.currentCarouselIndex = 0;
                    
                    carouselHTML = `
                        <div class="carousel-container">
                            ${i.imagens.map((img, index) => `
                                <img src="${img}" class="carousel-slide ${index === 0 ? 'active' : ''}" id="slide-${index}" onclick="UI.openFullscreen('${i.id}', ${index})">
                            `).join('')}
                            
                            ${i.imagens.length > 1 ? `
                                <button class="carousel-arrow prev" onclick="UI.prevSlide()">‹</button>
                                <button class="carousel-arrow next" onclick="UI.nextSlide()">›</button>
                                <div class="carousel-nav">
                                    ${i.imagens.map((_, index) => `
                                        <div class="carousel-dot ${index === 0 ? 'active' : ''}" onclick="UI.goToSlide(${index})"></div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
                
                const detailsContent = `
                    <div class="details-card">
                        <div class="details-header">
                            <div class="details-title">${i.titulo}</div>
                            ${statusBadge}
                        </div>
                        
                        ${carouselHTML}
                        
                        <div class="details-section">
                            <div class="details-section-title"><i class="fas fa-money-bill-wave"></i> VALORES</div>
                            <div class="details-info-grid">
                                <div class="info-item">
                                    <div class="info-label">Preço de Venda</div>
                                    <div class="info-value">${precoVenda}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Preço de Aluguel</div>
                                    <div class="info-value">${precoAluguel}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Transação</div>
                                    <div class="info-value">${i.transacao === 'venda' ? 'Venda' : i.transacao === 'aluguel' ? 'Aluguel' : 'Venda/Aluguel'}</div>
                                </div>
                                ${i.dataVenda ? `
                                <div class="info-item">
                                    <div class="info-label">Data da Venda</div>
                                    <div class="info-value">${Utils.formatDate(i.dataVenda)}</div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="details-section">
                            <div class="details-section-title"><i class="fas fa-info-circle"></i> INFORMAÇÕES</div>
                            <div class="details-info-grid">
                                <div class="info-item">
                                    <div class="info-label">Tipo</div>
                                    <div class="info-value">${Utils.getTipoText(i.tipo)}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Área</div>
                                    <div class="info-value">${i.area || 0}m²</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Quartos</div>
                                    <div class="info-value">${i.quartos || 0}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Banheiros</div>
                                    <div class="info-value">${i.banheiros || 0}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Vagas</div>
                                    <div class="info-value">${i.vagas || 0}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Status</div>
                                    <div class="info-value">${Utils.getStatusText(i.status)}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="details-section">
                            <div class="details-section-title"><i class="fas fa-map-marker-alt"></i> LOCALIZAÇÃO</div>
                            <div class="info-item">
                                <div class="info-label">Endereço</div>
                                <div class="info-value">${i.endereco}</div>
                            </div>
                        </div>
                        
                        <div class="details-section">
                            <div class="details-section-title"><i class="fas fa-align-left"></i> DESCRIÇÃO</div>
                            <div class="info-item">
                                <div class="info-label">Detalhes</div>
                                <div class="info-value">${i.descricao || 'Sem descrição'}</div>
                            </div>
                        </div>
                        
                        ${i.observacoes ? `
                        <div class="details-section">
                            <div class="details-section-title"><i class="fas fa-eye-slash"></i> OBSERVAÇÕES INTERNAS</div>
                            <div class="info-item">
                                <div class="info-label">Anotações</div>
                                <div class="info-value">${i.observacoes}</div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="details-actions">
                            <button class="btn-details btn-details-primary" onclick="App.imovel.edit('${i.id}')">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button class="btn-details btn-details-whatsapp" onclick="App.whatsapp.shareImovel('${i.id}')">
                                <i class="fab fa-whatsapp"></i> WhatsApp
                            </button>
                            <button class="btn-details btn-details-secondary" onclick="UI.openNewVisitaFromImovel('${i.id}')">
                                <i class="fas fa-calendar-plus"></i> Agendar Visita
                            </button>
                            <button class="btn-details btn-pdf" onclick="Utils.generatePDF(${JSON.stringify(i).replace(/"/g, '&quot;')})">
                                <i class="fas fa-file-pdf"></i> PDF
                            </button>
                        </div>
                    </div>
                    <button class="btn-block" style="background: var(--light); color: var(--secondary); margin-top: 8px;" onclick="UI.closeModals()">Fechar</button>
                `;
                
                document.getElementById('imovel-details-content').innerHTML = detailsContent;
                UI.openModal('imovel-details');
            },

            // Funções do carousel
            nextSlide: () => {
                if(UI.currentCarouselImages.length <= 1) return;
                UI.currentCarouselIndex = (UI.currentCarouselIndex + 1) % UI.currentCarouselImages.length;
                UI.updateCarousel();
            },

            prevSlide: () => {
                if(UI.currentCarouselImages.length <= 1) return;
                UI.currentCarouselIndex = (UI.currentCarouselIndex - 1 + UI.currentCarouselImages.length) % UI.currentCarouselImages.length;
                UI.updateCarousel();
            },

            goToSlide: (index) => {
                UI.currentCarouselIndex = index;
                UI.updateCarousel();
            },

            updateCarousel: () => {
                document.querySelectorAll('.carousel-slide').forEach((slide, index) => {
                    slide.classList.toggle('active', index === UI.currentCarouselIndex);
                });
                document.querySelectorAll('.carousel-dot').forEach((dot, index) => {
                    dot.classList.toggle('active', index === UI.currentCarouselIndex);
                });
            },

            // Funções do visualizador em tela cheia
            openFullscreen: (imovelId, imageIndex) => {
                const imovel = UI.data.imoveis.find(x => x.id === imovelId);
                if(!imovel || !imovel.imagens || imovel.imagens.length === 0) return;
                
                UI.fullscreenImages = imovel.imagens;
                UI.fullscreenCurrentIndex = imageIndex;
                
                // Atualizar imagem atual
                document.getElementById('fullscreen-current-image').src = UI.fullscreenImages[UI.fullscreenCurrentIndex];
                
                // Atualizar contador
                document.getElementById('fullscreen-counter').textContent = UI.fullscreenCurrentIndex + 1;
                document.getElementById('fullscreen-total').textContent = UI.fullscreenImages.length;
                
                // Atualizar miniaturas
                const thumbnailsContainer = document.getElementById('fullscreen-thumbnails');
                thumbnailsContainer.innerHTML = '';
                
                UI.fullscreenImages.forEach((img, index) => {
                    const thumbnail = document.createElement('div');
                    thumbnail.className = `fullscreen-thumbnail ${index === UI.fullscreenCurrentIndex ? 'active' : ''}`;
                    thumbnail.onclick = () => UI.goToFullscreenImage(index);
                    
                    const thumbnailImg = document.createElement('img');
                    thumbnailImg.src = img;
                    thumbnail.appendChild(thumbnailImg);
                    
                    thumbnailsContainer.appendChild(thumbnail);
                });
                
                // Abrir visualizador
                document.getElementById('fullscreen-viewer').classList.add('active');
                
                // Adicionar listener para teclado
                document.addEventListener('keydown', UI.handleFullscreenKeyboard);
            },

            closeFullscreen: () => {
                document.getElementById('fullscreen-viewer').classList.remove('active');
                UI.fullscreenImages = [];
                UI.fullscreenCurrentIndex = 0;
                
                // Remover listener do teclado
                document.removeEventListener('keydown', UI.handleFullscreenKeyboard);
            },

            nextFullscreenImage: () => {
                if(UI.fullscreenImages.length <= 1) return;
                UI.fullscreenCurrentIndex = (UI.fullscreenCurrentIndex + 1) % UI.fullscreenImages.length;
                UI.updateFullscreenViewer();
            },

            prevFullscreenImage: () => {
                if(UI.fullscreenImages.length <= 1) return;
                UI.fullscreenCurrentIndex = (UI.fullscreenCurrentIndex - 1 + UI.fullscreenImages.length) % UI.fullscreenImages.length;
                UI.updateFullscreenViewer();
            },

            goToFullscreenImage: (index) => {
                UI.fullscreenCurrentIndex = index;
                UI.updateFullscreenViewer();
            },

            updateFullscreenViewer: () => {
                // Atualizar imagem
                document.getElementById('fullscreen-current-image').src = UI.fullscreenImages[UI.fullscreenCurrentIndex];
                
                // Atualizar contador
                document.getElementById('fullscreen-counter').textContent = UI.fullscreenCurrentIndex + 1;
                
                // Atualizar miniaturas ativas
                document.querySelectorAll('.fullscreen-thumbnail').forEach((thumb, index) => {
                    thumb.classList.toggle('active', index === UI.fullscreenCurrentIndex);
                });
            },

            handleFullscreenKeyboard: (e) => {
                if(!document.getElementById('fullscreen-viewer').classList.contains('active')) return;
                
                switch(e.key) {
                    case 'Escape':
                        UI.closeFullscreen();
                        break;
                    case 'ArrowLeft':
                        UI.prevFullscreenImage();
                        break;
                    case 'ArrowRight':
                        UI.nextFullscreenImage();
                        break;
                }
            },

            showClienteDetails: (id) => {
                const c = UI.data.clientes.find(x => x.id === id);
                if(!c) return;
                
                App.cliente.edit(id);
            },

            showVisitaDetails: (id) => {
                const v = UI.data.visitas.find(x => x.id === id);
                if(!v) return;
                
                App.agenda.edit(id);
            },

            renderAgenda: () => {
                const list = document.getElementById('agenda-list');
                const hoje = Utils.getToday();
                
                // Visitas futuras (a partir de hoje)
                const visitasFuturas = UI.data.visitas.filter(v => 
                    v.data >= hoje && v.status !== 'cancelado'
                ).sort((a,b) => {
                    if(a.data === b.data) return a.horario.localeCompare(b.horario);
                    return a.data.localeCompare(b.data);
                });
                
                if(visitasFuturas.length === 0) {
                    list.innerHTML = `<div class="empty-state"><i class="fas fa-calendar-alt"></i><p>Nenhuma visita agendada!</p></div>`;
                    return;
                }

                // Agrupar por data
                const visitasPorData = {};
                visitasFuturas.forEach(v => {
                    if(!visitasPorData[v.data]) visitasPorData[v.data] = [];
                    visitasPorData[v.data].push(v);
                });

                let html = '';
                Object.keys(visitasPorData).sort().forEach(data => {
                    const dataFormatada = Utils.formatDate(data);
                    const isToday = Utils.isToday(data);
                    
                    html += `<div class="section-title" style="margin-top: 20px;">${dataFormatada} ${isToday ? '<span class="badge badge-primary">HOJE</span>' : ''}</div>`;
                    
                    visitasPorData[data].forEach(v => {
                        html += UI.createVisitaCard(v);
                    });
                });
                
                list.innerHTML = html;
            },

            renderRelatorios: () => {
                const imoveis = UI.data.imoveis;
                const hoje = new Date();
                const mesAtual = hoje.getMonth();
                const anoAtual = hoje.getFullYear();
                
                // Imóveis vendidos/alugados este mês
                const transacoesMes = imoveis.filter(i => 
                    (i.status === 'vendido' || i.status === 'alugado') &&
                    i.dataVenda
                ).filter(i => {
                    const dataVenda = new Date(i.dataVenda);
                    return dataVenda.getMonth() === mesAtual && dataVenda.getFullYear() === anoAtual;
                });
                
                const totalVendas = transacoesMes.filter(i => i.status === 'vendido')
                    .reduce((acc, i) => acc + (i.precoVenda || 0), 0);
                
                const totalAlugueis = transacoesMes.filter(i => i.status === 'alugado')
                    .reduce((acc, i) => acc + (i.precoAluguel || 0), 0);
                
                // Configurações para cálculo de comissão
                const settings = Storage.getSettings();
                const taxaComissao = settings.comissao || 5;
                const comissaoVendas = (totalVendas * taxaComissao) / 100;
                const comissaoAlugueis = (totalAlugueis * taxaComissao) / 100;
                const comissaoTotal = comissaoVendas + comissaoAlugueis;
                
                // Taxa de conversão
                const imoveisDisponiveis = imoveis.filter(i => i.status === 'disponivel').length;
                const imoveisVendidosAlugados = imoveis.filter(i => i.status === 'vendido' || i.status === 'alugado').length;
                const totalImoveis = imoveis.length;
                const taxaConversao = totalImoveis > 0 ? ((imoveisVendidosAlugados / totalImoveis) * 100).toFixed(1) : 0;
                
                // Atualizar UI
                document.getElementById('rel-vendas-mes').innerText = Utils.formatCurrency(totalVendas);
                document.getElementById('rel-alugueis-mes').innerText = Utils.formatCurrency(totalAlugueis);
                document.getElementById('rel-comissao').innerText = Utils.formatCurrency(comissaoTotal);
                document.getElementById('rel-conversao').innerText = `${taxaConversao}%`;
                
                // Renderizar gráfico
                UI.renderChart();
            },

            renderChart: () => {
                const ctx = document.getElementById('performanceChart').getContext('2d');
                const imoveis = UI.data.imoveis;
                
                // Agrupar por mês
                const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
                const hoje = new Date();
                const anoAtual = hoje.getFullYear();
                
                const dadosVendas = new Array(12).fill(0);
                const dadosAlugueis = new Array(12).fill(0);
                
                imoveis.filter(i => i.dataVenda).forEach(i => {
                    const data = new Date(i.dataVenda);
                    if(data.getFullYear() === anoAtual) {
                        const mes = data.getMonth();
                        if(i.status === 'vendido') {
                            dadosVendas[mes] += (i.precoVenda || 0);
                        } else if(i.status === 'alugado') {
                            dadosAlugueis[mes] += (i.precoAluguel || 0);
                        }
                    }
                });
                
                if (UI.chartInstance) {
                    UI.chartInstance.destroy();
                }

                UI.chartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: meses,
                        datasets: [
                            {
                                label: 'Vendas',
                                data: dadosVendas,
                                backgroundColor: '#3b82f6',
                                borderRadius: 4,
                            },
                            {
                                label: 'Aluguéis',
                                data: dadosAlugueis,
                                backgroundColor: '#10b981',
                                borderRadius: 4,
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { 
                                display: true,
                                position: 'bottom',
                                labels: { boxWidth: 12, font: { size: 10 } }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) label += ': ';
                                        if (context.parsed.y !== null) {
                                            label += Utils.formatCurrency(context.parsed.y);
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { borderDash: [2, 4], color: '#e2e8f0' },
                                ticks: {
                                    callback: function(value) {
                                        if(value >= 1000000) return 'R$ ' + (value / 1000000).toFixed(1) + 'M';
                                        if(value >= 1000) return 'R$ ' + (value / 1000).toFixed(0) + 'k';
                                        return 'R$ ' + value;
                                    },
                                    font: { size: 10 }
                                }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { font: { size: 10 } }
                            }
                        }
                    }
                });
            },

            // --- MODALS ---
            openModal: (type) => {
                document.getElementById(`overlay-${type}`).classList.add('active');
                requestAnimationFrame(() => {
                    document.getElementById(`overlay-${type}`).classList.add('active');
                });
            },
            closeModals: () => {
                document.querySelectorAll('.modal-overlay').forEach(el => el.classList.remove('active'));
            },

            openNewCliente: (fromVisita = false) => {
                document.getElementById('form-cliente').reset();
                document.getElementById('c-id').value = '';
                document.getElementById('title-cliente').innerText = 'Novo Cliente';
                UI.openModal('cliente');
            },

            openNewImovel: () => {
                document.getElementById('form-imovel').reset();
                document.getElementById('i-id').value = '';
                document.getElementById('title-imovel').innerText = 'Novo Imóvel';
                
                // Reset image gallery
                const gallery = document.getElementById('image-gallery');
                gallery.innerHTML = `
                    <div class="image-gallery-item add-image-btn" onclick="document.getElementById('i-imagem-input').click()">
                        <i class="fas fa-plus"></i>
                        <span>Adicionar Foto</span>
                    </div>
                `;
                document.getElementById('image-counter').innerText = '0';
                document.getElementById('i-imagens-data').value = '';
                
                // Set today as default
                const hoje = Utils.getToday();
                
                UI.openModal('imovel');
            },

            openNewVisita: () => {
                const clienteSelect = document.getElementById('v-cliente');
                const imovelSelect = document.getElementById('v-imovel');
                
                // Popular clientes
                clienteSelect.innerHTML = '<option value="">Selecione...</option>';
                UI.data.clientes.forEach(c => {
                    clienteSelect.innerHTML += `<option value="${c.id}">${c.nome}</option>`;
                });
                
                // Popular imóveis
                imovelSelect.innerHTML = '<option value="">Selecione...</option>';
                UI.data.imoveis.filter(i => i.status === 'disponivel').forEach(i => {
                    imovelSelect.innerHTML += `<option value="${i.id}">${i.titulo.substring(0, 30)}...</option>`;
                });
                
                document.getElementById('form-visita').reset();
                document.getElementById('v-id').value = '';
                document.getElementById('title-visita').innerText = 'Agendar Visita';
                
                // Set default date and time
                document.getElementById('v-data').value = Utils.getToday();
                document.getElementById('v-horario').value = Utils.getTodayTime();
                
                UI.openModal('visita');
            },

            openNewVisitaFromImovel: (imovelId) => {
                UI.openNewVisita();
                setTimeout(() => {
                    document.getElementById('v-imovel').value = imovelId;
                    document.getElementById('v-tipo').value = 'visita';
                }, 100);
            },

            openSettings: () => {
                const s = Storage.getSettings();
                document.getElementById('s-nome').value = s.nome || '';
                document.getElementById('s-creci').value = s.creci || '';
                document.getElementById('s-telefone').value = s.telefone || '';
                document.getElementById('s-email').value = s.email || '';
                document.getElementById('s-imobiliaria').value = s.imobiliaria || '';
                document.getElementById('s-comissao').value = s.comissao || 5;
                
                UI.openModal('settings');
            }
        };

        // --- APP LOGIC ---
        const App = {
            cliente: {
                save: (e) => {
                    e.preventDefault();
                    const id = document.getElementById('c-id').value || Utils.id();
                    const nome = document.getElementById('c-nome').value;
                    const tipo = document.getElementById('c-tipo').value;
                    const telefone = document.getElementById('c-telefone').value;
                    const email = document.getElementById('c-email').value;
                    const faixaPreco = document.getElementById('c-faixa-preco').value;
                    const observacoes = document.getElementById('c-observacoes').value;

                    const newClient = { 
                        id, nome, tipo, telefone, email, 
                        faixaPreco, observacoes,
                        dataCriacao: new Date().toISOString()
                    };
                    
                    const existingIdx = UI.data.clientes.findIndex(c => c.id === id);
                    if(existingIdx >= 0) {
                        UI.data.clientes[existingIdx] = newClient;
                    } else {
                        UI.data.clientes.push(newClient);
                    }

                    Storage.set('clientes', UI.data.clientes);
                    Utils.toast('Cliente salvo!');
                    UI.closeModals();
                    UI.renderDashboard();
                    UI.renderClientes();
                },
                edit: (id) => {
                    const c = UI.data.clientes.find(x => x.id === id);
                    if(!c) return;
                    document.getElementById('c-id').value = c.id;
                    document.getElementById('c-nome').value = c.nome;
                    document.getElementById('c-tipo').value = c.tipo;
                    document.getElementById('c-telefone').value = c.telefone;
                    document.getElementById('c-email').value = c.email || '';
                    document.getElementById('c-faixa-preco').value = c.faixaPreco || '';
                    document.getElementById('c-observacoes').value = c.observacoes || '';
                    document.getElementById('title-cliente').innerText = 'Editar Cliente';
                    UI.openModal('cliente');
                },
                whatsapp: (id) => {
                    const c = UI.data.clientes.find(x => x.id === id);
                    if(!c || !c.telefone) {
                        Utils.toast('Cliente sem número de telefone', 'error');
                        return;
                    }
                    
                    const settings = Storage.getSettings();
                    const message = Utils.generateWhatsAppMessage(c, settings);
                    
                    Utils.openWhatsApp(c.telefone, message);
                    
                    Utils.toast(`Abrindo WhatsApp com ${c.nome.split(' ')[0]}`);
                }
            },

            imovel: {
                save: (e) => {
                    e.preventDefault();
                    const id = document.getElementById('i-id').value || Utils.id();
                    
                    const isNew = !document.getElementById('i-id').value;

                    // Obter imagens do input hidden
                    const imagensData = document.getElementById('i-imagens-data').value;
                    const imagens = imagensData ? JSON.parse(imagensData) : [];

                    const imovel = {
                        id,
                        titulo: document.getElementById('i-titulo').value,
                        tipo: document.getElementById('i-tipo').value,
                        transacao: document.getElementById('i-transacao').value,
                        precoVenda: Utils.parseCurrency(document.getElementById('i-preco-venda').value) || null,
                        precoAluguel: Utils.parseCurrency(document.getElementById('i-preco-aluguel').value) || null,
                        endereco: document.getElementById('i-endereco').value,
                        area: parseInt(document.getElementById('i-area').value) || null,
                        quartos: parseInt(document.getElementById('i-quartos').value) || null,
                        banheiros: parseInt(document.getElementById('i-banheiros').value) || null,
                        vagas: parseInt(document.getElementById('i-vagas').value) || null,
                        status: document.getElementById('i-status').value,
                        descricao: document.getElementById('i-descricao').value,
                        observacoes: document.getElementById('i-observacoes').value,
                        imagens: imagens,
                        dataCriacao: new Date().toISOString()
                    };

                    // Se o imóvel foi vendido/alugado agora, registrar data
                    if((imovel.status === 'vendido' || imovel.status === 'alugado') && isNew) {
                        imovel.dataVenda = new Date().toISOString().split('T')[0];
                    }

                    const idx = UI.data.imoveis.findIndex(i => i.id === id);
                    if(idx >= 0) {
                        // Mantém dataVenda se já existir
                        if(UI.data.imoveis[idx].dataVenda && !imovel.dataVenda) {
                            imovel.dataVenda = UI.data.imoveis[idx].dataVenda;
                        }
                        UI.data.imoveis[idx] = imovel;
                    }
                    else UI.data.imoveis.push(imovel);

                    Storage.set('imoveis', UI.data.imoveis);
                    Utils.toast('Imóvel salvo!');
                    UI.closeModals();
                    UI.renderDashboard();
                    UI.renderImoveis();
                    UI.renderRelatorios();
                },
                edit: (id) => {
                    const i = UI.data.imoveis.find(x => x.id === id);
                    if(!i) return;

                    document.getElementById('i-id').value = i.id;
                    document.getElementById('i-titulo').value = i.titulo;
                    document.getElementById('i-tipo').value = i.tipo;
                    document.getElementById('i-transacao').value = i.transacao;
                    
                    if(i.precoVenda) {
                        const valInput = document.getElementById('i-preco-venda');
                        valInput.value = (i.precoVenda * 100).toFixed(0);
                        Utils.maskMoney(valInput);
                    }
                    
                    if(i.precoAluguel) {
                        const valInput = document.getElementById('i-preco-aluguel');
                        valInput.value = (i.precoAluguel * 100).toFixed(0);
                        Utils.maskMoney(valInput);
                    }
                    
                    document.getElementById('i-endereco').value = i.endereco;
                    document.getElementById('i-area').value = i.area || '';
                    document.getElementById('i-quartos').value = i.quartos || '';
                    document.getElementById('i-banheiros').value = i.banheiros || '';
                    document.getElementById('i-vagas').value = i.vagas || '';
                    document.getElementById('i-status').value = i.status;
                    document.getElementById('i-descricao').value = i.descricao || '';
                    document.getElementById('i-observacoes').value = i.observacoes || '';
                    
                    // Image gallery handling
                    const gallery = document.getElementById('image-gallery');
                    if(i.imagens && i.imagens.length > 0) {
                        gallery.innerHTML = '';
                        i.imagens.forEach((img, index) => {
                            const galleryItem = document.createElement('div');
                            galleryItem.className = 'image-gallery-item';
                            galleryItem.innerHTML = `
                                <img src="${img}" class="image-gallery-img" onclick="UI.openFullscreen('${i.id}', ${index})">
                                <button type="button" class="remove-image-btn" onclick="App.imovel.removeGalleryImage(${index})">
                                    <i class="fas fa-times"></i>
                                </button>
                            `;
                            gallery.appendChild(galleryItem);
                        });
                        
                        // Adicionar botão para adicionar mais fotos
                        if(i.imagens.length < 15) {
                            const addButton = document.createElement('div');
                            addButton.className = 'image-gallery-item add-image-btn';
                            addButton.onclick = () => document.getElementById('i-imagem-input').click();
                            addButton.innerHTML = `
                                <i class="fas fa-plus"></i>
                                <span>Adicionar Foto</span>
                            `;
                            gallery.appendChild(addButton);
                        }
                        
                        document.getElementById('image-counter').innerText = i.imagens.length;
                        document.getElementById('i-imagens-data').value = JSON.stringify(i.imagens);
                    } else {
                        gallery.innerHTML = `
                            <div class="image-gallery-item add-image-btn" onclick="document.getElementById('i-imagem-input').click()">
                                <i class="fas fa-plus"></i>
                                <span>Adicionar Foto</span>
                            </div>
                        `;
                        document.getElementById('image-counter').innerText = '0';
                        document.getElementById('i-imagens-data').value = '';
                    }
                    
                    // Toggle aluguel fields
                    App.imovel.toggleAluguelFields();
                    
                    document.getElementById('title-imovel').innerText = `Editar Imóvel`;
                    UI.openModal('imovel');
                },
                handleMultipleImages: async (input) => {
                    if (!input.files || input.files.length === 0) return;
                    
                    const files = Array.from(input.files);
                    const currentImages = JSON.parse(document.getElementById('i-imagens-data').value || '[]');
                    const remainingSlots = 15 - currentImages.length;
                    
                    if(files.length > remainingSlots) {
                        Utils.toast(`Máximo de 15 fotos. Você pode adicionar mais ${remainingSlots} fotos.`, 'error');
                        return;
                    }
                    
                    try {
                        const gallery = document.getElementById('image-gallery');
                        const newImages = [...currentImages];
                        
                        // Remover botão "Adicionar Foto" temporariamente
                        const addButton = gallery.querySelector('.add-image-btn');
                        if(addButton) addButton.remove();
                        
                        for(const file of files.slice(0, remainingSlots)) {
                            const base64 = await Utils.readImage(file);
                            const compressedBase64 = await Utils.compressImage(base64, 0.7, 1200);
                            newImages.push(compressedBase64);
                            
                            const galleryItem = document.createElement('div');
                            galleryItem.className = 'image-gallery-item';
                            galleryItem.innerHTML = `
                                <img src="${compressedBase64}" class="image-gallery-img" onclick="UI.openFullscreen('${document.getElementById('i-id').value || 'new'}', ${newImages.length - 1})">
                                <button type="button" class="remove-image-btn" onclick="App.imovel.removeGalleryImage(${newImages.length - 1})">
                                    <i class="fas fa-times"></i>
                                </button>
                            `;
                            gallery.appendChild(galleryItem);
                        }
                        
                        // Adicionar botão "Adicionar Foto" novamente se ainda houver espaço
                        if(newImages.length < 15) {
                            const addButton = document.createElement('div');
                            addButton.className = 'image-gallery-item add-image-btn';
                            addButton.onclick = () => document.getElementById('i-imagem-input').click();
                            addButton.innerHTML = `
                                <i class="fas fa-plus"></i>
                                <span>Adicionar Foto</span>
                            `;
                            gallery.appendChild(addButton);
                        }
                        
                        // Atualizar dados
                        document.getElementById('i-imagens-data').value = JSON.stringify(newImages);
                        document.getElementById('image-counter').innerText = newImages.length;
                        
                        // Limpar input file
                        input.value = '';
                        
                        Utils.toast(`${files.length} foto(s) adicionada(s)!`);
                    } catch (e) {
                        console.error('Erro ao processar imagens:', e);
                        Utils.toast('Erro ao carregar imagens', 'error');
                    }
                },
                removeGalleryImage: (index) => {
                    const currentImages = JSON.parse(document.getElementById('i-imagens-data').value || '[]');
                    if(index >= 0 && index < currentImages.length) {
                        currentImages.splice(index, 1);
                        
                        // Atualizar galeria
                        const gallery = document.getElementById('image-gallery');
                        gallery.innerHTML = '';
                        
                        // Adicionar imagens restantes
                        currentImages.forEach((img, idx) => {
                            const galleryItem = document.createElement('div');
                            galleryItem.className = 'image-gallery-item';
                            galleryItem.innerHTML = `
                                <img src="${img}" class="image-gallery-img" onclick="UI.openFullscreen('${document.getElementById('i-id').value || 'new'}', ${idx})">
                                <button type="button" class="remove-image-btn" onclick="App.imovel.removeGalleryImage(${idx})">
                                    <i class="fas fa-times"></i>
                                </button>
                            `;
                            gallery.appendChild(galleryItem);
                        });
                        
                        // Sempre adicionar botão "Adicionar Foto" se houver menos de 15 imagens
                        if(currentImages.length < 15) {
                            const addButton = document.createElement('div');
                            addButton.className = 'image-gallery-item add-image-btn';
                            addButton.onclick = () => document.getElementById('i-imagem-input').click();
                            addButton.innerHTML = `
                                <i class="fas fa-plus"></i>
                                <span>Adicionar Foto</span>
                            `;
                            gallery.appendChild(addButton);
                        }
                        
                        // Atualizar dados
                        document.getElementById('i-imagens-data').value = JSON.stringify(currentImages);
                        document.getElementById('image-counter').innerText = currentImages.length;
                        
                        Utils.toast('Foto removida!');
                    }
                },
                toggleAluguelFields: () => {
                    const transacao = document.getElementById('i-transacao').value;
                    const aluguelGroup = document.getElementById('i-aluguel-group');
                    
                    if(transacao === 'aluguel' || transacao === 'ambos') {
                        aluguelGroup.style.display = 'block';
                        document.getElementById('i-preco-aluguel').required = true;
                    } else {
                        aluguelGroup.style.display = 'none';
                        document.getElementById('i-preco-aluguel').required = false;
                    }
                },
                delete: (id) => {
                    if(confirm('Excluir este imóvel?')) {
                        UI.data.imoveis = UI.data.imoveis.filter(i => i.id !== id);
                        Storage.set('imoveis', UI.data.imoveis);
                        UI.renderDashboard();
                        UI.renderImoveis();
                        UI.renderRelatorios();
                        Utils.toast('Imóvel excluído!', 'success');
                    }
                }
            },

            agenda: {
                save: (e) => {
                    e.preventDefault();
                    const id = document.getElementById('v-id').value || Utils.id();
                    
                    const visita = {
                        id,
                        tipo: document.getElementById('v-tipo').value,
                        clienteId: document.getElementById('v-cliente').value,
                        imovelId: document.getElementById('v-imovel').value || null,
                        data: document.getElementById('v-data').value,
                        horario: document.getElementById('v-horario').value,
                        local: document.getElementById('v-local').value,
                        observacoes: document.getElementById('v-observacoes').value,
                        status: document.getElementById('v-status').value,
                        dataCriacao: new Date().toISOString()
                    };

                    const idx = UI.data.visitas.findIndex(v => v.id === id);
                    if(idx >= 0) UI.data.visitas[idx] = visita;
                    else UI.data.visitas.push(visita);

                    Storage.set('visitas', UI.data.visitas);
                    Utils.toast('Visita agendada!');
                    UI.closeModals();
                    UI.renderDashboard();
                    UI.renderAgenda();
                },
                edit: (id) => {
                    const v = UI.data.visitas.find(x => x.id === id);
                    if(!v) return;
                    
                    // Popular selects
                    const clienteSelect = document.getElementById('v-cliente');
                    const imovelSelect = document.getElementById('v-imovel');
                    
                    clienteSelect.innerHTML = '<option value="">Selecione...</option>';
                    UI.data.clientes.forEach(c => {
                        clienteSelect.innerHTML += `<option value="${c.id}">${c.nome}</option>`;
                    });
                    
                    imovelSelect.innerHTML = '<option value="">Selecione...</option>';
                    UI.data.imoveis.forEach(i => {
                        imovelSelect.innerHTML += `<option value="${i.id}">${i.titulo.substring(0, 30)}...</option>`;
                    });
                    
                    document.getElementById('v-id').value = v.id;
                    document.getElementById('v-tipo').value = v.tipo;
                    document.getElementById('v-cliente').value = v.clienteId;
                    document.getElementById('v-imovel').value = v.imovelId || '';
                    document.getElementById('v-data').value = v.data;
                    document.getElementById('v-horario').value = v.horario;
                    document.getElementById('v-local').value = v.local || '';
                    document.getElementById('v-observacoes').value = v.observacoes || '';
                    document.getElementById('v-status').value = v.status;
                    
                    document.getElementById('title-visita').innerText = 'Editar Visita';
                    UI.openModal('visita');
                },
                delete: (id) => {
                    if(confirm('Excluir este agendamento?')) {
                        UI.data.visitas = UI.data.visitas.filter(v => v.id !== id);
                        Storage.set('visitas', UI.data.visitas);
                        UI.renderDashboard();
                        UI.renderAgenda();
                        Utils.toast('Agendamento excluído!', 'success');
                    }
                }
            },

            settings: {
                save: (e) => {
                    e.preventDefault();
                    const s = Storage.getSettings();
                    s.nome = document.getElementById('s-nome').value;
                    s.creci = document.getElementById('s-creci').value;
                    s.telefone = document.getElementById('s-telefone').value;
                    s.email = document.getElementById('s-email').value;
                    s.imobiliaria = document.getElementById('s-imobiliaria').value;
                    s.comissao = parseFloat(document.getElementById('s-comissao').value) || 5;
                    
                    Storage.saveSettings(s);
                    Utils.toast('Configurações salvas');
                    UI.closeModals();
                }
            },

            whatsapp: {
                shareImovel: (id) => {
                    const i = UI.data.imoveis.find(x => x.id === id);
                    if(!i) return;
                    
                    const settings = Storage.getSettings();
                    let msg = `🏠 *${i.titulo}*\n\n`;
                    msg += `📍 ${i.endereco}\n\n`;
                    
                    if(i.precoVenda) {
                        msg += `💰 *Venda:* ${Utils.formatCurrency(i.precoVenda)}\n`;
                    }
                    if(i.precoAluguel) {
                        msg += `🏠 *Aluguel:* ${Utils.formatCurrency(i.precoAluguel)}/mês\n`;
                    }
                    
                    msg += `\n📐 ${i.area || '---'}m² | 🛏️ ${i.quartos || 0} quartos | 🚿 ${i.banheiros || 0} banheiros | 🚗 ${i.vagas || 0} vagas\n\n`;
                    msg += `📞 Entre em contato: ${settings.telefone}\n`;
                    msg += `👨‍💼 ${settings.nome} | CRECI ${settings.creci}\n`;
                    msg += `🏢 ${settings.imobiliaria}`;
                    
                    const encodedMsg = encodeURIComponent(msg);
                    window.open(`https://wa.me/?text=${encodedMsg}`, '_blank');
                }
            },

            backup: {
                exportData: () => {
                    const data = {
                        clientes: UI.data.clientes,
                        imoveis: UI.data.imoveis,
                        visitas: UI.data.visitas,
                        settings: Storage.getSettings()
                    };
                    const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `backup_imobipro_${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    Utils.toast('Backup exportado!');
                },
                importTrigger: () => document.getElementById('import-file').click(),
                importData: (input) => {
                    const file = input.files[0];
                    if(!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if(data.clientes) Storage.set('clientes', data.clientes);
                            if(data.imoveis) Storage.set('imoveis', data.imoveis);
                            if(data.visitas) Storage.set('visitas', data.visitas);
                            if(data.settings) Storage.saveSettings(data.settings);
                            location.reload();
                        } catch(err) {
                            Utils.toast('Erro no arquivo de backup', 'error');
                        }
                    };
                    reader.readAsText(file);
                },
                clearData: () => {
                    if(confirm('Tem certeza? Isso apagará TODOS os dados!')) {
                        localStorage.clear();
                        location.reload();
                    }
                }
            }
        };

        // Event listeners
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if(e.target === overlay) UI.closeModals();
            });
        });

        // Listener para mostrar/ocultar campo de aluguel
        document.getElementById('i-transacao').addEventListener('change', function() {
            App.imovel.toggleAluguelFields();
        });

        // Listener para fechar fullscreen com clique no overlay
        document.getElementById('fullscreen-viewer').addEventListener('click', function(e) {
            if(e.target === this) {
                UI.closeFullscreen();
            }
        });

        document.addEventListener('DOMContentLoaded', UI.init);
    </script>
</body>
</html>
