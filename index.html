
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ImobiPro - Gestão Imobiliária</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* ESTILOS COMPLETOS (manter todos os estilos originais) */
        :root {
            /* Cores Imobiliárias */
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #64748b;
            --accent: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #0f172a;
            --light: #f8fafc;
            --surface: #ffffff;
            --border: #e2e8f0;
            --property-sale: #3b82f6;
            --property-rent: #10b981;
            --property-featured: #f59e0b;
            
            /* Cores para tipos de agendamento */
            --type-visita: #3b82f6;
            --type-reuniao-construtor: #8b5cf6;
            --type-reuniao-equipe: #0ea5e9;
            --type-documentacao: #10b981;
            --type-plantao: #7c3aed;
            --type-generico: #f59e0b;
            --type-outro: #64748b;
            
            /* Cores para funil de vendas */
            --funnel-lead: #93c5fd;
            --funnel-contato: #60a5fa;
            --funnel-cpf: #3b82f6;
            --funnel-sem-restricao: #1d4ed8;
            --funnel-documentacao: #7c3aed;
            --funnel-aprovado: #10b981;
            --funnel-contrato: #059669;
            --funnel-venda: #047857;
            
            /* Dimensões */
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
            --header-height: calc(60px + var(--safe-top));
            --nav-height: calc(65px + var(--safe-bottom));
            --radius-lg: 16px;
            --radius-md: 12px;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-float: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
            color: var(--dark);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            user-select: none;
        }

        /* --- Header --- */
        header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: var(--safe-top) 16px 10px;
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 50;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            box-shadow: var(--shadow-sm);
        }

        .brand {
            font-size: 1.25rem;
            font-weight: 800;
            color: var(--dark);
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .brand span { color: var(--primary); }
        
        .header-actions { display: flex; gap: 12px; }
        .icon-btn {
            background: none; border: none; font-size: 1.2rem;
            color: var(--secondary); padding: 8px;
            border-radius: 50%; transition: 0.2s;
        }
        .icon-btn:active { background: #f1f5f9; color: var(--primary); transform: scale(0.95); }

        /* --- Main Content --- */
        main {
            flex: 1;
            overflow-y: auto;
            padding: calc(var(--header-height) + 16px) 16px calc(var(--nav-height) + 80px);
            scroll-behavior: smooth;
        }

        .view { display: none; animation: fadeIn 0.3s ease; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Stats Cards --- */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--surface);
            padding: 16px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            display: flex;
            flex-direction: column;
            gap: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .stat-card:active { transform: scale(0.98); box-shadow: var(--shadow-sm); }

        .stat-icon {
            width: 32px; height: 32px;
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.9rem;
        }
        .stat-value { font-size: 1.5rem; font-weight: 700; color: var(--dark); line-height: 1; }
        .stat-label { font-size: 0.8rem; color: var(--secondary); font-weight: 500; }

        /* Chart */
        .chart-container {
            background: var(--surface);
            border-radius: var(--radius-md);
            padding: 16px;
            box-shadow: var(--shadow-sm);
            margin-bottom: 24px;
            height: 300px;
            position: relative;
        }

        /* Colors */
        .bg-blue { background: #dbeafe; color: var(--primary); }
        .bg-green { background: #d1fae5; color: var(--success); }
        .bg-orange { background: #ffedd5; color: var(--warning); }
        .bg-red { background: #fee2e2; color: var(--danger); }
        .bg-purple { background: #f3e8ff; color: #8b5cf6; }
        .bg-cyan { background: #cffafe; color: #06b6d4; }
        .bg-teal { background: #ccfbf1; color: #0d9488; }
        .bg-pink { background: #fce7f3; color: #db2777; }

        /* --- Section Titles --- */
        .section-title {
            font-size: 1.1rem; font-weight: 700; margin-bottom: 12px;
            display: flex; justify-content: space-between; align-items: center;
        }

        /* --- Search --- */
        .search-container {
            position: relative; margin-bottom: 16px;
        }
        .search-input {
            width: 100%; padding: 12px 12px 12px 40px;
            border: 1px solid var(--border); border-radius: var(--radius-md);
            background: var(--surface); font-size: 1rem; outline: none;
            -webkit-appearance: none;
        }
        .search-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .search-icon {
            position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
            color: var(--secondary);
        }

        /* --- Property Card --- */
        .property-card {
            background: var(--surface);
            border-radius: var(--radius-md);
            margin-bottom: 16px;
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
            border-left: 4px solid transparent;
            transition: transform 0.2s;
            cursor: pointer;
        }
        .property-card:active { transform: scale(0.98); }

        .property-image {
            width: 100%; height: 180px;
            object-fit: cover;
            background: #e2e8f0;
            display: flex; align-items: center; justify-content: center;
            color: var(--secondary);
            position: relative;
        }

        .property-badge {
            position: absolute; top: 12px; left: 12px;
            padding: 4px 10px; border-radius: 20px;
            font-size: 0.7rem; font-weight: 700;
            z-index: 2;
        }
        .badge-sale { background: var(--property-sale); color: white; }
        .badge-rent { background: var(--property-rent); color: white; }
        .badge-featured { background: var(--property-featured); color: white; }

        .property-content { padding: 16px; }
        .property-title { 
            font-weight: 700; font-size: 1rem; color: var(--dark);
            margin-bottom: 4px; line-height: 1.3;
        }
        .property-address { 
            font-size: 0.85rem; color: var(--secondary); 
            margin-bottom: 8px; display: flex; align-items: center; gap: 4px;
        }
        .property-features {
            display: flex; gap: 12px; margin-bottom: 12px;
        }
        .feature {
            display: flex; flex-direction: column; align-items: center;
            font-size: 0.75rem; color: var(--secondary);
        }
        .feature i { font-size: 1rem; margin-bottom: 2px; color: var(--primary); }
        
        .property-price {
            font-size: 1.3rem; font-weight: 800; color: var(--primary);
            margin-bottom: 8px;
        }
        .property-price .period { font-size: 0.9rem; color: var(--secondary); }

        .property-actions {
            display: flex; gap: 8px; margin-top: 12px;
            padding-top: 12px; border-top: 1px solid var(--border);
        }
        .btn-sm {
            flex: 1; padding: 8px; border-radius: 8px;
            border: none; font-size: 0.85rem; font-weight: 600;
            display: flex; align-items: center; justify-content: center; gap: 6px;
            cursor: pointer;
        }
        .btn-light { background: #f1f5f9; color: var(--secondary); }
        .btn-primary-soft { background: #dbeafe; color: var(--primary); }
        .btn-whatsapp { background: #dcfce7; color: #16a34a; }
        .btn-cyan { background: #cffafe; color: #0e7490; }

        /* --- Client Card --- */
        .client-card {
            background: var(--surface);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: transform 0.2s;
            position: relative;
        }
        .client-card:active { transform: scale(0.98); }

        .client-header {
            display: flex; justify-content: space-between; align-items: flex-start;
            margin-bottom: 12px;
        }
        .client-name { font-weight: 700; font-size: 1rem; color: var(--dark); }
        .client-type {
            font-size: 0.7rem; padding: 3px 8px; border-radius: 99px;
            font-weight: 600;
        }
        .type-buyer { background: #dbeafe; color: var(--primary); }
        .type-seller { background: #f3e8ff; color: var(--accent); }
        .type-both { background: #fef3c7; color: #b45309; }

        .client-info {
            display: flex; flex-direction: column; gap: 6px;
        }
        .client-row {
            display: flex; align-items: center; gap: 8px;
            font-size: 0.85rem; color: var(--secondary);
        }

        .client-actions {
            display: flex; gap: 8px; margin-top: 12px;
            padding-top: 12px; border-top: 1px solid var(--border);
        }

        .btn-whatsapp-client {
            background: #25D366;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: transform 0.2s;
            flex: 1;
            justify-content: center;
        }
        
        .btn-whatsapp-client:active {
            transform: scale(0.95);
        }

        /* --- Schedule Card --- */
        .schedule-card {
            background: var(--surface);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-sm);
            border-left: 4px solid var(--type-visita);
            cursor: pointer;
            transition: transform 0.2s;
        }
        .schedule-card:active { transform: scale(0.98); }
        
        .schedule-card.visita { border-left-color: var(--type-visita); }
        .schedule-card.reuniao-construtor { border-left-color: var(--type-reuniao-construtor); }
        .schedule-card.reuniao-equipe { border-left-color: var(--type-reuniao-equipe); }
        .schedule-card.documentacao { border-left-color: var(--type-documentacao); }
        .schedule-card.plantao { border-left-color: var(--type-plantao); }
        .schedule-card.generico { border-left-color: var(--type-generico); }
        .schedule-card.outro { border-left-color: var(--type-outro); }

        .schedule-header {
            display: flex; justify-content: space-between; margin-bottom: 8px;
        }
        .schedule-type { 
            font-size: 0.75rem; padding: 3px 8px; border-radius: 4px;
            font-weight: 600; background: var(--type-visita); color: white;
        }
        .schedule-type.visita { background: var(--type-visita); }
        .schedule-type.reuniao-construtor { background: var(--type-reuniao-construtor); }
        .schedule-type.reuniao-equipe { background: var(--type-reuniao-equipe); }
        .schedule-type.documentacao { background: var(--type-documentacao); }
        .schedule-type.plantao { background: var(--type-plantao); }
        .schedule-type.generico { background: var(--type-generico); }
        .schedule-type.outro { background: var(--type-outro); }
        
        .schedule-urgent { background: #fee2e2; color: var(--danger); }
        
        .schedule-time {
            font-size: 0.85rem; color: var(--secondary);
            display: flex; align-items: center; gap: 6px;
            margin-bottom: 8px;
        }
        .schedule-title { font-weight: 600; color: var(--dark); margin-bottom: 4px; }
        .schedule-notes { font-size: 0.85rem; color: var(--secondary); line-height: 1.4; }

        /* --- Bottom Navigation --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            height: var(--nav-height);
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid var(--border);
            display: flex; justify-content: space-around;
            padding-bottom: var(--safe-bottom);
            z-index: 50;
        }

        .nav-item {
            flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            color: #94a3b8; text-decoration: none;
            font-size: 0.7rem; font-weight: 500;
            gap: 4px; transition: 0.2s;
        }
        .nav-item i { font-size: 1.25rem; margin-bottom: 2px; }
        .nav-item.active { color: var(--primary); }

        /* --- Floating Action Button --- */
        .fab {
            position: fixed;
            bottom: calc(var(--nav-height) + 16px);
            right: 16px;
            width: 56px; height: 56px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem;
            box-shadow: var(--shadow-float);
            z-index: 40;
            border: none;
            transition: transform 0.2s;
        }
        .fab:active { transform: scale(0.9) rotate(90deg); }

        /* --- Modals --- */
        .modal-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            z-index: 100;
            display: none; opacity: 0;
            transition: opacity 0.3s;
        }
        .modal-overlay.active { display: flex; opacity: 1; }

        .modal-sheet {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--surface);
            border-radius: 20px 20px 0 0;
            padding: 24px 16px calc(24px + var(--safe-bottom));
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            max-height: 90vh;
            overflow-y: auto;
            z-index: 101;
        }
        .modal-overlay.active + .modal-sheet { transform: translateY(0); }

        .sheet-handle {
            width: 40px; height: 4px; background: #cbd5e1;
            border-radius: 2px; margin: 0 auto 20px;
        }

        /* --- Forms --- */
        .form-group { margin-bottom: 16px; }
        .form-label { 
            display: block; font-size: 0.9rem; font-weight: 600; 
            margin-bottom: 6px; color: var(--dark); 
        }
        .form-control {
            width: 100%; padding: 14px;
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 1rem;
            background: #f8fafc;
            -webkit-appearance: none;
        }
        .form-control:focus { background: white; border-color: var(--primary); outline: none; }
        textarea.form-control { min-height: 100px; resize: none; }
        select.form-control { color: var(--dark); }

        .form-row {
            display: flex; gap: 12px;
        }
        .form-row .form-group { flex: 1; }

        .btn-block {
            width: 100%; padding: 16px;
            border: none; border-radius: 12px;
            font-size: 1rem; font-weight: 700;
            background: var(--primary); color: white;
            margin-top: 10px;
        }

        /* --- Property Details --- */
        .details-card {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-md);
        }
        
        .details-header {
            display: flex; justify-content: space-between;
            align-items: flex-start; margin-bottom: 20px;
            padding-bottom: 15px; border-bottom: 1px solid var(--border);
        }
        
        .details-title {
            font-size: 1.3rem; font-weight: 800;
            color: var(--dark);
        }
        
        .details-price {
            font-size: 1.5rem; font-weight: 800;
            color: var(--primary);
        }
        
        .details-section {
            margin-bottom: 20px;
        }
        
        .details-section-title {
            font-size: 0.9rem; font-weight: 700;
            color: var(--primary); text-transform: uppercase;
            letter-spacing: 0.5px; margin-bottom: 8px;
            display: flex; align-items: center; gap: 8px;
        }
        
        .details-info-grid {
            display: grid; grid-template-columns: repeat(2, 1fr);
            gap: 12px; margin-bottom: 16px;
        }
        
        .info-item {
            display: flex; flex-direction: column; gap: 4px;
        }
        
        .info-label {
            font-size: 0.8rem; color: var(--secondary);
            font-weight: 500;
        }
        
        .info-value {
            font-size: 1rem; color: var(--dark);
            font-weight: 600;
        }
        
        .details-actions {
            display: flex; gap: 12px; margin-top: 24px;
            padding-top: 20px; border-top: 1px solid var(--border);
        }
        
        .btn-details {
            flex: 1; padding: 12px; border-radius: 10px;
            border: none; font-weight: 600;
            display: flex; align-items: center;
            justify-content: center; gap: 8px;
            cursor: pointer; transition: transform 0.2s;
        }
        
        .btn-details:active { transform: scale(0.95); }
        
        .btn-details-primary {
            background: var(--primary); color: white;
        }
        
        .btn-details-whatsapp {
            background: #25D366; color: white;
        }
        
        .btn-details-secondary {
            background: var(--light); color: var(--secondary);
        }

        /* --- Image Gallery --- */
        .image-gallery {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }

        .image-gallery-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            height: 120px;
            background: #f1f5f9;
            cursor: pointer;
        }

        .image-gallery-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s;
        }

        .image-gallery-item:hover .image-gallery-img {
            transform: scale(1.05);
        }

        .remove-image-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            cursor: pointer;
            z-index: 2;
        }

        .add-image-btn {
            border: 2px dashed var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-image-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .add-image-btn i {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .image-counter {
            font-size: 0.7rem;
            color: var(--secondary);
            margin-bottom: 8px;
        }

        /* --- Utility --- */
        .empty-state { 
            text-align: center; padding: 40px 20px; 
            color: var(--secondary); 
        }
        .empty-state i { font-size: 3rem; margin-bottom: 16px; opacity: 0.3; }
        
        .toast {
            position: fixed; top: var(--header-height); left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: var(--dark); color: white;
            padding: 12px 24px; border-radius: 50px;
            font-size: 0.9rem; font-weight: 500;
            box-shadow: var(--shadow-float); z-index: 200;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; align-items: center; gap: 8px;
            white-space: nowrap;
        }
        .toast.show { transform: translateX(-50%) translateY(20px); }

        .badge {
            display: inline-block; padding: 2px 8px;
            border-radius: 10px; font-size: 0.7rem;
            font-weight: 700;
        }
        
        .badge-primary { background: var(--primary); color: white; }
        .badge-success { background: var(--success); color: white; }
        .badge-warning { background: var(--warning); color: white; }
        .badge-danger { background: var(--danger); color: white; }
        .badge-purple { background: #7c3aed; color: white; }
        .badge-cyan { background: #0ea5e9; color: white; }
        .badge-teal { background: #0d9488; color: white; }
        .badge-pink { background: #db2777; color: white; }
        
        @keyframes pulse { 
            0% { opacity: 1; } 
            50% { opacity: 0.6; } 
            100% { opacity: 1; } 
        }
        
        .highlight { color: var(--primary); font-weight: 700; }

        /* --- Carousel --- */
        .carousel-container {
            position: relative;
            width: 100%;
            height: 250px;
            margin-bottom: 20px;
            border-radius: 12px;
            overflow: hidden;
        }

        .carousel-slide {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .carousel-slide:hover {
            transform: scale(1.02);
        }

        .carousel-slide.active {
            display: block;
        }

        .carousel-nav {
            position: absolute;
            bottom: 15px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 8px;
        }

        .carousel-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: background 0.3s;
        }

        .carousel-dot.active {
            background: white;
        }

        .carousel-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1rem;
            z-index: 1;
            transition: background 0.3s;
        }

        .carousel-arrow:hover {
            background: rgba(0, 0, 0, 0.7);
        }

        .carousel-arrow.prev {
            left: 10px;
        }

        .carousel-arrow.next {
            right: 10px;
        }

        /* --- PDF Button --- */
        .btn-pdf {
            background: #ef4444;
            color: white;
        }

        .btn-pdf:hover {
            background: #dc2626;
        }

        /* --- Image Fullscreen Viewer --- */
        .fullscreen-viewer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .fullscreen-viewer.active {
            display: flex;
            opacity: 1;
        }

        .fullscreen-image-container {
            width: 100%;
            height: 80vh;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .fullscreen-image {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 4px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            animation: zoomIn 0.3s ease;
        }

        @keyframes zoomIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .fullscreen-nav {
            position: absolute;
            top: 50%;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            transform: translateY(-50%);
            pointer-events: none;
        }

        .fullscreen-nav button {
            pointer-events: auto;
            background: rgba(0, 0, 0, 0.5);
            border: none;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: background 0.3s;
        }

        .fullscreen-nav button:hover {
            background: rgba(0, 0, 0, 0.8);
        }

        .fullscreen-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.5);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 1001;
            transition: background 0.3s;
        }

        .fullscreen-close:hover {
            background: rgba(0, 0, 0, 0.8);
        }

        .fullscreen-counter {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            text-align: center;
            color: white;
            font-size: 1rem;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 16px;
            border-radius: 20px;
            display: inline-block;
            width: fit-content;
            margin: 0 auto;
        }

        .fullscreen-thumbnails {
            display: flex;
            gap: 10px;
            padding: 15px;
            overflow-x: auto;
            max-width: 90%;
            margin-top: 10px;
        }

        .fullscreen-thumbnail {
            width: 60px;
            height: 60px;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.3s, transform 0.3s;
            flex-shrink: 0;
            border: 2px solid transparent;
        }

        .fullscreen-thumbnail:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }

        .fullscreen-thumbnail.active {
            opacity: 1;
            border-color: var(--primary);
            transform: scale(1.05);
        }

        .fullscreen-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* WhatsApp quick action */
        .whatsapp-quick {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #25D366;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 2;
            transition: transform 0.2s;
        }

        .whatsapp-quick:hover {
            transform: scale(1.1);
        }

        /* --- Plantão specific styles --- */
        .plantoes-info {
            background: #f3e8ff;
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
            border-left: 3px solid #7c3aed;
        }

        .plantoes-summary {
            font-size: 0.85rem;
            color: #5b21b6;
            margin-bottom: 8px;
        }

        .client-item {
            background: white;
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 6px;
            border: 1px solid #e2e8f0;
        }

        .client-name {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .client-situation {
            font-size: 0.8rem;
            color: #64748b;
        }

        .plantoes-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 12px;
        }

        .plantoes-stat {
            background: white;
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }

        .plantoes-stat-value {
            font-weight: 700;
            color: #7c3aed;
            font-size: 1.2rem;
        }

        .plantoes-stat-label {
            font-size: 0.7rem;
            color: #64748b;
        }

        /* --- Agenda Filters --- */
        .agenda-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
            overflow-x: auto;
            padding-bottom: 8px;
        }

        .filter-chip {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            border: 1px solid var(--border);
            background: white;
            color: var(--secondary);
        }

        .filter-chip.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .filter-chip.visita { border-color: var(--type-visita); color: var(--type-visita); }
        .filter-chip.reuniao-construtor { border-color: var(--type-reuniao-construtor); color: var(--type-reuniao-construtor); }
        .filter-chip.reuniao-equipe { border-color: var(--type-reuniao-equipe); color: var(--type-reuniao-equipe); }
        .filter-chip.documentacao { border-color: var(--type-documentacao); color: var(--type-documentacao); }
        .filter-chip.plantao { border-color: var(--type-plantao); color: var(--type-plantao); }
        .filter-chip.generico { border-color: var(--type-generico); color: var(--type-generico); }
        .filter-chip.outro { border-color: var(--type-outro); color: var(--type-outro); }

        .filter-chip.active.visita { background: var(--type-visita); color: white; }
        .filter-chip.active.reuniao-construtor { background: var(--type-reuniao-construtor); color: white; }
        .filter-chip.active.reuniao-equipe { background: var(--type-reuniao-equipe); color: white; }
        .filter-chip.active.documentacao { background: var(--type-documentacao); color: white; }
        .filter-chip.active.plantao { background: var(--type-plantao); color: white; }
        .filter-chip.active.generico { background: var(--type-generico); color: white; }
        .filter-chip.active.outro { background: var(--type-outro); color: white; }

        /* --- Birthday Alert --- */
        .birthday-alert {
            background: linear-gradient(135deg, #fce7f3, #fbcfe8);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 16px;
            border-left: 4px solid #db2777;
            animation: pulse 2s infinite;
        }

        .birthday-alert-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .birthday-alert-title {
            font-weight: 700;
            color: #9d174d;
            font-size: 1rem;
        }

        .birthday-alert-content {
            font-size: 0.85rem;
            color: #831843;
            line-height: 1.4;
        }

        /* --- Photo Fullscreen Fix --- */
        .image-fullscreen {
            width: 100vw;
            height: 100vh;
            object-fit: contain;
            background: #000;
        }

        /* --- Warning Note --- */
        .warning-note {
            font-size: 0.75rem;
            color: var(--warning);
            font-style: italic;
            margin-top: 8px;
            text-align: center;
            padding: 8px;
            background: #fef3c7;
            border-radius: 6px;
            border: 1px solid #fde68a;
        }

        /* --- FUNIL DE VENDAS --- */
        .funnel-container {
            background: var(--surface);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-sm);
            overflow: hidden;
        }

        .funnel-stages {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .funnel-stage {
            position: relative;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: var(--shadow-sm);
        }

        .funnel-stage:hover {
            transform: translateX(5px);
            box-shadow: var(--shadow-md);
        }

        .funnel-stage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .funnel-stage-title {
            font-weight: 700;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .funnel-stage-count {
            background: rgba(255, 255, 255, 0.9);
            color: var(--dark);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 700;
            min-width: 30px;
            text-align: center;
        }

        .funnel-stage-clients {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .funnel-stage.expanded .funnel-stage-clients {
            max-height: 500px;
            margin-top: 12px;
        }

        .funnel-client-item {
            background: rgba(241, 245, 249, 0.7);
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            transition: background 0.2s;
        }

        .funnel-client-item:hover {
            background: rgba(226, 232, 240, 0.9);
        }

        .funnel-client-name {
            font-weight: 600;
            color: var(--dark);
        }

        .funnel-client-days {
            font-size: 0.75rem;
            color: var(--secondary);
        }

        .funnel-chart-container {
            height: 400px;
            position: relative;
            margin: 20px 0;
        }

        /* Cores do funil */
        .stage-lead { border-left-color: var(--funnel-lead); background: linear-gradient(90deg, rgba(147, 197, 253, 0.1) 0%, rgba(147, 197, 253, 0.05) 100%); }
        .stage-contato { border-left-color: var(--funnel-contato); background: linear-gradient(90deg, rgba(96, 165, 250, 0.1) 0%, rgba(96, 165, 250, 0.05) 100%); }
        .stage-cpf { border-left-color: var(--funnel-cpf); background: linear-gradient(90deg, rgba(59, 130, 246, 0.1) 0%, rgba(59, 130, 246, 0.05) 100%); }
        .stage-sem-restricao { border-left-color: var(--funnel-sem-restricao); background: linear-gradient(90deg, rgba(29, 78, 216, 0.1) 0%, rgba(29, 78, 216, 0.05) 100%); }
        .stage-documentacao { border-left-color: var(--funnel-documentacao); background: linear-gradient(90deg, rgba(124, 58, 237, 0.1) 0%, rgba(124, 58, 237, 0.05) 100%); }
        .stage-aprovado { border-left-color: var(--funnel-aprovado); background: linear-gradient(90deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%); }
        .stage-contrato { border-left-color: var(--funnel-contrato); background: linear-gradient(90deg, rgba(5, 150, 105, 0.1) 0%, rgba(5, 150, 105, 0.05) 100%); }
        .stage-venda { border-left-color: var(--funnel-venda); background: linear-gradient(90deg, rgba(4, 120, 87, 0.1) 0%, rgba(4, 120, 87, 0.05) 100%); }

        /* --- LINKS ÚTEIS --- */
        .links-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .link-card {
            background: var(--surface);
            border-radius: var(--radius-md);
            padding: 16px;
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: transform 0.2s;
            border-left: 4px solid var(--primary);
            display: flex;
            flex-direction: column;
            gap: 8px;
            text-decoration: none;
            color: inherit;
        }

        .link-card:active { transform: scale(0.98); }

        .link-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: var(--light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .link-title {
            font-weight: 700;
            font-size: 0.9rem;
            color: var(--dark);
            line-height: 1.3;
        }

        .link-url {
            font-size: 0.75rem;
            color: var(--secondary);
            word-break: break-all;
            opacity: 0.8;
        }

        .link-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        /* --- Badges para funil --- */
        .badge-lead { background: var(--funnel-lead); color: #1e3a8a; }
        .badge-contato { background: var(--funnel-contato); color: white; }
        .badge-cpf { background: var(--funnel-cpf); color: white; }
        .badge-sem-restricao { background: var(--funnel-sem-restricao); color: white; }
        .badge-documentacao { background: var(--funnel-documentacao); color: white; }
        .badge-aprovado { background: var(--funnel-aprovado); color: white; }
        .badge-contrato { background: var(--funnel-contrato); color: white; }
        .badge-venda { background: var(--funnel-venda); color: white; }

        /* --- Progress Bar --- */
        .progress-container {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 8px 0;
        }

        .progress-bar {
            height: 100%;
            background: var(--primary);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        /* --- Drag and Drop --- */
        .dragging {
            opacity: 0.5;
            border: 2px dashed var(--primary);
        }

        .drop-zone {
            background: rgba(37, 99, 235, 0.05);
            border: 2px dashed var(--primary);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            color: var(--primary);
            margin: 8px 0;
            transition: all 0.3s;
        }

        .drop-zone:hover {
            background: rgba(37, 99, 235, 0.1);
        }
    </style>
</head>
<body>

    <header>
        <div class="brand">
            <i class="fas fa-home" style="color: var(--primary);"></i>
            <span>Imobi</span>Pro
        </div>
        <div class="header-actions">
            <button class="icon-btn" onclick="App.backup.exportData()"><i class="fas fa-cloud-download-alt"></i></button>
            <button class="icon-btn" onclick="UI.openSettings()"><i class="fas fa-cog"></i></button>
        </div>
    </header>

    <div id="toast" class="toast">
        <i class="fas fa-check-circle"></i> <span>Ação realizada!</span>
    </div>

    <!-- Image Fullscreen Viewer -->
    <div class="fullscreen-viewer" id="fullscreen-viewer">
        <button class="fullscreen-close" onclick="UI.closeFullscreen()">
            <i class="fas fa-times"></i>
        </button>
        
        <div class="fullscreen-image-container">
            <img id="fullscreen-current-image" class="fullscreen-image" src="" alt="Imagem em tela cheia">
            
            <div class="fullscreen-nav">
                <button onclick="UI.prevFullscreenImage()">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button onclick="UI.nextFullscreenImage()">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
        
        <div class="fullscreen-counter">
            <span id="fullscreen-counter">1</span> / <span id="fullscreen-total">1</span>
        </div>
        
        <div class="fullscreen-thumbnails" id="fullscreen-thumbnails">
            <!-- Thumbnails will be added here -->
        </div>
    </div>

    <main>
        <!-- Dashboard View -->
        <div id="dashboard-view" class="view active">
            <div class="section-title">Visão Geral</div>
            <div class="stats-grid">
                <div class="stat-card" onclick="UI.navigate('imoveis')">
                    <div class="stat-icon bg-blue"><i class="fas fa-building"></i></div>
                    <div class="stat-value" id="dash-total-imoveis">0</div>
                    <div class="stat-label">Imóveis</div>
                </div>
                <div class="stat-card" onclick="UI.navigate('clientes')">
                    <div class="stat-icon bg-green"><i class="fas fa-users"></i></div>
                    <div class="stat-value" id="dash-total-clientes">0</div>
                    <div class="stat-label">Clientes</div>
                </div>
                <div class="stat-card" onclick="UI.navigate('agenda')">
                    <div class="stat-icon bg-orange"><i class="fas fa-calendar-alt"></i></div>
                    <div class="stat-value" id="dash-visitas">0</div>
                    <div class="stat-label">Visitas Hoje</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-red"><i class="fas fa-chart-line"></i></div>
                    <div class="stat-value" id="dash-vendas">R$ 0</div>
                    <div class="stat-label">Vendas Mês</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-cyan"><i class="fas fa-handshake"></i></div>
                    <div class="stat-value" id="dash-negociacoes">0</div>
                    <div class="stat-label">Negociações</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-purple"><i class="fas fa-star"></i></div>
                    <div class="stat-value" id="dash-destaques">0</div>
                    <div class="stat-label">Destaques</div>
                </div>
            </div>

            <!-- Aniversariantes do Dia -->
            <div class="section-title">
                Aniversariantes Hoje
                <span class="badge badge-pink" id="aniversariantes-badge" style="display:none">!</span>
            </div>
            <div id="aniversariantes-list">
                <!-- Lista de aniversariantes será preenchida aqui -->
            </div>

            <div class="section-title">
                Próximas Visitas
                <span class="badge badge-primary" id="visitas-badge" style="display:none">!</span>
            </div>
            <div id="visitas-list">
                <!-- Lista de visitas será preenchida aqui -->
            </div>
            
            <div class="section-title">
                Negociações Recentes
                <span class="badge badge-warning" id="negociacoes-badge" style="display:none">!</span>
            </div>
            <div id="negociacoes-list">
                <!-- Lista de negociações será preenchida aqui -->
            </div>
        </div>

        <!-- Imóveis View -->
        <div id="imoveis-view" class="view">
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" placeholder="Buscar imóveis..." oninput="UI.renderImoveis(this.value)">
            </div>
            <div class="form-row" style="margin-bottom: 16px;">
                <select class="form-control" onchange="UI.filterImoveis(this.value, document.getElementById('filter-status').value)">
                    <option value="">Todos os tipos</option>
                    <option value="apartamento">Apartamento</option>
                    <option value="casa">Casa</option>
                    <option value="terreno">Terreno</option>
                    <option value="comercial">Comercial</option>
                </select>
                <select class="form-control" id="filter-status" onchange="UI.filterImoveis(document.querySelector('select').value, this.value)">
                    <option value="">Todos os status</option>
                    <option value="disponivel">Disponível</option>
                    <option value="vendido">Vendido</option>
                    <option value="alugado">Alugado</option>
                    <option value="reservado">Reservado</option>
                </select>
            </div>
            <div id="imoveis-list"></div>
        </div>

        <!-- Clientes View -->
        <div id="clientes-view" class="view">
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" placeholder="Buscar clientes..." oninput="UI.renderClientes(this.value)">
            </div>
            <div id="clientes-list"></div>
        </div>

        <!-- Agenda View -->
        <div id="agenda-view" class="view">
            <div class="section-title">
                Agenda
                <button class="icon-btn" style="background: var(--primary); color: white; border-radius: 8px;" onclick="UI.openNewVisita()">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            
            <!-- Filtros de Tipo -->
            <div class="agenda-filters" id="agenda-filters">
                <div class="filter-chip active" data-type="todos" onclick="UI.filterAgenda('todos')">Todos</div>
                <div class="filter-chip visita" data-type="visita" onclick="UI.filterAgenda('visita')">Visitas</div>
                <div class="filter-chip reuniao-construtor" data-type="reuniao-construtor" onclick="UI.filterAgenda('reuniao-construtor')">Reunião Construtor</div>
                <div class="filter-chip reuniao-equipe" data-type="reuniao-equipe" onclick="UI.filterAgenda('reuniao-equipe')">Reunião Equipe</div>
                <div class="filter-chip documentacao" data-type="documentacao" onclick="UI.filterAgenda('documentacao')">Documentação</div>
                <div class="filter-chip plantao" data-type="plantao" onclick="UI.filterAgenda('plantao')">Plantões</div>
                <div class="filter-chip generico" data-type="generico" onclick="UI.filterAgenda('generico')">Genéricos</div>
                <div class="filter-chip outro" data-type="outro" onclick="UI.filterAgenda('outro')">Outros</div>
            </div>
            
            <div id="agenda-list"></div>
        </div>

        <!-- Funil de Vendas View -->
        <div id="funil-view" class="view">
            <div class="section-title">
                Funil de Vendas
                <button class="icon-btn" style="background: var(--primary); color: white; border-radius: 8px;" onclick="UI.openFunilSettings()">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
            
            <!-- Estatísticas do Funil -->
            <div class="stats-grid">
                <div class="stat-card" onclick="UI.filterFunil('lead')">
                    <div class="stat-icon" style="background: var(--funnel-lead); color: #1e3a8a;">
                        <i class="fas fa-user-plus"></i>
                    </div>
                    <div class="stat-value" id="funil-lead">0</div>
                    <div class="stat-label">Leads</div>
                </div>
                <div class="stat-card" onclick="UI.filterFunil('venda')">
                    <div class="stat-icon" style="background: var(--funnel-venda); color: white;">
                        <i class="fas fa-trophy"></i>
                    </div>
                    <div class="stat-value" id="funil-venda">0</div>
                    <div class="stat-label">Vendas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-purple">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="stat-value" id="funil-taxa">0%</div>
                    <div class="stat-label">Conversão</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-cyan">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-value" id="funil-tempo">0d</div>
                    <div class="stat-label">Tempo Médio</div>
                </div>
            </div>
            
            <!-- Progresso do Funil -->
            <div class="funnel-container">
                <div class="section-title" style="margin-bottom: 16px;">
                    Progresso do Funil
                    <span class="badge badge-primary" id="funil-total">0 clientes</span>
                </div>
                <div id="funil-stages-container">
                    <!-- Estágios do funil serão renderizados aqui -->
                </div>
            </div>
            
            <!-- Clientes no Funil -->
            <div class="section-title">
                Clientes no Funil
                <select class="form-control" style="width: auto; padding: 4px 12px; font-size: 0.85rem;" onchange="UI.filterClientesFunil(this.value)">
                    <option value="todos">Todos os estágios</option>
                    <!-- Opções serão preenchidas dinamicamente -->
                </select>
            </div>
            <div id="funil-clientes-list"></div>
        </div>

        <!-- Links Úteis View -->
        <div id="links-view" class="view">
            <div class="section-title">
                Links Úteis
                <button class="icon-btn" style="background: var(--primary); color: white; border-radius: 8px;" onclick="UI.openNewLink()">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" placeholder="Buscar links..." oninput="UI.renderLinks(this.value)">
            </div>
            
            <div class="links-grid" id="links-grid">
                <!-- Links serão renderizados aqui -->
            </div>
        </div>

        <!-- Relatórios View -->
        <div id="relatorios-view" class="view">
            <div class="section-title">Desempenho Mensal</div>
            <div class="chart-container">
                <canvas id="performanceChart"></canvas>
            </div>

            <div class="section-title">Resumo Financeiro</div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon bg-green"><i class="fas fa-money-bill-wave"></i></div>
                    <div class="stat-value" id="rel-vendas-mes">R$ 0</div>
                    <div class="stat-label">Vendas Mês</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-blue"><i class="fas fa-hand-holding-usd"></i></div>
                    <div class="stat-value" id="rel-alugueis-mes">R$ 0</div>
                    <div class="stat-label">Aluguéis Mês</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-orange"><i class="fas fa-chart-pie"></i></div>
                    <div class="stat-value" id="rel-comissao">R$ 0</div>
                    <div class="stat-label">Comissão</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-purple"><i class="fas fa-bullseye"></i></div>
                    <div class="stat-value" id="rel-conversao">0%</div>
                    <div class="stat-label">Conversão</div>
                </div>
            </div>

            <!-- Nova seção para Relatório de Agendamentos -->
            <div class="section-title">
                Relatório de Agendamentos
                <button class="icon-btn" style="background: #7c3aed; color: white; border-radius: 8px;" onclick="UI.generateAgendaReport()">
                    <i class="fas fa-file-pdf"></i>
                </button>
            </div>
            <div class="chart-container">
                <canvas id="agendaChart"></canvas>
            </div>
            <div id="agenda-report">
                <!-- Relatório de agendamentos será preenchido aqui -->
            </div>
        </div>
    </main>

    <button class="fab" onclick="UI.openNewImovel()" id="main-fab">
        <i class="fas fa-plus"></i>
    </button>

    <nav class="bottom-nav">
        <a href="#" class="nav-item active" data-target="dashboard-view" onclick="UI.switchTab(this)">
            <i class="fas fa-home"></i> <span>Início</span>
        </a>
        <a href="#" class="nav-item" data-target="imoveis-view" onclick="UI.switchTab(this)">
            <i class="fas fa-building"></i> <span>Imóveis</span>
        </a>
        <a href="#" class="nav-item" data-target="clientes-view" onclick="UI.switchTab(this)">
            <i class="fas fa-users"></i> <span>Clientes</span>
        </a>
        <a href="#" class="nav-item" data-target="funil-view" onclick="UI.switchTab(this)">
            <i class="fas fa-filter"></i> <span>Funil</span>
        </a>
        <a href="#" class="nav-item" data-target="agenda-view" onclick="UI.switchTab(this)">
            <i class="fas fa-calendar-alt"></i> <span>Agenda</span>
        </a>
        <a href="#" class="nav-item" data-target="links-view" onclick="UI.switchTab(this)">
            <i class="fas fa-link"></i> <span>Links</span>
        </a>
        <a href="#" class="nav-item" data-target="relatorios-view" onclick="UI.switchTab(this)">
            <i class="fas fa-chart-bar"></i> <span>Relatórios</span>
        </a>
    </nav>

    <!-- Modal de Detalhes do Imóvel -->
    <div class="modal-overlay" id="overlay-imovel-details"></div>
    <div class="modal-sheet" id="sheet-imovel-details">
        <div class="sheet-handle"></div>
        <div id="imovel-details-content">
            <!-- Conteúdo será preenchido dinamicamente -->
        </div>
    </div>

    <!-- Modal de Cliente -->
    <div class="modal-overlay" id="overlay-cliente"></div>
    <div class="modal-sheet" id="sheet-cliente">
        <div class="sheet-handle"></div>
        <h3 class="section-title" id="title-cliente">Novo Cliente</h3>
        <form id="form-cliente" onsubmit="App.cliente.save(event)">
            <input type="hidden" id="c-id">
            <div class="form-group">
                <label class="form-label">Nome Completo</label>
                <input type="text" id="c-nome" class="form-control" required>
            </div>
            <div class="form-group">
                <label class="form-label">Tipo de Cliente</label>
                <select id="c-tipo" class="form-control" required>
                    <option value="comprador">Comprador</option>
                    <option value="vendedor">Vendedor</option>
                    <option value="ambos">Comprador/Vendedor</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Etapa no Funil</label>
                <select id="c-etapa-funil" class="form-control" required>
                    <!-- Opções serão preenchidas dinamicamente -->
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Telefone (WhatsApp)</label>
                <input type="tel" id="c-telefone" class="form-control" placeholder="(00) 00000-0000" required oninput="Utils.maskPhone(this)">
            </div>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" id="c-email" class="form-control">
            </div>
            <div class="form-group">
                <label class="form-label">Imóvel de Interesse</label>
                <select id="c-imovel-interesse" class="form-control">
                    <option value="">Selecione um imóvel...</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Data de Nascimento</label>
                <input type="date" id="c-data-nascimento" class="form-control">
            </div>
            <div class="form-group">
                <label class="form-label">Faixa de Preço (Interesse)</label>
                <input type="text" id="c-faixa-preco" class="form-control" placeholder="Ex: R$ 300.000 - 500.000">
            </div>
            <div class="form-group">
                <label class="form-label">Observações</label>
                <textarea id="c-observacoes" class="form-control" placeholder="Anotações sobre o cliente..."></textarea>
            </div>
            <button type="submit" class="btn-block">Salvar Cliente</button>
            <button type="button" class="btn-block" style="background: var(--light); color: var(--secondary); margin-top: 8px;" onclick="UI.closeModals()">Cancelar</button>
        </form>
    </div>

    <!-- Modal de Imóvel -->
    <div class="modal-overlay" id="overlay-imovel"></div>
    <div class="modal-sheet" id="sheet-imovel">
        <div class="sheet-handle"></div>
        <h3 class="section-title" id="title-imovel">Novo Imóvel</h3>
        <form id="form-imovel" onsubmit="App.imovel.save(event)">
            <input type="hidden" id="i-id">
            
            <!-- Galeria de Imagens -->
            <div class="form-group">
                <label class="form-label">Fotos do Imóvel (Máx. 15)</label>
                <div class="image-counter">Fotos adicionadas: <span id="image-counter">0</span>/15</div>
                <div class="image-gallery" id="image-gallery">
                    <div class="image-gallery-item add-image-btn" onclick="document.getElementById('i-imagem-input').click()">
                        <i class="fas fa-plus"></i>
                        <span>Adicionar Foto</span>
                    </div>
                </div>
                <input type="file" id="i-imagem-input" accept="image/*" multiple style="display: none;" onchange="App.imovel.handleMultipleImages(this)">
                <input type="hidden" id="i-imagens-data">
            </div>

            <div class="form-group">
                <label class="form-label">Título do Anúncio</label>
                <input type="text" id="i-titulo" class="form-control" placeholder="Ex: Apartamento 3 quartos com vista..." required>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Tipo</label>
                    <select id="i-tipo" class="form-control" required>
                        <option value="apartamento">Apartamento</option>
                        <option value="casa">Casa</option>
                        <option value="terreno">Terreno</option>
                        <option value="comercial">Comercial</option>
                        <option value="kitnet">Kitnet</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Transação</label>
                    <select id="i-transacao" class="form-control" required onchange="App.imovel.toggleAluguelFields()">
                        <option value="venda">Venda</option>
                        <option value="aluguel">Aluguel</option>
                        <option value="ambos">Venda/Aluguel</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Preço de Venda (R$)</label>
                    <input type="text" id="i-preco-venda" class="form-control" placeholder="0,00" oninput="Utils.maskMoney(this)">
                </div>
                <div class="form-group" id="i-aluguel-group" style="display: none;">
                    <label class="form-label">Preço de Aluguel (R$)</label>
                    <input type="text" id="i-preco-aluguel" class="form-control" placeholder="0,00" oninput="Utils.maskMoney(this)">
                </div>
            </div>

            <!-- NOVOS CAMPOS ADICIONADOS -->
            <div class="form-group">
                <label class="form-label">Data de Entrega</label>
                <input type="date" id="i-data-entrega" class="form-control">
            </div>

            <div class="form-group">
                <label class="form-label">Construtora</label>
                <input type="text" id="i-construtora" class="form-control" placeholder="Nome da construtora">
            </div>

            <div class="form-group">
                <label class="form-label">Forma de Pagamento</label>
                <input type="text" id="i-forma-pagamento" class="form-control" placeholder="Ex: Financiamento, entrada + parcelas, etc.">
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Valor do Condomínio (R$)</label>
                    <input type="text" id="i-condominio" class="form-control" placeholder="0,00" oninput="Utils.maskMoney(this)">
                </div>
                <div class="form-group">
                    <label class="form-label">Gás Encanado</label>
                    <select id="i-gas-encanado" class="form-control">
                        <option value="sim">Sim</option>
                        <option value="nao">Não</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Endereço Completo</label>
                <input type="text" id="i-endereco" class="form-control" placeholder="Rua, número, bairro, cidade" required>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Área (m²)</label>
                    <input type="number" id="i-area" class="form-control" placeholder="Ex: 120">
                </div>
                <div class="form-group">
                    <label class="form-label">Quartos</label>
                    <input type="number" id="i-quartos" class="form-control" placeholder="Ex: 3">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Banheiros</label>
                    <input type="number" id="i-banheiros" class="form-control" placeholder="Ex: 2">
                </div>
                <div class="form-group">
                    <label class="form-label">Vagas</label>
                    <input type="number" id="i-vagas" class="form-control" placeholder="Ex: 2">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Status</label>
                <select id="i-status" class="form-control">
                    <option value="disponivel">Disponível</option>
                    <option value="reservado">Reservado</option>
                    <option value="vendido">Vendido</option>
                    <option value="alugado">Alugado</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Descrição</label>
                <textarea id="i-descricao" class="form-control" placeholder="Descreva o imóvel, comodidades, localização..."></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Observações Internas</label>
                <textarea id="i-observacoes" class="form-control" placeholder="Informações privadas sobre o imóvel..."></textarea>
            </div>

            <div class="warning-note">
                <i class="fas fa-exclamation-triangle"></i> Os valores informados podem sofrer alteração sem aviso prévio.
            </div>

            <button type="submit" class="btn-block">Salvar Imóvel</button>
            <button type="button" class="btn-block" style="background: var(--light); color: var(--secondary); margin-top: 8px;" onclick="UI.closeModals()">Cancelar</button>
        </form>
    </div>

    <!-- Modal de Visita/Agenda -->
    <div class="modal-overlay" id="overlay-visita"></div>
    <div class="modal-sheet" id="sheet-visita">
        <div class="sheet-handle"></div>
        <h3 class="section-title" id="title-visita">Novo Agendamento</h3>
        <form id="form-visita" onsubmit="App.agenda.save(event)">
            <input type="hidden" id="v-id">
            
            <div class="form-group">
                <label class="form-label">Tipo de Agendamento</label>
                <select id="v-tipo" class="form-control" required onchange="UI.toggleVisitaFields()">
                    <option value="visita">Visita ao Imóvel</option>
                    <option value="reuniao-construtor">Reunião com Construtor</option>
                    <option value="reuniao-equipe">Reunião de Equipe</option>
                    <option value="documentacao">Assinatura de Documentos</option>
                    <option value="plantao">Plantão</option>
                    <option value="generico">Agendamento Genérico</option>
                    <option value="outro">Outro</option>
                </select>
            </div>

            <!-- Campos para tipos que precisam de cliente -->
            <div class="form-group cliente-dependent-group">
                <label class="form-label">Cliente</label>
                <select id="v-cliente" class="form-control">
                    <option value="">Selecione...</option>
                </select>
            </div>

            <!-- Campos para tipos que precisam de imóvel -->
            <div class="form-group imovel-dependent-group">
                <label class="form-label">Imóvel</label>
                <select id="v-imovel" class="form-control">
                    <option value="">Selecione...</option>
                </select>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Data</label>
                    <input type="date" id="v-data" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Horário</label>
                    <input type="time" id="v-horario" class="form-control" required>
                </div>
            </div>

            <!-- Campos específicos para cada tipo -->
            <div class="tipo-specific-group" id="grupo-visita">
                <div class="form-group">
                    <label class="form-label">Local/Endereço da Visita</label>
                    <input type="text" id="v-local-visita" class="form-control" placeholder="Endereço da visita">
                </div>
            </div>

            <div class="tipo-specific-group" id="grupo-reuniao-construtor" style="display: none;">
                <div class="form-group">
                    <label class="form-label">Nome do Construtor/Incorporadora</label>
                    <input type="text" id="v-construtor-nome" class="form-control" placeholder="Nome da construtora">
                </div>
                <div class="form-group">
                    <label class="form-label">Empreendimento/Lançamento</label>
                    <input type="text" id="v-construtor-empreendimento" class="form-control" placeholder="Nome do empreendimento">
                </div>
                <div class="form-group">
                    <label class="form-label">Assuntos da Reunião</label>
                    <textarea id="v-construtor-assuntos" class="form-control" placeholder="Ex: Lançamentos, condições comerciais, parcerias..."></textarea>
                </div>
            </div>

            <div class="tipo-specific-group" id="grupo-reuniao-equipe" style="display: none;">
                <div class="form-group">
                    <label class="form-label">Tipo de Reunião</label>
                    <select id="v-equipe-tipo" class="form-control">
                        <option value="estrategia">Reunião Estratégica</option>
                        <option value="metas">Definição de Metas</option>
                        <option value="resultados">Análise de Resultados</option>
                        <option value="treinamento">Treinamento</option>
                        <option value="outro">Outro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Participantes</label>
                    <input type="text" id="v-equipe-participantes" class="form-control" placeholder="Nomes dos participantes">
                </div>
                <div class="form-group">
                    <label class="form-label">Pauta/Assuntos</label>
                    <textarea id="v-equipe-assuntos" class="form-control" placeholder="Tópicos da reunião..."></textarea>
                </div>
            </div>

            <div class="tipo-specific-group" id="grupo-documentacao" style="display: none;">
                <div class="form-group">
                    <label class="form-label">Tipo de Documento</label>
                    <select id="v-documentacao-tipo" class="form-control">
                        <option value="contrato-venda">Contrato de Venda</option>
                        <option value="contrato-aluguel">Contrato de Aluguel</option>
                        <option value="proposta">Proposta</option>
                        <option value="financiamento">Documentos de Financiamento</option>
                        <option value="outro">Outro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Local da Assinatura</label>
                    <input type="text" id="v-documentacao-local" class="form-control" placeholder="Local da assinatura">
                </div>
            </div>

            <div class="tipo-specific-group" id="grupo-plantao" style="display: none;">
                <div class="form-group">
                    <label class="form-label">Local do Plantão</label>
                    <input type="text" id="v-plantao-local" class="form-control" placeholder="Endereço do plantão">
                </div>
                <div class="form-group">
                    <label class="form-label">Detalhes do Plantão</label>
                    <textarea id="v-detalhes-plantoes" class="form-control" placeholder="Descreva as atividades do plantão..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Clientes Atendidos</label>
                    <textarea id="v-clientes-atendidos" class="form-control" placeholder="Liste os clientes atendidos, telefones e situações (separados por linha)">
Exemplo:
João Silva - (11) 99999-9999 - Interessado em apartamento 2 quartos
Maria Santos - (11) 88888-8888 - Agendou visita para amanhã
Pedro Costa - (11) 77777-7777 - Solicitou proposta de financiamento</textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Negócios Gerados</label>
                    <input type="text" id="v-negocios-gerados" class="form-control" placeholder="Ex: 2 visitas agendadas, 1 proposta enviada">
                </div>
            </div>

            <div class="tipo-specific-group" id="grupo-generico" style="display: none;">
                <div class="form-group">
                    <label class="form-label">Título do Agendamento</label>
                    <input type="text" id="v-generico-titulo" class="form-control" placeholder="Título descritivo">
                </div>
                <div class="form-group">
                    <label class="form-label">Local</label>
                    <input type="text" id="v-generico-local" class="form-control" placeholder="Local do compromisso">
                </div>
                <div class="form-group">
                    <label class="form-label">Descrição Detalhada</label>
                    <textarea id="v-generico-descricao" class="form-control" placeholder="Descreva o propósito deste agendamento..."></textarea>
                </div>
            </div>

            <div class="tipo-specific-group" id="grupo-outro" style="display: none;">
                <div class="form-group">
                    <label class="form-label">Descrição do Compromisso</label>
                    <input type="text" id="v-outro-descricao" class="form-control" placeholder="Descreva brevemente">
                </div>
                <div class="form-group">
                    <label class="form-label">Detalhes</label>
                    <textarea id="v-outro-detalhes" class="form-control" placeholder="Informações adicionais..."></textarea>
                </div>
            </div>

            <!-- Observações gerais (para todos os tipos) -->
            <div class="form-group">
                <label class="form-label">Observações Gerais</label>
                <textarea id="v-observacoes" class="form-control" placeholder="Observações adicionais..."></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Status</label>
                <select id="v-status" class="form-control">
                    <option value="agendado">Agendado</option>
                    <option value="confirmado">Confirmado</option>
                    <option value="realizado">Realizado</option>
                    <option value="cancelado">Cancelado</option>
                </select>
            </div>

            <button type="submit" class="btn-block">Salvar Agendamento</button>
            <button type="button" class="btn-block" style="background: var(--light); color: var(--secondary); margin-top: 8px;" onclick="UI.closeModals()">Cancelar</button>
        </form>
    </div>

    <!-- Modal de Configurações -->
    <div class="modal-overlay" id="overlay-settings"></div>
    <div class="modal-sheet" id="sheet-settings">
        <div class="sheet-handle"></div>
        <h3 class="section-title">Configurações</h3>
        <form id="form-settings" onsubmit="App.settings.save(event)">
            
            <div class="form-group">
                <label class="form-label">Nome do Corretor</label>
                <input type="text" id="s-nome" class="form-control" placeholder="Seu nome completo">
            </div>
            <div class="form-group">
                <label class="form-label">CRECI</label>
                <input type="text" id="s-creci" class="form-control" placeholder="Número do CRECI">
            </div>
            <div class="form-group">
                <label class="form-label">Telefone</label>
                <input type="tel" id="s-telefone" class="form-control" oninput="Utils.maskPhone(this)">
            </div>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" id="s-email" class="form-control">
            </div>
            <div class="form-group">
                <label class="form-label">Imobiliária</label>
                <input type="text" id="s-imobiliaria" class="form-control" placeholder="Nome da imobiliária">
            </div>
            <div class="form-group">
                <label class="form-label">Taxa de Comissão (%)</label>
                    <input type="number" id="s-comissao" class="form-control" placeholder="5" min="0" max="100" step="0.1">
            </div>

            <hr style="border: 0; border-top: 1px solid var(--border); margin: 16px 0;">
            <button type="button" class="btn-block" style="background: var(--danger);" onclick="App.backup.clearData()">
                <i class="fas fa-trash"></i> Resetar Tudo
            </button>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button type="button" class="btn-block" style="background: var(--secondary); margin: 0;" onclick="App.backup.importTrigger()">Importar Backup</button>
                <input type="file" id="import-file" style="display: none;" accept=".json" onchange="App.backup.importData(this)">
                <button type="submit" class="btn-block" style="background: var(--primary); margin: 0;">Salvar Configurações</button>
            </div>
        </form>
    </div>

    <!-- Modal de Configurações do Funil -->
    <div class="modal-overlay" id="overlay-funil-settings"></div>
    <div class="modal-sheet" id="sheet-funil-settings">
        <div class="sheet-handle"></div>
        <h3 class="section-title">Configurar Etapas do Funil</h3>
        <div id="funil-etapas-list">
            <!-- Etapas serão renderizadas dinamicamente -->
        </div>
        <button class="btn-block" style="background: var(--success); margin-top: 16px;" onclick="UI.addEtapaFunil()">
            <i class="fas fa-plus"></i> Adicionar Etapa
        </button>
        <button class="btn-block" style="background: var(--light); color: var(--secondary); margin-top: 8px;" onclick="UI.closeModals()">Fechar</button>
    </div>

    <!-- Modal de Link Útil -->
    <div class="modal-overlay" id="overlay-link"></div>
    <div class="modal-sheet" id="sheet-link">
        <div class="sheet-handle"></div>
        <h3 class="section-title" id="title-link">Novo Link Útil</h3>
        <form id="form-link" onsubmit="App.link.save(event)">
            <input type="hidden" id="l-id">
            <div class="form-group">
                <label class="form-label">Título</label>
                <input type="text" id="l-titulo" class="form-control" placeholder="Ex: Site da Construtora..." required>
            </div>
            <div class="form-group">
                <label class="form-label">URL</label>
                <input type="url" id="l-url" class="form-control" placeholder="https://exemplo.com" required>
            </div>
            <div class="form-group">
                <label class="form-label">Categoria</label>
                <select id="l-categoria" class="form-control">
                    <option value="construtora">Construtora</option>
                    <option value="documentos">Documentos</option>
                    <option value="financiamento">Financiamento</option>
                    <option value="noticias">Notícias</option>
                    <option value="ferramentas">Ferramentas</option>
                    <option value="outros">Outros</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Descrição</label>
                <textarea id="l-descricao" class="form-control" placeholder="Descrição do link..."></textarea>
            </div>
            <button type="submit" class="btn-block">Salvar Link</button>
            <button type="button" class="btn-block" style="background: var(--light); color: var(--secondary); margin-top: 8px;" onclick="UI.closeModals()">Cancelar</button>
        </form>
    </div>

    <script>
        // --- UTILITÁRIOS ---
        const Utils = {
            id: () => Date.now().toString(36) + Math.random().toString(36).substr(2),
            formatCurrency: (val) => val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }),
            parseCurrency: (str) => parseFloat(str.replace('R$', '').replace('.', '').replace(',', '.').trim()) || 0,
            formatDate: (dateStr) => {
                if(!dateStr) return '-';
                const [y, m, d] = dateStr.split('-');
                return `${d}/${m}/${y}`;
            },
            formatDateTime: (dateStr, timeStr) => {
                if(!dateStr) return '-';
                const date = new Date(`${dateStr}T${timeStr || '00:00'}`);
                return date.toLocaleDateString('pt-BR') + ' ' + date.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
            },
            maskPhone: (input) => {
                let v = input.value.replace(/\D/g, "");
                v = v.replace(/^(\d{2})(\d)/g, "($1) $2");
                v = v.replace(/(\d)(\d{4})$/, "$1-$2");
                input.value = v.substring(0, 15);
            },
            formatPhone: (phone) => {
                if(!phone) return '';
                const nums = phone.replace(/\D/g, "");
                if(nums.length === 10) {
                    return `(${nums.substring(0,2)}) ${nums.substring(2,6)}-${nums.substring(6)}`;
                } else if(nums.length === 11) {
                    return `(${nums.substring(0,2)}) ${nums.substring(2,7)}-${nums.substring(7)}`;
                }
                return phone;
            },
            maskMoney: (input) => {
                let v = input.value.replace(/\D/g, "");
                v = (v / 100).toFixed(2) + "";
                v = v.replace(".", ",");
                v = v.replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
                input.value = v;
            },
            toast: (msg, type = 'success') => {
                const t = document.getElementById('toast');
                t.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> <span>${msg}</span>`;
                t.style.background = type === 'success' ? 'var(--dark)' : 'var(--danger)';
                t.classList.add('show');
                setTimeout(() => t.classList.remove('show'), 3000);
            },
            readImage: (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            },
            compressImage: (base64, quality = 0.7, maxWidth = 1200) => {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.src = base64;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.onerror = () => resolve(base64);
                });
            },
            getToday: () => {
                const today = new Date();
                return today.toISOString().split('T')[0];
            },
            getTodayTime: () => {
                const today = new Date();
                return today.toISOString().split('T')[1].substring(0, 5);
            },
            isToday: (dateStr) => {
                if(!dateStr) return false;
                return dateStr === Utils.getToday();
            },
            getTipoText: (tipo) => {
                const tipos = {
                    'apartamento': 'Apartamento',
                    'casa': 'Casa',
                    'terreno': 'Terreno',
                    'comercial': 'Comercial',
                    'kitnet': 'Kitnet'
                };
                return tipos[tipo] || tipo;
            },
            getStatusText: (status) => {
                const statuses = {
                    'disponivel': 'Disponível',
                    'reservado': 'Reservado',
                    'vendido': 'Vendido',
                    'alugado': 'Alugado'
                };
                return statuses[status] || status;
            },
            getTipoClienteText: (tipo) => {
                const tipos = {
                    'comprador': 'Comprador',
                    'vendedor': 'Vendedor',
                    'ambos': 'Comprador/Vendedor'
                };
                return tipos[tipo] || tipo;
            },
            getTipoVisitaText: (tipo) => {
                const tipos = {
                    'visita': 'Visita ao Imóvel',
                    'reuniao-construtor': 'Reunião com Construtor',
                    'reuniao-equipe': 'Reunião de Equipe',
                    'documentacao': 'Assinatura de Documentos',
                    'plantao': 'Plantão',
                    'generico': 'Agendamento Genérico',
                    'outro': 'Outro'
                };
                return tipos[tipo] || tipo;
            },
            getStatusVisitaText: (status) => {
                const statuses = {
                    'agendado': 'Agendado',
                    'confirmado': 'Confirmado',
                    'realizado': 'Realizado',
                    'cancelado': 'Cancelado'
                };
                return statuses[status] || status;
            },
            getEtapaFunilText: (etapa) => {
                const etapas = Storage.getFunilEtapas();
                return etapas.find(e => e.id === etapa)?.nome || etapa;
            },
            getEtapaFunilColor: (etapa) => {
                const etapas = Storage.getFunilEtapas();
                const etapaObj = etapas.find(e => e.id === etapa);
                return etapaObj?.cor || '#93c5fd';
            },
            // Verificar se é aniversário
            isBirthdayToday: (birthdate) => {
                if (!birthdate) return false;
                const today = new Date();
                const birth = new Date(birthdate);
                return today.getDate() === birth.getDate() && today.getMonth() === birth.getMonth();
            },
            // Calcular idade
            calculateAge: (birthdate) => {
                if (!birthdate) return null;
                const today = new Date();
                const birth = new Date(birthdate);
                let age = today.getFullYear() - birth.getFullYear();
                const m = today.getMonth() - birth.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) {
                    age--;
                }
                return age;
            },
            // Calcular dias em uma etapa
            calculateDaysInStage: (dataEntrada) => {
                if (!dataEntrada) return 0;
                const entrada = new Date(dataEntrada);
                const hoje = new Date();
                const diffTime = Math.abs(hoje - entrada);
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            },
            generatePDF: async (imovel) => {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('p', 'mm', 'a4');
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const pageHeight = doc.internal.pageSize.getHeight();
                    const margin = 15;
                    let yPos = margin;
                    
                    // Configurações
                    const settings = Storage.getSettings();
                    
                    // Cabeçalho
                    doc.setFontSize(20);
                    doc.setTextColor(37, 99, 235);
                    doc.text('FICHA TÉCNICA DO IMÓVEL', pageWidth/2, yPos, {align: 'center'});
                    yPos += 10;
                    
                    doc.setFontSize(12);
                    doc.setTextColor(100, 116, 139);
                    doc.text(`${settings.imobiliaria || 'Imobiliária'} | CRECI: ${settings.creci || '---'}`, pageWidth/2, yPos, {align: 'center'});
                    yPos += 15;
                    
                    // Linha divisória
                    doc.setDrawColor(37, 99, 235);
                    doc.setLineWidth(0.5);
                    doc.line(margin, yPos, pageWidth - margin, yPos);
                    yPos += 10;
                    
                    // Informações principais
                    doc.setFontSize(16);
                    doc.setTextColor(15, 23, 42);
                    doc.text(imovel.titulo, margin, yPos);
                    yPos += 8;
                    
                    doc.setFontSize(12);
                    doc.setTextColor(100, 116, 139);
                    doc.text(`Endereço: ${imovel.endereco}`, margin, yPos);
                    yPos += 8;
                    
                    // Preço
                    doc.setFontSize(14);
                    doc.setTextColor(37, 99, 235);
                    let precoText = '';
                    if(imovel.precoVenda) precoText += `Venda: ${Utils.formatCurrency(imovel.precoVenda)} `;
                    if(imovel.precoAluguel) precoText += `Aluguel: ${Utils.formatCurrency(imovel.precoAluguel)}/mês`;
                    doc.text(precoText, margin, yPos);
                    yPos += 10;
                    
                    // Características principais
                    doc.setFontSize(12);
                    doc.setTextColor(15, 23, 42);
                    const features = [
                        `Tipo: ${Utils.getTipoText(imovel.tipo)}`,
                        `Área: ${imovel.area || 0}m²`,
                        `Quartos: ${imovel.quartos || 0}`,
                        `Banheiros: ${imovel.banheiros || 0}`,
                        `Vagas: ${imovel.vagas || 0}`,
                        `Status: ${Utils.getStatusText(imovel.status)}`
                    ];
                    
                    // Adicionar novos campos se existirem
                    if(imovel.dataEntrega) features.push(`Data de Entrega: ${Utils.formatDate(imovel.dataEntrega)}`);
                    if(imovel.construtora) features.push(`Construtora: ${imovel.construtora}`);
                    if(imovel.formaPagamento) features.push(`Forma de Pagamento: ${imovel.formaPagamento}`);
                    if(imovel.condominio) features.push(`Condomínio: ${Utils.formatCurrency(imovel.condominio)}/mês`);
                    features.push(`Gás Encanado: ${imovel.gasEncanado === 'sim' ? 'Sim' : 'Não'}`);
                    
                    features.forEach(feature => {
                        doc.text(`• ${feature}`, margin, yPos);
                        yPos += 6;
                    });
                    
                    yPos += 5;
                    
                    // Descrição
                    if(imovel.descricao) {
                        doc.setFontSize(11);
                        doc.setTextColor(100, 116, 139);
                        const descLines = doc.splitTextToSize(imovel.descricao, pageWidth - 2*margin);
                        doc.text('Descrição:', margin, yPos);
                        yPos += 5;
                        doc.text(descLines, margin, yPos);
                        yPos += descLines.length * 5 + 5;
                    }
                    
                    // Aviso sobre alteração de valores
                    doc.setFontSize(9);
                    doc.setTextColor(245, 158, 11);
                    doc.setFont('helvetica', 'italic');
                    doc.text('* Os valores informados podem sofrer alteração sem aviso prévio.', margin, yPos);
                    yPos += 8;
                    
                    // Verificar se precisa de nova página para imagens
                    if(yPos > pageHeight - 100) {
                        doc.addPage();
                        yPos = margin;
                    }
                    
                    // Adicionar imagens
                    if(imovel.imagens && imovel.imagens.length > 0) {
                        doc.setFontSize(14);
                        doc.setTextColor(15, 23, 42);
                        doc.text('Fotos do Imóvel:', margin, yPos);
                        yPos += 10;
                        
                        const imgWidth = (pageWidth - 2*margin - 10) / 2;
                        const imgHeight = imgWidth * 0.75;
                        let imgX = margin;
                        
                        for(let i = 0; i < imovel.imagens.length; i++) {
                            if(i > 0 && i % 2 === 0) {
                                if(yPos + imgHeight > pageHeight - margin) {
                                    doc.addPage();
                                    yPos = margin;
                                } else {
                                    yPos += imgHeight + 5;
                                    imgX = margin;
                                }
                            }
                            
                            try {
                                // Converter base64 para blob e reduzir tamanho para PDF
                                const base64Data = imovel.imagens[i];
                                const img = new Image();
                                img.src = base64Data;
                                
                                await new Promise((resolve) => {
                                    img.onload = () => {
                                        const canvas = document.createElement('canvas');
                                        canvas.width = 400;
                                        canvas.height = 300;
                                        const ctx = canvas.getContext('2d');
                                        ctx.drawImage(img, 0, 0, 400, 300);
                                        
                                        const compressedBase64 = canvas.toDataURL('image/jpeg', 0.7);
                                        doc.addImage(compressedBase64, 'JPEG', imgX, yPos, imgWidth, imgHeight);
                                        resolve();
                                    };
                                    img.onerror = resolve;
                                });
                                
                            } catch(err) {
                                console.error('Erro ao adicionar imagem:', err);
                            }
                            
                            imgX += imgWidth + 10;
                            
                            // Adicionar número da foto
                            doc.setFontSize(8);
                            doc.setTextColor(100, 116, 139);
                            doc.text(`Foto ${i+1}`, imgX - imgWidth - 10 + 5, yPos + imgHeight + 5);
                        }
                        
                        yPos += imgHeight + 15;
                    }
                    
                    // Rodapé com informações da imobiliária
                    if(yPos > pageHeight - 30) {
                        doc.addPage();
                        yPos = margin;
                    }
                    
                    doc.setDrawColor(226, 232, 240);
                    doc.setLineWidth(0.5);
                    doc.line(margin, yPos, pageWidth - margin, yPos);
                    yPos += 10;
                    
                    doc.setFontSize(10);
                    doc.setTextColor(100, 116, 139);
                    doc.text(`Corretor: ${settings.nome || '---'}`, margin, yPos);
                    doc.text(`Telefone: ${settings.telefone || '---'}`, pageWidth/2, yPos);
                    yPos += 5;
                    doc.text(`Email: ${settings.email || '---'}`, margin, yPos);
                    doc.text(`Data do documento: ${new Date().toLocaleDateString('pt-BR')}`, pageWidth/2, yPos);
                    
                    // Salvar PDF
                    const fileName = `ficha_imovel_${imovel.titulo.substring(0, 20).replace(/[^a-z0-9]/gi, '_')}.pdf`;
                    doc.save(fileName);
                    
                    Utils.toast('PDF gerado com sucesso!');
                    
                } catch(err) {
                    console.error('Erro ao gerar PDF:', err);
                    Utils.toast('Erro ao gerar PDF', 'error');
                }
            },
            generateAgendaReport: async (agendaData) => {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('p', 'mm', 'a4');
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const pageHeight = doc.internal.pageSize.getHeight();
                    const margin = 15;
                    let yPos = margin;
                    
                    // Configurações do corretor
                    const settings = Storage.getSettings();
                    
                    // --- CABEÇALHO ---
                    doc.setFillColor(37, 99, 235); // Azul primário
                    doc.rect(0, 0, pageWidth, 40, 'F');
                    
                    // Logo/Texto
                    doc.setFontSize(24);
                    doc.setTextColor(255, 255, 255);
                    doc.setFont('helvetica', 'bold');
                    doc.text('RELATÓRIO DE AGENDAMENTOS', pageWidth/2, 20, {align: 'center'});
                    
                    doc.setFontSize(10);
                    doc.setTextColor(255, 255, 255, 0.8);
                    doc.text(`${settings.imobiliaria || 'Imobiliária'} • ${settings.nome || 'Corretor'}`, pageWidth/2, 28, {align: 'center'});
                    
                    yPos = 50;
                    
                    // --- INFORMAÇÕES DO CORRETOR ---
                    doc.setFontSize(12);
                    doc.setTextColor(15, 23, 42);
                    doc.setFont('helvetica', 'bold');
                    doc.text('INFORMAÇÕES DO CORRETOR', margin, yPos);
                    yPos += 8;
                    
                    doc.setDrawColor(37, 99, 235);
                    doc.setLineWidth(0.5);
                    doc.line(margin, yPos, margin + 80, yPos);
                    yPos += 10;
                    
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(100, 116, 139);
                    
                    const corretorInfo = [
                        `Corretor: ${settings.nome || '---'}`,
                        `CRECI: ${settings.creci || '---'}`,
                        `Imobiliária: ${settings.imobiliaria || '---'}`,
                        `Telefone: ${settings.telefone || '---'}`,
                        `Email: ${settings.email || '---'}`
                    ];
                    
                    corretorInfo.forEach(info => {
                        doc.text(info, margin, yPos);
                        yPos += 6;
                    });
                    
                    yPos += 10;
                    
                    // --- RESUMO DO PERÍODO ---
                    doc.setFontSize(12);
                    doc.setTextColor(15, 23, 42);
                    doc.setFont('helvetica', 'bold');
                    doc.text('PERÍODO DO RELATÓRIO', margin, yPos);
                    yPos += 8;
                    
                    doc.setDrawColor(37, 99, 235);
                    doc.setLineWidth(0.5);
                    doc.line(margin, yPos, margin + 70, yPos);
                    yPos += 10;
                    
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(100, 116, 139);
                    doc.text(`Período: ${agendaData.periodo || 'Todos os agendamentos'}`, margin, yPos);
                    yPos += 6;
                    doc.text(`Data do relatório: ${new Date().toLocaleDateString('pt-BR')}`, margin, yPos);
                    yPos += 15;
                    
                    // --- ESTATÍSTICAS PRINCIPAIS ---
                    doc.setFontSize(14);
                    doc.setTextColor(37, 99, 235);
                    doc.setFont('helvetica', 'bold');
                    doc.text('ESTATÍSTICAS GERAIS', pageWidth/2, yPos, {align: 'center'});
                    yPos += 10;
                    
                    // Grid de estatísticas
                    const stats = [
                        { label: 'Total Agendamentos', value: agendaData.totalAgendamentos, color: [37, 99, 235] },
                        { label: 'Visitas', value: agendaData.visitas, color: [59, 130, 246] },
                        { label: 'Reuniões Construtor', value: agendaData.reunioesConstrutor, color: [139, 92, 246] },
                        { label: 'Reuniões Equipe', value: agendaData.reunioesEquipe, color: [14, 165, 233] },
                        { label: 'Plantões', value: agendaData.plantoes, color: [124, 58, 237] },
                        { label: 'Realizados', value: agendaData.realizados, color: [16, 185, 129] }
                    ];
                    
                    const statWidth = (pageWidth - 2*margin - 30) / 3;
                    let statX = margin;
                    
                    for(let i = 0; i < stats.length; i++) {
                        if(i > 0 && i % 3 === 0) {
                            yPos += 45;
                            statX = margin;
                        }
                        
                        // Caixa do stat
                        doc.setFillColor(...stats[i].color, 0.1);
                        doc.roundedRect(statX, yPos, statWidth, 35, 3, 3, 'F');
                        
                        doc.setDrawColor(...stats[i].color);
                        doc.setLineWidth(0.5);
                        doc.roundedRect(statX, yPos, statWidth, 35, 3, 3, 'S');
                        
                        // Valor
                        doc.setFontSize(16);
                        doc.setTextColor(...stats[i].color);
                        doc.setFont('helvetica', 'bold');
                        doc.text(stats[i].value.toString(), statX + statWidth/2, yPos + 15, {align: 'center'});
                        
                        // Label
                        doc.setFontSize(8);
                        doc.setTextColor(100, 116, 139);
                        doc.setFont('helvetica', 'normal');
                        const labelLines = doc.splitTextToSize(stats[i].label, statWidth - 10);
                        doc.text(labelLines, statX + statWidth/2, yPos + 25, {align: 'center'});
                        
                        statX += statWidth + 10;
                    }
                    
                    yPos += 50;
                    
                    // Verificar nova página
                    if(yPos > pageHeight - 50) {
                        doc.addPage();
                        yPos = margin;
                    }
                    
                    // --- DETALHES DOS AGENDAMENTOS ---
                    if(agendaData.agendamentos && agendaData.agendamentos.length > 0) {
                        doc.setFontSize(14);
                        doc.setTextColor(15, 23, 42);
                        doc.setFont('helvetica', 'bold');
                        doc.text('DETALHES DOS AGENDAMENTOS', margin, yPos);
                        yPos += 10;
                        
                        doc.setDrawColor(37, 99, 235);
                        doc.setLineWidth(0.5);
                        doc.line(margin, yPos, margin + 110, yPos);
                        yPos += 15;
                        
                        for(let i = 0; i < agendaData.agendamentos.length; i++) {
                            const agendamento = agendaData.agendamentos[i];
                            
                            // Verificar se precisa de nova página
                            if(yPos > pageHeight - 100) {
                                doc.addPage();
                                yPos = margin;
                            }
                            
                            // Cabeçalho do agendamento
                            const typeColor = {
                                'visita': [59, 130, 246],
                                'reuniao-construtor': [139, 92, 246],
                                'reuniao-equipe': [14, 165, 233],
                                'documentacao': [16, 185, 129],
                                'plantao': [124, 58, 237],
                                'generico': [245, 158, 11],
                                'outro': [100, 116, 139]
                            }[agendamento.tipo] || [37, 99, 235];
                            
                            doc.setFillColor(...typeColor, 0.1);
                            doc.roundedRect(margin, yPos, pageWidth - 2*margin, 25, 3, 3, 'F');
                            
                            doc.setFontSize(11);
                            doc.setTextColor(...typeColor);
                            doc.setFont('helvetica', 'bold');
                            doc.text(`${Utils.getTipoVisitaText(agendamento.tipo).toUpperCase()} - ${Utils.formatDate(agendamento.data)} ${agendamento.horario}`, margin + 10, yPos + 8);
                            
                            doc.setFontSize(9);
                            doc.setTextColor(100, 116, 139);
                            doc.setFont('helvetica', 'normal');
                            doc.text(`Status: ${agendamento.status === 'realizado' ? '✅ Realizado' : agendamento.status === 'cancelado' ? '❌ Cancelado' : agendamento.status === 'confirmado' ? '✅ Confirmado' : '⏰ Agendado'}`, pageWidth - margin - 10, yPos + 8, {align: 'right'});
                            
                            yPos += 30;
                            
                            // Detalhes específicos por tipo
                            let detalhesHTML = '';
                            
                            switch(agendamento.tipo) {
                                case 'visita':
                                    if(agendamento.localVisita) {
                                        detalhesHTML += `Local: ${agendamento.localVisita}\n`;
                                    }
                                    break;
                                    
                                case 'reuniao-construtor':
                                    if(agendamento.construtorNome) {
                                        detalhesHTML += `Construtor: ${agendamento.construtorNome}\n`;
                                    }
                                    if(agendamento.construtorEmpreendimento) {
                                        detalhesHTML += `Empreendimento: ${agendamento.construtorEmpreendimento}\n`;
                                    }
                                    if(agendamento.construtorAssuntos) {
                                        detalhesHTML += `Assuntos: ${agendamento.construtorAssuntos}\n`;
                                    }
                                    break;
                                    
                                case 'reuniao-equipe':
                                    if(agendamento.equipeTipo) {
                                        detalhesHTML += `Tipo: ${agendamento.equipeTipo}\n`;
                                    }
                                    if(agendamento.equipeParticipantes) {
                                        detalhesHTML += `Participantes: ${agendamento.equipeParticipantes}\n`;
                                    }
                                    if(agendamento.equipeAssuntos) {
                                        detalhesHTML += `Pauta: ${agendamento.equipeAssuntos}\n`;
                                    }
                                    break;
                                    
                                case 'plantao':
                                    if(agendamento.plantaoLocal) {
                                        detalhesHTML += `Local: ${agendamento.plantaoLocal}\n`;
                                    }
                                    if(agendamento.detalhesPlantoes) {
                                        detalhesHTML += `Atividades: ${agendamento.detalhesPlantoes}\n`;
                                    }
                                    if(agendamento.clientesAtendidos) {
                                        const clientesCount = agendamento.clientesAtendidos.split('\n').filter(c => c.trim()).length;
                                        detalhesHTML += `Clientes Atendidos: ${clientesCount}\n`;
                                    }
                                    break;
                                    
                                case 'generico':
                                    if(agendamento.genericoTitulo) {
                                        detalhesHTML += `Título: ${agendamento.genericoTitulo}\n`;
                                    }
                                    if(agendamento.genericoLocal) {
                                        detalhesHTML += `Local: ${agendamento.genericoLocal}\n`;
                                    }
                                    if(agendamento.genericoDescricao) {
                                        detalhesHTML += `Descrição: ${agendamento.genericoDescricao}\n`;
                                    }
                                    break;
                            }
                            
                            if(agendamento.observacoes) {
                                detalhesHTML += `Observações: ${agendamento.observacoes}\n`;
                            }
                            
                            if(detalhesHTML) {
                                doc.setFontSize(10);
                                doc.setTextColor(15, 23, 42);
                                doc.setFont('helvetica', 'bold');
                                doc.text('Detalhes:', margin, yPos);
                                yPos += 5;
                                
                                doc.setFontSize(9);
                                doc.setTextColor(100, 116, 139);
                                doc.setFont('helvetica', 'normal');
                                const detalhesLines = doc.splitTextToSize(detalhesHTML, pageWidth - 2*margin - 10);
                                doc.text(detalhesLines, margin + 5, yPos);
                                yPos += detalhesLines.length * 5 + 10;
                            } else {
                                yPos += 5;
                            }
                            
                            // Linha divisória
                            doc.setDrawColor(226, 232, 240);
                            doc.setLineWidth(0.3);
                            doc.line(margin, yPos, pageWidth - margin, yPos);
                            yPos += 15;
                        }
                    }
                    
                    // --- RODAPÉ PROFISSIONAL ---
                    if(yPos > pageHeight - 40) {
                        doc.addPage();
                        yPos = margin;
                    }
                    
                    doc.setDrawColor(226, 232, 240);
                    doc.setLineWidth(0.5);
                    doc.line(margin, yPos, pageWidth - margin, yPos);
                    yPos += 10;
                    
                    // Informações de contato
                    doc.setFontSize(8);
                    doc.setTextColor(100, 116, 139);
                    doc.setFont('helvetica', 'normal');
                    
                    const contactInfo = [
                        `Relatório gerado automaticamente pelo ImobiPro - Gestão Imobiliária`,
                        `Data: ${new Date().toLocaleDateString('pt-BR')} ${new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})}`,
                        `Para mais informações, entre em contato: ${settings.telefone || '---'} | ${settings.email || '---'}`
                    ];
                    
                    contactInfo.forEach((info, index) => {
                        doc.text(info, pageWidth/2, yPos + (index * 4), {align: 'center'});
                    });
                    
                    // Salvar PDF
                    const fileName = `relatorio_agendamentos_${settings.nome ? settings.nome.replace(/\s+/g, '_').toLowerCase() : 'corretor'}_${new Date().toISOString().split('T')[0]}.pdf`;
                    doc.save(fileName);
                    
                    Utils.toast('Relatório de agendamentos gerado com sucesso!');
                    
                } catch(err) {
                    console.error('Erro ao gerar relatório de agendamentos:', err);
                    Utils.toast('Erro ao gerar relatório', 'error');
                }
            },
            openWhatsApp: (phoneNumber, message = '') => {
                if (!phoneNumber) {
                    Utils.toast('Número de telefone não informado', 'error');
                    return;
                }
                
                // Remover formatação do telefone
                const cleanNumber = phoneNumber.replace(/\D/g, '');
                
                // Verificar se tem DDI (Brasil = 55)
                let finalNumber = cleanNumber;
                if (cleanNumber.length === 11 && cleanNumber.startsWith('0')) {
                    finalNumber = '55' + cleanNumber.substring(1);
                } else if (cleanNumber.length === 10) {
                    finalNumber = '55' + cleanNumber;
                } else if (cleanNumber.length === 13 && cleanNumber.startsWith('55')) {
                    finalNumber = cleanNumber;
                } else {
                    // Tentar adivinhar o formato
                    finalNumber = '55' + cleanNumber;
                }
                
                const encodedMessage = encodeURIComponent(message);
                const whatsappUrl = `https://wa.me/${finalNumber}${message ? `?text=${encodedMessage}` : ''}`;
                
                window.open(whatsappUrl, '_blank');
            },
            generateWhatsAppMessage: (cliente, settings) => {
                let message = `Olá ${cliente.nome.split(' ')[0]}! Tudo bem?\n\n`;
                message += `Aqui é ${settings.nome || 'o corretor'} da ${settings.imobiliaria || 'imobiliária'}.\n\n`;
                
                if (cliente.tipo === 'comprador') {
                    message += `Estou entrando em contato sobre o seu interesse em imóveis. `;
                    if (cliente.faixaPreco) {
                        message += `Lembrei que você busca algo na faixa de ${cliente.faixaPreco}.\n\n`;
                    }
                    message += `Tenho algumas opções que podem te interessar. Podemos conversar?`;
                } else if (cliente.tipo === 'vendedor') {
                    message += `Estou acompanhando o seu imóvel. `;
                    message += `Temos novidades sobre a negociação. Podemos conversar?`;
                } else {
                    message += `Estou entrando em contato para conversarmos sobre imóveis. `;
                    message += `Podemos agendar uma conversa?`;
                }
                
                message += `\n\n📞 ${settings.telefone || ''}`;
                message += `\n🏢 ${settings.imobiliaria || ''}`;
                message += `\n👨‍💼 ${settings.nome || ''} | CRECI: ${settings.creci || ''}`;
                
                return message;
            }
        };

        // --- STORAGE MANAGER ---
        const Storage = {
            get: (key) => JSON.parse(localStorage.getItem(`imobipro_${key}`)) || [],
            set: (key, data) => localStorage.setItem(`imobipro_${key}`, JSON.stringify(data)),
            getSettings: () => JSON.parse(localStorage.getItem('imobipro_settings')) || { 
                nome: 'Seu Nome',
                creci: '12345-SP',
                telefone: '(11) 99999-9999',
                email: 'seuemail@imobiliaria.com',
                imobiliaria: 'Imobiliária Exemplo',
                comissao: 5
            },
            saveSettings: (data) => localStorage.setItem('imobipro_settings', JSON.stringify(data)),
            getFunilEtapas: () => {
                const etapasPadrao = [
                    { id: 'lead', nome: 'Lead', cor: '#93c5fd', ordem: 1 },
                    { id: 'contato', nome: 'Contato Realizado', cor: '#60a5fa', ordem: 2 },
                    { id: 'cpf', nome: 'CPF em Análise', cor: '#3b82f6', ordem: 3 },
                    { id: 'sem-restricao', nome: 'Sem Restrição', cor: '#1d4ed8', ordem: 4 },
                    { id: 'documentacao', nome: 'Documentação', cor: '#7c3aed', ordem: 5 },
                    { id: 'aprovado', nome: 'Aprovado', cor: '#10b981', ordem: 6 },
                    { id: 'contrato', nome: 'Contrato Assinado', cor: '#059669', ordem: 7 },
                    { id: 'venda', nome: 'Venda Concluída', cor: '#047857', ordem: 8 }
                ];
                return JSON.parse(localStorage.getItem('imobipro_funil_etapas')) || etapasPadrao;
            },
            saveFunilEtapas: (etapas) => localStorage.setItem('imobipro_funil_etapas', JSON.stringify(etapas)),
            getLinks: () => JSON.parse(localStorage.getItem('imobipro_links')) || [],
            saveLinks: (links) => localStorage.setItem('imobipro_links', JSON.stringify(links))
        };

        // --- UI MANAGER ---
        const UI = {
            data: { 
                clientes: [], 
                imoveis: [], 
                visitas: [],
                links: [],
                funilEtapas: []
            },
            chartInstance: null,
            agendaChartInstance: null,
            currentCarouselIndex: 0,
            currentCarouselImages: [],
            fullscreenImages: [],
            fullscreenCurrentIndex: 0,
            currentAgendaFilter: 'todos',
            draggingClient: null,
            
            init: () => {
                UI.data.clientes = Storage.get('clientes');
                UI.data.imoveis = Storage.get('imoveis');
                UI.data.visitas = Storage.get('visitas');
                UI.data.links = Storage.get('links');
                UI.data.funilEtapas = Storage.getFunilEtapas();
                
                // Garantir que todos os clientes tenham etapa no funil
                UI.data.clientes.forEach(cliente => {
                    if (!cliente.etapaFunil) {
                        cliente.etapaFunil = 'lead';
                        cliente.dataEntradaFunil = cliente.dataEntradaFunil || new Date().toISOString().split('T')[0];
                    }
                });
                
                UI.renderDashboard();
                
                // Tabs listeners
                document.querySelectorAll('.bottom-nav .nav-item').forEach(el => {
                    el.addEventListener('click', (e) => e.preventDefault());
                });
                
                // Inicializar funil
                UI.renderFunil();
            },

            switchTab: (el) => {
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                
                el.classList.add('active');
                const target = el.getAttribute('data-target');
                document.getElementById(target).classList.add('active');

                // Toggle FAB visibility
                const fab = document.getElementById('main-fab');
                if(target === 'dashboard-view' || target === 'imoveis-view') {
                    fab.style.display = 'flex';
                    fab.onclick = UI.openNewImovel;
                } else if (target === 'clientes-view') {
                    fab.style.display = 'flex';
                    fab.onclick = () => UI.openNewCliente(false);
                } else if (target === 'agenda-view') {
                    fab.style.display = 'flex';
                    fab.onclick = UI.openNewVisita;
                } else if (target === 'links-view') {
                    fab.style.display = 'flex';
                    fab.onclick = UI.openNewLink;
                } else if (target === 'funil-view') {
                    fab.style.display = 'none';
                    UI.renderFunil();
                } else {
                    fab.style.display = 'none';
                }

                if(target === 'clientes-view') UI.renderClientes();
                if(target === 'imoveis-view') UI.renderImoveis();
                if(target === 'agenda-view') UI.renderAgenda();
                if(target === 'relatorios-view') UI.renderRelatorios();
                if(target === 'links-view') UI.renderLinks();
            },

            navigate: (tabName) => {
                const el = document.querySelector(`.nav-item[data-target="${tabName}-view"]`);
                if(el) UI.switchTab(el);
            },

            // --- FUNIL DE VENDAS ---
            renderFunil: () => {
                const etapas = UI.data.funilEtapas.sort((a, b) => a.ordem - b.ordem);
                
                // Calcular estatísticas
                const totalClientes = UI.data.clientes.length;
                const clientesPorEtapa = {};
                let totalVendas = 0;
                let totalDias = 0;
                let clientesComData = 0;
                
                etapas.forEach(etapa => {
                    const clientes = UI.data.clientes.filter(c => c.etapaFunil === etapa.id);
                    clientesPorEtapa[etapa.id] = clientes;
                    
                    if (etapa.id === 'venda') {
                        totalVendas = clientes.length;
                    }
                    
                    // Calcular tempo médio
                    clientes.forEach(cliente => {
                        if (cliente.dataEntradaFunil) {
                            const dias = Utils.calculateDaysInStage(cliente.dataEntradaFunil);
                            totalDias += dias;
                            clientesComData++;
                        }
                    });
                });
                
                // Atualizar estatísticas
                document.getElementById('funil-lead').textContent = clientesPorEtapa['lead']?.length || 0;
                document.getElementById('funil-venda').textContent = totalVendas;
                document.getElementById('funil-total').textContent = `${totalClientes} clientes`;
                
                // Calcular taxa de conversão
                const taxaConversao = totalClientes > 0 ? ((totalVendas / totalClientes) * 100).toFixed(1) : 0;
                document.getElementById('funil-taxa').textContent = `${taxaConversao}%`;
                
                // Calcular tempo médio
                const tempoMedio = clientesComData > 0 ? Math.round(totalDias / clientesComData) : 0;
                document.getElementById('funil-tempo').textContent = `${tempoMedio}d`;
                
                // Renderizar estágios do funil
                const container = document.getElementById('funil-stages-container');
                let html = '<div class="funnel-stages">';
                
                etapas.forEach(etapa => {
                    const clientes = clientesPorEtapa[etapa.id] || [];
                    const porcentagem = totalClientes > 0 ? Math.round((clientes.length / totalClientes) * 100) : 0;
                    
                    html += `
                        <div class="funnel-stage stage-${etapa.id}" onclick="UI.toggleFunnelStage('${etapa.id}')">
                            <div class="funnel-stage-header">
                                <div class="funnel-stage-title">
                                    <i class="fas fa-${UI.getFunnelIcon(etapa.id)}"></i>
                                    ${etapa.nome}
                                </div>
                                <span class="funnel-stage-count" style="background: ${etapa.cor}; color: white;">${clientes.length}</span>
                            </div>
                            <div class="progress-container">
                                <div class="progress-bar" style="width: ${porcentagem}%; background: ${etapa.cor};"></div>
                            </div>
                            <div class="funnel-stage-clients" id="funnel-clients-${etapa.id}">
                                ${clientes.map(cliente => `
                                    <div class="funnel-client-item" draggable="true" 
                                         data-cliente-id="${cliente.id}"
                                         ondragstart="UI.startDrag(event, '${cliente.id}')"
                                         ondrop="UI.dropOnClient(event, '${etapa.id}')"
                                         ondragover="event.preventDefault()">
                                        <div class="funnel-client-name">${cliente.nome}</div>
                                        <div class="funnel-client-days">
                                            ${cliente.dataEntradaFunil ? `${Utils.calculateDaysInStage(cliente.dataEntradaFunil)} dias` : 'Novo'}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
                
                // Renderizar lista de clientes no funil
                UI.renderClientesFunil();
                
                // Popular select de filtro
                const select = document.querySelector('#funil-view select');
                if (select) {
                    select.innerHTML = '<option value="todos">Todos os estágios</option>';
                    etapas.forEach(etapa => {
                        select.innerHTML += `<option value="${etapa.id}">${etapa.nome}</option>`;
                    });
                }
            },
            
            getFunnelIcon: (etapaId) => {
                const icons = {
                    'lead': 'user-plus',
                    'contato': 'phone-alt',
                    'cpf': 'search',
                    'sem-restricao': 'check-circle',
                    'documentacao': 'file-contract',
                    'aprovado': 'thumbs-up',
                    'contrato': 'pen-fancy',
                    'venda': 'trophy'
                };
                return icons[etapaId] || 'circle';
            },
            
            toggleFunnelStage: (etapaId) => {
                const stage = document.querySelector(`.stage-${etapaId}`);
                const clientsContainer = document.getElementById(`funnel-clients-${etapaId}`);
                
                if (stage.classList.contains('expanded')) {
                    stage.classList.remove('expanded');
                    clientsContainer.style.maxHeight = '0';
                } else {
                    // Fechar outros estágios
                    document.querySelectorAll('.funnel-stage.expanded').forEach(s => {
                        s.classList.remove('expanded');
                        const id = s.className.match(/stage-(\w+)/)[1];
                        document.getElementById(`funnel-clients-${id}`).style.maxHeight = '0';
                    });
                    
                    stage.classList.add('expanded');
                    clientsContainer.style.maxHeight = `${clientsContainer.scrollHeight}px`;
                }
            },
            
            startDrag: (event, clienteId) => {
                event.dataTransfer.setData('text/plain', clienteId);
                UI.draggingClient = clienteId;
                event.target.classList.add('dragging');
            },
            
            allowDrop: (event) => {
                event.preventDefault();
            },
            
            dropOnStage: (event, etapaId) => {
                event.preventDefault();
                const clienteId = event.dataTransfer.getData('text/plain');
                
                if (clienteId) {
                    const cliente = UI.data.clientes.find(c => c.id === clienteId);
                    if (cliente && cliente.etapaFunil !== etapaId) {
                        cliente.etapaFunil = etapaId;
                        cliente.dataEntradaFunil = new Date().toISOString().split('T')[0];
                        Storage.set('clientes', UI.data.clientes);
                        UI.renderFunil();
                        UI.renderClientes();
                        Utils.toast(`${cliente.nome} movido para ${Utils.getEtapaFunilText(etapaId)}`);
                    }
                }
                
                // Remover classe dragging
                document.querySelectorAll('.dragging').forEach(el => el.classList.remove('dragging'));
                UI.draggingClient = null;
            },
            
            dropOnClient: (event, etapaId) => {
                event.preventDefault();
                UI.dropOnStage(event, etapaId);
            },
            
            renderClientesFunil: (filterEtapa = 'todos') => {
                const container = document.getElementById('funil-clientes-list');
                let clientes = UI.data.clientes;
                
                if (filterEtapa !== 'todos') {
                    clientes = clientes.filter(c => c.etapaFunil === filterEtapa);
                }
                
                if (clientes.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <p>Nenhum cliente neste estágio do funil</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = clientes.map(cliente => {
                    const etapa = UI.data.funilEtapas.find(e => e.id === cliente.etapaFunil);
                    const dias = cliente.dataEntradaFunil ? Utils.calculateDaysInStage(cliente.dataEntradaFunil) : 0;
                    
                    return `
                        <div class="client-card" onclick="UI.showClienteDetails('${cliente.id}')">
                            <div class="client-header">
                                <div class="client-name">${cliente.nome}</div>
                                <span class="client-type" style="background: ${etapa?.cor || '#93c5fd'}; color: white;">
                                    ${etapa?.nome || 'Lead'}
                                </span>
                            </div>
                            <div class="client-info">
                                <div class="client-row"><i class="fas fa-phone"></i> ${cliente.telefone}</div>
                                ${cliente.email ? `<div class="client-row"><i class="fas fa-envelope"></i> ${cliente.email}</div>` : ''}
                                <div class="client-row"><i class="fas fa-calendar"></i> ${dias} dias nesta etapa</div>
                                ${cliente.faixaPreco ? `<div class="client-row"><i class="fas fa-search-dollar"></i> ${cliente.faixaPreco}</div>` : ''}
                            </div>
                            <div class="client-actions">
                                <button class="btn-whatsapp-client" onclick="event.stopPropagation(); App.cliente.whatsapp('${cliente.id}')">
                                    <i class="fab fa-whatsapp"></i> WhatsApp
                                </button>
                                <button class="btn-sm btn-light" onclick="event.stopPropagation(); App.cliente.edit('${cliente.id}')">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            },
            
            filterClientesFunil: (etapaId) => {
                UI.renderClientesFunil(etapaId);
            },
            
            filterFunil: (etapaId) => {
                UI.filterClientesFunil(etapaId);
                // Rolagem para a seção de clientes
                document.getElementById('funil-clientes-list').scrollIntoView({ behavior: 'smooth' });
            },
            
            openFunilSettings: () => {
                const container = document.getElementById('funil-etapas-list');
                container.innerHTML = '';
                
                UI.data.funilEtapas.sort((a, b) => a.ordem - b.ordem).forEach((etapa, index) => {
                    const etapaEl = document.createElement('div');
                    etapaEl.className = 'form-group';
                    etapaEl.innerHTML = `
                        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 8px;">
                            <div style="width: 30px; height: 30px; border-radius: 6px; background: ${etapa.cor}; display: flex; align-items: center; justify-content: center; color: white;">
                                <i class="fas fa-${UI.getFunnelIcon(etapa.id)}"></i>
                            </div>
                            <input type="text" class="form-control" value="${etapa.nome}" 
                                   onchange="UI.updateEtapaFunil(${index}, 'nome', this.value)" 
                                   style="flex: 1;">
                            <input type="color" value="${etapa.cor}" 
                                   onchange="UI.updateEtapaFunil(${index}, 'cor', this.value)"
                                   style="width: 40px; height: 40px; padding: 0; border: none;">
                            <button class="icon-btn" onclick="UI.moveEtapaFunil(${index}, 'up')" ${index === 0 ? 'disabled' : ''}>
                                <i class="fas fa-arrow-up"></i>
                            </button>
                            <button class="icon-btn" onclick="UI.moveEtapaFunil(${index}, 'down')" ${index === UI.data.funilEtapas.length - 1 ? 'disabled' : ''}>
                                <i class="fas fa-arrow-down"></i>
                            </button>
                            <button class="icon-btn" style="color: var(--danger);" onclick="UI.removeEtapaFunil(${index})" ${UI.data.funilEtapas.length <= 1 ? 'disabled' : ''}>
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    container.appendChild(etapaEl);
                });
                
                UI.openModal('funil-settings');
            },
            
            updateEtapaFunil: (index, campo, valor) => {
                UI.data.funilEtapas[index][campo] = valor;
                Storage.saveFunilEtapas(UI.data.funilEtapas);
                UI.renderFunil();
            },
            
            moveEtapaFunil: (index, direcao) => {
                if (direcao === 'up' && index > 0) {
                    const temp = UI.data.funilEtapas[index];
                    UI.data.funilEtapas[index] = UI.data.funilEtapas[index - 1];
                    UI.data.funilEtapas[index - 1] = temp;
                } else if (direcao === 'down' && index < UI.data.funilEtapas.length - 1) {
                    const temp = UI.data.funilEtapas[index];
                    UI.data.funilEtapas[index] = UI.data.funilEtapas[index + 1];
                    UI.data.funilEtapas[index + 1] = temp;
                }
                
                // Atualizar ordens
                UI.data.funilEtapas.forEach((etapa, idx) => {
                    etapa.ordem = idx + 1;
                });
                
                Storage.saveFunilEtapas(UI.data.funilEtapas);
                UI.openFunilSettings();
                UI.renderFunil();
            },
            
            addEtapaFunil: () => {
                const novaEtapa = {
                    id: `etapa-${Date.now()}`,
                    nome: 'Nova Etapa',
                    cor: '#6b7280',
                    ordem: UI.data.funilEtapas.length + 1
                };
                
                UI.data.funilEtapas.push(novaEtapa);
                Storage.saveFunilEtapas(UI.data.funilEtapas);
                UI.openFunilSettings();
                UI.renderFunil();
            },
            
            removeEtapaFunil: (index) => {
                if (UI.data.funilEtapas.length <= 1) {
                    Utils.toast('O funil deve ter pelo menos uma etapa', 'error');
                    return;
                }
                
                const etapaRemovida = UI.data.funilEtapas[index];
                
                // Mover clientes desta etapa para a primeira etapa
                UI.data.clientes.forEach(cliente => {
                    if (cliente.etapaFunil === etapaRemovida.id) {
                        cliente.etapaFunil = UI.data.funilEtapas[0].id;
                    }
                });
                
                Storage.set('clientes', UI.data.clientes);
                UI.data.funilEtapas.splice(index, 1);
                
                // Reordenar
                UI.data.funilEtapas.forEach((etapa, idx) => {
                    etapa.ordem = idx + 1;
                });
                
                Storage.saveFunilEtapas(UI.data.funilEtapas);
                UI.openFunilSettings();
                UI.renderFunil();
                UI.renderClientes();
                Utils.toast('Etapa removida! Clientes movidos para a primeira etapa.');
            },
            
            // --- LINKS ÚTEIS ---
            renderLinks: (filter = '') => {
                const container = document.getElementById('links-grid');
                let links = UI.data.links;
                
                if (filter) {
                    const termo = filter.toLowerCase();
                    links = links.filter(link => 
                        link.titulo.toLowerCase().includes(termo) ||
                        link.descricao?.toLowerCase().includes(termo) ||
                        link.categoria?.toLowerCase().includes(termo) ||
                        link.url.toLowerCase().includes(termo)
                    );
                }
                
                if (links.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state" style="grid-column: 1 / -1;">
                            <i class="fas fa-link"></i>
                            <p>${filter ? 'Nenhum link encontrado' : 'Nenhum link salvo ainda'}</p>
                            ${!filter ? '<button class="btn-block" onclick="UI.openNewLink()" style="margin-top: 16px;">Adicionar Primeiro Link</button>' : ''}
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = links.map(link => {
                    const categoriaIcon = {
                        'construtora': 'building',
                        'documentos': 'file-contract',
                        'financiamento': 'hand-holding-usd',
                        'noticias': 'newspaper',
                        'ferramentas': 'tools',
                        'outros': 'link'
                    }[link.categoria] || 'link';
                    
                    return `
                        <div class="link-card" onclick="App.link.open('${link.id}')">
                            <div class="link-icon">
                                <i class="fas fa-${categoriaIcon}"></i>
                            </div>
                            <div class="link-title">${link.titulo}</div>
                            <div class="link-url">${link.url.replace(/^https?:\/\//, '').substring(0, 30)}...</div>
                            ${link.descricao ? `<div style="font-size: 0.8rem; color: var(--secondary); margin-top: 4px;">${link.descricao.substring(0, 50)}...</div>` : ''}
                            <div class="link-actions">
                                <button class="btn-sm btn-light" onclick="event.stopPropagation(); App.link.edit('${link.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-sm btn-light" onclick="event.stopPropagation(); App.link.copy('${link.id}')">
                                    <i class="fas fa-copy"></i>
                                </button>
                                <button class="btn-sm btn-light" style="color: var(--danger);" onclick="event.stopPropagation(); App.link.delete('${link.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            },
            
            openNewLink: () => {
                document.getElementById('form-link').reset();
                document.getElementById('l-id').value = '';
                document.getElementById('title-link').innerText = 'Novo Link';
                UI.openModal('link');
            },

            // --- RENDER FUNCTIONS ---
            renderDashboard: () => {
                const { clientes, imoveis, visitas } = UI.data;
                
                // Estatísticas básicas
                document.getElementById('dash-total-clientes').innerText = clientes.length;
                document.getElementById('dash-total-imoveis').innerText = imoveis.length;
                
                // Visitas para hoje
                const hoje = Utils.getToday();
                const visitasHoje = visitas.filter(v => v.data === hoje && v.status !== 'cancelado');
                document.getElementById('dash-visitas').innerText = visitasHoje.length;
                
                // Total de vendas do mês
                const hojeObj = new Date();
                const mesAtual = hojeObj.getMonth();
                const anoAtual = hojeObj.getFullYear();
                
                const vendasMes = imoveis.filter(i => 
                    i.status === 'vendido' || i.status === 'alugado'
                ).filter(i => {
                    if(!i.dataVenda) return false;
                    const dataVenda = new Date(i.dataVenda);
                    return dataVenda.getMonth() === mesAtual && dataVenda.getFullYear() === anoAtual;
                });
                
                const totalVendas = vendasMes.reduce((acc, i) => acc + (i.precoVenda || i.precoAluguel || 0), 0);
                document.getElementById('dash-vendas').innerText = Utils.formatCurrency(totalVendas);
                
                // Negociações ativas
                const negociacoes = imoveis.filter(i => i.status === 'reservado').length;
                document.getElementById('dash-negociacoes').innerText = negociacoes;
                
                // Imóveis em destaque
                const destaques = imoveis.filter(i => i.destaque).length;
                document.getElementById('dash-destaques').innerText = destaques;
                
                // Aniversariantes do dia
                UI.renderAniversariantes();
                
                // Render visitas de hoje
                const visitasList = document.getElementById('visitas-list');
                if(visitasHoje.length === 0) {
                    visitasList.innerHTML = `<div class="empty-state"><i class="fas fa-calendar-check"></i><p>Nenhuma visita agendada para hoje!</p></div>`;
                } else {
                    visitasList.innerHTML = visitasHoje.map(v => UI.createVisitaCard(v)).join('');
                }
                
                // Render negociações recentes
                const negociacoesList = document.getElementById('negociacoes-list');
                const imoveisReservados = imoveis.filter(i => i.status === 'reservado').slice(0, 3);
                
                if(imoveisReservados.length === 0) {
                    negociacoesList.innerHTML = `<div class="empty-state"><i class="fas fa-handshake"></i><p>Nenhuma negociação ativa!</p></div>`;
                } else {
                    negociacoesList.innerHTML = imoveisReservados.map(i => UI.createNegociacaoCard(i)).join('');
                }
                
                // Badges
                document.getElementById('visitas-badge').style.display = visitasHoje.length > 0 ? 'inline-block' : 'none';
                document.getElementById('negociacoes-badge').style.display = imoveisReservados.length > 0 ? 'inline-block' : 'none';
            },

            renderAniversariantes: () => {
                const hoje = new Date();
                const diaHoje = hoje.getDate();
                const mesHoje = hoje.getMonth() + 1;
                
                const aniversariantes = UI.data.clientes.filter(cliente => {
                    if (!cliente.dataNascimento) return false;
                    const nascimento = new Date(cliente.dataNascimento);
                    return nascimento.getDate() === diaHoje && (nascimento.getMonth() + 1) === mesHoje;
                });
                
                const aniversariantesList = document.getElementById('aniversariantes-list');
                const badge = document.getElementById('aniversariantes-badge');
                
                if (aniversariantes.length === 0) {
                    aniversariantesList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-birthday-cake"></i>
                            <p>Nenhum aniversariante hoje</p>
                        </div>
                    `;
                    badge.style.display = 'none';
                } else {
                    aniversariantesList.innerHTML = aniversariantes.map(cliente => {
                        const idade = Utils.calculateAge(cliente.dataNascimento);
                        return `
                            <div class="client-card" onclick="UI.showClienteDetails('${cliente.id}')">
                                <div class="client-header">
                                    <div class="client-name">${cliente.nome} <span class="badge badge-pink">🎂 ${idade ? idade + ' anos' : 'Aniversário'}</span></div>
                                    <span class="client-type type-${cliente.tipo}">${Utils.getTipoClienteText(cliente.tipo)}</span>
                                </div>
                                <div class="client-info">
                                    <div class="client-row"><i class="fas fa-phone"></i> ${cliente.telefone}</div>
                                    ${cliente.email ? `<div class="client-row"><i class="fas fa-envelope"></i> ${cliente.email}</div>` : ''}
                                    ${cliente.dataNascimento ? `<div class="client-row"><i class="fas fa-birthday-cake"></i> ${Utils.formatDate(cliente.dataNascimento)}</div>` : ''}
                                </div>
                                <div class="client-actions">
                                    <button class="btn-whatsapp-client" onclick="event.stopPropagation(); App.cliente.whatsapp('${cliente.id}')">
                                        <i class="fab fa-whatsapp"></i> Parabéns!
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                    badge.style.display = 'inline-block';
                    badge.innerText = aniversariantes.length.toString();
                    
                    // Mostrar alerta se houver aniversariantes
                    if (aniversariantes.length > 0) {
                        const nomes = aniversariantes.map(c => c.nome.split(' ')[0]).join(', ');
                        setTimeout(() => {
                            Utils.toast(`🎂 Hoje é aniversário de: ${nomes}`, 'success');
                        }, 1000);
                    }
                }
            },

            createVisitaCard: (v) => {
                const cliente = UI.data.clientes.find(c => c.id === v.clienteId) || { nome: 'Cliente não encontrado' };
                const imovel = UI.data.imoveis.find(i => i.id === v.imovelId) || { titulo: 'Imóvel não especificado' };
                
                const isUrgent = v.status === 'agendado' && v.data === Utils.getToday();
                const tipoClass = v.tipo || 'visita';
                
                let additionalInfo = '';
                if(v.tipo === 'plantao' && v.detalhesPlantoes) {
                    additionalInfo = `<div class="plantoes-summary">${v.detalhesPlantoes.substring(0, 60)}${v.detalhesPlantoes.length > 60 ? '...' : ''}</div>`;
                } else if(v.tipo === 'reuniao-construtor' && v.construtorNome) {
                    additionalInfo = `<div class="schedule-notes">Com: ${v.construtorNome}</div>`;
                } else if(v.tipo === 'reuniao-equipe' && v.equipeTipo) {
                    additionalInfo = `<div class="schedule-notes">${v.equipeTipo}</div>`;
                } else if(v.tipo === 'generico' && v.genericoTitulo) {
                    additionalInfo = `<div class="schedule-notes">${v.genericoTitulo}</div>`;
                }
                
                return `
                    <div class="schedule-card ${tipoClass} ${isUrgent ? 'schedule-urgent' : ''}" onclick="UI.showVisitaDetails('${v.id}')">
                        <div class="schedule-header">
                            <div class="schedule-type ${tipoClass}">${Utils.getTipoVisitaText(v.tipo)}</div>
                            <span class="badge ${v.status === 'realizado' ? 'badge-success' : v.status === 'cancelado' ? 'badge-danger' : v.status === 'confirmado' ? 'badge-cyan' : 'badge-primary'}">
                                ${Utils.getStatusVisitaText(v.status)}
                            </span>
                        </div>
                        <div class="schedule-time">
                            <i class="far fa-calendar"></i> ${Utils.formatDate(v.data)} <i class="far fa-clock"></i> ${v.horario}
                        </div>
                        <div class="schedule-title">
                            ${v.tipo === 'visita' ? cliente.nome : 
                              v.tipo === 'reuniao-construtor' ? (v.construtorNome || 'Reunião Construtor') :
                              v.tipo === 'reuniao-equipe' ? 'Reunião de Equipe' :
                              v.tipo === 'plantao' ? 'PLANTÃO' :
                              v.tipo === 'generico' ? (v.genericoTitulo || 'Agendamento Genérico') :
                              v.tipo === 'outro' ? (v.outroDescricao || 'Outro') :
                              'Agendamento'}
                        </div>
                        ${additionalInfo}
                        <div class="schedule-notes">
                            ${v.tipo === 'visita' ? `Visita: ${imovel.titulo.substring(0, 30)}...` : 
                             v.observacoes ? v.observacoes.substring(0, 50) + (v.observacoes.length > 50 ? '...' : '') : ''}
                        </div>
                    </div>
                `;
            },

            createNegociacaoCard: (i) => {
                const preco = i.precoVenda ? Utils.formatCurrency(i.precoVenda) : Utils.formatCurrency(i.precoAluguel) + '/mês';
                
                return `
                    <div class="property-card" onclick="UI.showImovelDetails('${i.id}')">
                        <div class="property-image">
                            ${i.imagens && i.imagens.length > 0 ? 
                                `<img src="${i.imagens[0]}" style="width:100%;height:100%;object-fit:cover; cursor: pointer;" onclick="event.stopPropagation(); UI.openFullscreen('${i.id}', 0)">` : 
                                `<i class="fas fa-home" style="font-size:3rem;"></i>`
                            }
                            <div class="property-badge badge-warning">RESERVADO</div>
                        </div>
                        <div class="property-content">
                            <div class="property-title">${i.titulo}</div>
                            <div class="property-address">
                                <i class="fas fa-map-marker-alt"></i> ${i.endereco.substring(0, 40)}...
                            </div>
                            <div class="property-price">${preco}</div>
                        </div>
                    </div>
                `;
            },

            renderClientes: (filter = '') => {
                const list = document.getElementById('clientes-list');
                let filtered = UI.data.clientes;
                
                if(filter) {
                    filtered = filtered.filter(c => 
                        c.nome.toLowerCase().includes(filter.toLowerCase()) ||
                        c.email.toLowerCase().includes(filter.toLowerCase()) ||
                        c.telefone.toLowerCase().includes(filter.toLowerCase())
                    );
                }
                
                if(filtered.length === 0) {
                    list.innerHTML = `<div class="empty-state"><i class="fas fa-user-plus"></i><p>Nenhum cliente encontrado.</p></div>`;
                    return;
                }

                list.innerHTML = filtered.map(c => {
                    const hoje = new Date();
                    const nascimento = c.dataNascimento ? new Date(c.dataNascimento) : null;
                    const isAniversario = nascimento && 
                                         nascimento.getDate() === hoje.getDate() && 
                                         (nascimento.getMonth() + 1) === (hoje.getMonth() + 1);
                    
                    const idade = Utils.calculateAge(c.dataNascimento);
                    const imovelInteresse = c.imovelInteresseId ? 
                        UI.data.imoveis.find(i => i.id === c.imovelInteresseId) : null;
                    
                    // Obter etapa do funil
                    const etapa = UI.data.funilEtapas.find(e => e.id === c.etapaFunil) || UI.data.funilEtapas[0];
                    
                    return `
                        <div class="client-card" onclick="UI.showClienteDetails('${c.id}')">
                            ${isAniversario ? `<div class="property-badge badge-pink" style="top: 12px; right: 12px; left: auto;">🎂</div>` : ''}
                            <div class="whatsapp-quick" onclick="event.stopPropagation(); App.cliente.whatsapp('${c.id}')">
                                <i class="fab fa-whatsapp"></i>
                            </div>
                            <div class="client-header">
                                <div class="client-name">${c.nome} ${idade ? `(${idade} anos)` : ''}</div>
                                <span class="client-type" style="background: ${etapa.cor}; color: white;">${etapa.nome}</span>
                            </div>
                            <div class="client-info">
                                <div class="client-row"><i class="fas fa-phone"></i> ${c.telefone}</div>
                                ${c.email ? `<div class="client-row"><i class="fas fa-envelope"></i> ${c.email}</div>` : ''}
                                ${c.dataNascimento ? `<div class="client-row"><i class="fas fa-birthday-cake"></i> ${Utils.formatDate(c.dataNascimento)}</div>` : ''}
                                ${imovelInteresse ? `<div class="client-row"><i class="fas fa-home"></i> Interesse: ${imovelInteresse.titulo.substring(0, 30)}...</div>` : ''}
                                ${c.faixaPreco ? `<div class="client-row"><i class="fas fa-search-dollar"></i> ${c.faixaPreco}</div>` : ''}
                                <div class="client-row"><i class="fas fa-filter"></i> Funil: ${etapa.nome} (${c.dataEntradaFunil ? Utils.calculateDaysInStage(c.dataEntradaFunil) : '0'} dias)</div>
                            </div>
                            <div class="client-actions">
                                <button class="btn-whatsapp-client" onclick="event.stopPropagation(); App.cliente.whatsapp('${c.id}')">
                                    <i class="fab fa-whatsapp"></i> WhatsApp
                                </button>
                                <button class="btn-sm btn-light" onclick="event.stopPropagation(); App.cliente.edit('${c.id}')">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            renderImoveis: (filter = '', tipoFilter = '', statusFilter = '') => {
                const list = document.getElementById('imoveis-list');
                let filtered = UI.data.imoveis;
                
                // Aplicar filtros
                if(filter) {
                    filtered = filtered.filter(i => 
                        i.titulo.toLowerCase().includes(filter.toLowerCase()) ||
                        i.endereco.toLowerCase().includes(filter.toLowerCase()) ||
                        i.construtora?.toLowerCase().includes(filter.toLowerCase())
                    );
                }
                
                if(tipoFilter) {
                    filtered = filtered.filter(i => i.tipo === tipoFilter);
                }
                
                if(statusFilter) {
                    filtered = filtered.filter(i => i.status === statusFilter);
                }
                
                // Ordenar por data de criação (mais recentes primeiro)
                filtered.sort((a,b) => new Date(b.dataCriacao) - new Date(a.dataCriacao));

                if(filtered.length === 0) {
                    list.innerHTML = `<div class="empty-state"><i class="fas fa-home"></i><p>Nenhum imóvel encontrado.</p></div>`;
                    return;
                }

                list.innerHTML = filtered.map(i => UI.createImovelCard(i)).join('');
            },

            filterImoveis: (tipo, status) => {
                UI.renderImoveis(document.querySelector('.search-input').value, tipo, status);
            },

            createImovelCard: (i) => {
                let badgeClass = 'badge-sale';
                let badgeText = 'VENDA';
                
                if(i.transacao === 'aluguel') {
                    badgeClass = 'badge-rent';
                    badgeText = 'ALUGUEL';
                } else if(i.transacao === 'ambos') {
                    badgeClass = 'badge-featured';
                    badgeText = 'VENDA/ALUG';
                }
                
                if(i.status === 'vendido' || i.status === 'alugado') {
                    badgeClass = 'badge-success';
                    badgeText = i.status === 'vendido' ? 'VENDIDO' : 'ALUGADO';
                } else if(i.status === 'reservado') {
                    badgeClass = 'badge-warning';
                    badgeText = 'RESERVADO';
                }
                
                const preco = i.precoVenda ? 
                    Utils.formatCurrency(i.precoVenda) : 
                    Utils.formatCurrency(i.precoAluguel) + ' <span class="period">/mês</span>';
                
                const mainImageClick = i.imagens && i.imagens.length > 0 ? 
                    `onclick="event.stopPropagation(); UI.openFullscreen('${i.id}', 0)"` : '';
                
                return `
                    <div class="property-card" onclick="UI.showImovelDetails('${i.id}')">
                        <div class="property-image">
                            ${i.imagens && i.imagens.length > 0 ? 
                                `<img src="${i.imagens[0]}" style="width:100%;height:100%;object-fit:cover; cursor: pointer;" ${mainImageClick}>` : 
                                `<i class="fas fa-home" style="font-size:3rem;"></i>`
                            }
                            <div class="property-badge ${badgeClass}">${badgeText}</div>
                        </div>
                        <div class="property-content">
                            <div class="property-title">${i.titulo}</div>
                            <div class="property-address">
                                <i class="fas fa-map-marker-alt"></i> ${i.endereco.substring(0, 40)}...
                            </div>
                            <div class="property-features">
                                <div class="feature">
                                    <i class="fas fa-bed"></i>
                                    <span>${i.quartos || 0} quarto${i.quartos !== 1 ? 's' : ''}</span>
                                </div>
                                <div class="feature">
                                    <i class="fas fa-bath"></i>
                                    <span>${i.banheiros || 0} banheiro${i.banheiros !== 1 ? 's' : ''}</span>
                                </div>
                                <div class="feature">
                                    <i class="fas fa-car"></i>
                                    <span>${i.vagas || 0} vaga${i.vagas !== 1 ? 's' : ''}</span>
                                </div>
                                <div class="feature">
                                    <i class="fas fa-ruler-combined"></i>
                                    <span>${i.area || 0}m²</span>
                                </div>
                            </div>
                            <div class="property-price">${preco}</div>
                            <div class="property-actions">
                                <button class="btn-sm btn-light" onclick="event.stopPropagation(); App.imovel.edit('${i.id}')">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                                <button class="btn-sm btn-primary-soft" onclick="event.stopPropagation(); UI.openNewVisitaFromImovel('${i.id}')">
                                    <i class="fas fa-calendar-plus"></i> Visita
                                </button>
                                <button class="btn-sm btn-whatsapp" onclick="event.stopPropagation(); App.whatsapp.shareImovel('${i.id}')">
                                    <i class="fab fa-whatsapp"></i> Compartilhar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            },

            showImovelDetails: (id) => {
                const i = UI.data.imoveis.find(x => x.id === id);
                if(!i) return;
                
                let statusBadge = '';
                if(i.status === 'disponivel') statusBadge = `<span class="badge badge-success">DISPONÍVEL</span>`;
                if(i.status === 'reservado') statusBadge = `<span class="badge badge-warning">RESERVADO</span>`;
                if(i.status === 'vendido') statusBadge = `<span class="badge badge-primary">VENDIDO</span>`;
                if(i.status === 'alugado') statusBadge = `<span class="badge badge-primary">ALUGADO</span>`;
                
                const precoVenda = i.precoVenda ? Utils.formatCurrency(i.precoVenda) : '-';
                const precoAluguel = i.precoAluguel ? Utils.formatCurrency(i.precoAluguel) + '/mês' : '-';
                const condominio = i.condominio ? Utils.formatCurrency(i.condominio) + '/mês' : '-';
                const dataEntrega = i.dataEntrega ? Utils.formatDate(i.dataEntrega) : '-';
                const gasEncanado = i.gasEncanado === 'sim' ? 'Sim' : 'Não';
                
                // Carousel para múltiplas imagens
                let carouselHTML = '';
                if(i.imagens && i.imagens.length > 0) {
                    UI.currentCarouselImages = i.imagens;
                    UI.currentCarouselIndex = 0;
                    
                    carouselHTML = `
                        <div class="carousel-container">
                            ${i.imagens.map((img, index) => `
                                <img src="${img}" class="carousel-slide ${index === 0 ? 'active' : ''}" id="slide-${index}" onclick="UI.openFullscreen('${i.id}', ${index})">
                            `).join('')}
                            
                            ${i.imagens.length > 1 ? `
                                <button class="carousel-arrow prev" onclick="UI.prevSlide()">‹</button>
                                <button class="carousel-arrow next" onclick="UI.nextSlide()">›</button>
                                <div class="carousel-nav">
                                    ${i.imagens.map((_, index) => `
                                        <div class="carousel-dot ${index === 0 ? 'active' : ''}" onclick="UI.goToSlide(${index})"></div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
                
                const detailsContent = `
                    <div class="details-card">
                        <div class="details-header">
                            <div class="details-title">${i.titulo}</div>
                            ${statusBadge}
                        </div>
                        
                        ${carouselHTML}
                        
                        <div class="details-section">
                            <div class="details-section-title"><i class="fas fa-money-bill-wave"></i> VALORES</div>
                            <div class="details-info-grid">
                                <div class="info-item">
                                    <div class="info-label">Preço de Venda</div>
                                    <div class="info-value">${precoVenda}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Preço de Aluguel</div>
                                    <div class="info-value">${precoAluguel}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Condomínio</div>
                                    <div class="info-value">${condominio}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Transação</div>
                                    <div class="info-value">${i.transacao === 'venda' ? 'Venda' : i.transacao === 'aluguel' ? 'Aluguel' : 'Venda/Aluguel'}</div>
                                </div>
                                ${i.dataVenda ? `
                                <div class="info-item">
                                    <div class="info-label">Data da Venda</div>
                                    <div class="info-value">${Utils.formatDate(i.dataVenda)}</div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="details-section">
                            <div class="details-section-title"><i class="fas fa-info-circle"></i> INFORMAÇÕES DO IMÓVEL</div>
                            <div class="details-info-grid">
                                <div class="info-item">
                                    <div class="info-label">Tipo</div>
                                    <div class="info-value">${Utils.getTipoText(i.tipo)}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Área</div>
                                    <div class="info-value">${i.area || 0}m²</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Quartos</div>
                                    <div class="info-value">${i.quartos || 0}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Banheiros</div>
                                    <div class="info-value">${i.banheiros || 0}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Vagas</div>
                                    <div class="info-value">${i.vagas || 0}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Status</div>
                                    <div class="info-value">${Utils.getStatusText(i.status)}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="details-section">
                            <div class="details-section-title"><i class="fas fa-building"></i> INFORMAÇÕES ADICIONAIS</div>
                            <div class="details-info-grid">
                                ${i.dataEntrega ? `
                                <div class="info-item">
                                    <div class="info-label">Data de Entrega</div>
                                    <div class="info-value">${dataEntrega}</div>
                                </div>
                                ` : ''}
                                ${i.construtora ? `
                                <div class="info-item">
                                    <div class="info-label">Construtora</div>
                                    <div class="info-value">${i.construtora}</div>
                                </div>
                                ` : ''}
                                ${i.formaPagamento ? `
                                <div class="info-item">
                                    <div class="info-label">Forma de Pagamento</div>
                                    <div class="info-value">${i.formaPagamento}</div>
                                </div>
                                ` : ''}
                                <div class="info-item">
                                    <div class="info-label">Gás Encanado</div>
                                    <div class="info-value">${gasEncanado}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="details-section">
                            <div class="details-section-title"><i class="fas fa-map-marker-alt"></i> LOCALIZAÇÃO</div>
                            <div class="info-item">
                                <div class="info-label">Endereço</div>
                                <div class="info-value">${i.endereco}</div>
                            </div>
                        </div>
                        
                        <div class="details-section">
                            <div class="details-section-title"><i class="fas fa-align-left"></i> DESCRIÇÃO</div>
                            <div class="info-item">
                                <div class="info-label">Detalhes</div>
                                <div class="info-value">${i.descricao || 'Sem descrição'}</div>
                            </div>
                        </div>
                        
                        ${i.observacoes ? `
                        <div class="details-section">
                            <div class="details-section-title"><i class="fas fa-eye-slash"></i> OBSERVAÇÕES INTERNAS</div>
                            <div class="info-item">
                                <div class="info-label">Anotações</div>
                                <div class="info-value">${i.observacoes}</div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="warning-note">
                            <i class="fas fa-exclamation-triangle"></i> Os valores informados podem sofrer alteração sem aviso prévio.
                        </div>
                        
                        <div class="details-actions">
                            <button class="btn-details btn-details-primary" onclick="App.imovel.edit('${i.id}')">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button class="btn-details btn-details-whatsapp" onclick="App.whatsapp.shareImovel('${i.id}')">
                                <i class="fab fa-whatsapp"></i> WhatsApp
                            </button>
                            <button class="btn-details btn-details-secondary" onclick="UI.openNewVisitaFromImovel('${i.id}')">
                                <i class="fas fa-calendar-plus"></i> Agendar Visita
                            </button>
                            <button class="btn-details btn-pdf" onclick="Utils.generatePDF(${JSON.stringify(i).replace(/"/g, '&quot;')})">
                                <i class="fas fa-file-pdf"></i> PDF
                            </button>
                        </div>
                    </div>
                    <button class="btn-block" style="background: var(--light); color: var(--secondary); margin-top: 8px;" onclick="UI.closeModals()">Fechar</button>
                `;
                
                document.getElementById('imovel-details-content').innerHTML = detailsContent;
                UI.openModal('imovel-details');
            },

            // Funções do carousel
            nextSlide: () => {
                if(UI.currentCarouselImages.length <= 1) return;
                UI.currentCarouselIndex = (UI.currentCarouselIndex + 1) % UI.currentCarouselImages.length;
                UI.updateCarousel();
            },

            prevSlide: () => {
                if(UI.currentCarouselImages.length <= 1) return;
                UI.currentCarouselIndex = (UI.currentCarouselIndex - 1 + UI.currentCarouselImages.length) % UI.currentCarouselImages.length;
                UI.updateCarousel();
            },

            goToSlide: (index) => {
                UI.currentCarouselIndex = index;
                UI.updateCarousel();
            },

            updateCarousel: () => {
                document.querySelectorAll('.carousel-slide').forEach((slide, index) => {
                    slide.classList.toggle('active', index === UI.currentCarouselIndex);
                });
                document.querySelectorAll('.carousel-dot').forEach((dot, index) => {
                    dot.classList.toggle('active', index === UI.currentCarouselIndex);
                });
            },

            // Funções do visualizador em tela cheia
            openFullscreen: (imovelId, imageIndex) => {
                const imovel = UI.data.imoveis.find(x => x.id === imovelId);
                if(!imovel || !imovel.imagens || imovel.imagens.length === 0) return;
                
                UI.fullscreenImages = imovel.imagens;
                UI.fullscreenCurrentIndex = imageIndex;
                
                // Atualizar imagem atual - AGORA OCUPA TELA INTEIRA
                const fullscreenImage = document.getElementById('fullscreen-current-image');
                fullscreenImage.src = UI.fullscreenImages[UI.fullscreenCurrentIndex];
                fullscreenImage.className = 'image-fullscreen';
                
                // Atualizar contador
                document.getElementById('fullscreen-counter').textContent = UI.fullscreenCurrentIndex + 1;
                document.getElementById('fullscreen-total').textContent = UI.fullscreenImages.length;
                
                // Atualizar miniaturas
                const thumbnailsContainer = document.getElementById('fullscreen-thumbnails');
                thumbnailsContainer.innerHTML = '';
                
                UI.fullscreenImages.forEach((img, index) => {
                    const thumbnail = document.createElement('div');
                    thumbnail.className = `fullscreen-thumbnail ${index === UI.fullscreenCurrentIndex ? 'active' : ''}`;
                    thumbnail.onclick = () => UI.goToFullscreenImage(index);
                    
                    const thumbnailImg = document.createElement('img');
                    thumbnailImg.src = img;
                    thumbnail.appendChild(thumbnailImg);
                    
                    thumbnailsContainer.appendChild(thumbnail);
                });
                
                // Abrir visualizador
                document.getElementById('fullscreen-viewer').classList.add('active');
                
                // Adicionar listener para teclado
                document.addEventListener('keydown', UI.handleFullscreenKeyboard);
            },

            closeFullscreen: () => {
                document.getElementById('fullscreen-viewer').classList.remove('active');
                UI.fullscreenImages = [];
                UI.fullscreenCurrentIndex = 0;
                
                // Restaurar classe original da imagem
                document.getElementById('fullscreen-current-image').className = 'fullscreen-image';
                
                // Remover listener do teclado
                document.removeEventListener('keydown', UI.handleFullscreenKeyboard);
            },

            nextFullscreenImage: () => {
                if(UI.fullscreenImages.length <= 1) return;
                UI.fullscreenCurrentIndex = (UI.fullscreenCurrentIndex + 1) % UI.fullscreenImages.length;
                UI.updateFullscreenViewer();
            },

            prevFullscreenImage: () => {
                if(UI.fullscreenImages.length <= 1) return;
                UI.fullscreenCurrentIndex = (UI.fullscreenCurrentIndex - 1 + UI.fullscreenImages.length) % UI.fullscreenImages.length;
                UI.updateFullscreenViewer();
            },

            goToFullscreenImage: (index) => {
                UI.fullscreenCurrentIndex = index;
                UI.updateFullscreenViewer();
            },

            updateFullscreenViewer: () => {
                // Atualizar imagem
                const fullscreenImage = document.getElementById('fullscreen-current-image');
                fullscreenImage.src = UI.fullscreenImages[UI.fullscreenCurrentIndex];
                fullscreenImage.className = 'image-fullscreen';
                
                // Atualizar contador
                document.getElementById('fullscreen-counter').textContent = UI.fullscreenCurrentIndex + 1;
                
                // Atualizar miniaturas ativas
                document.querySelectorAll('.fullscreen-thumbnail').forEach((thumb, index) => {
                    thumb.classList.toggle('active', index === UI.fullscreenCurrentIndex);
                });
            },

            handleFullscreenKeyboard: (e) => {
                if(!document.getElementById('fullscreen-viewer').classList.contains('active')) return;
                
                switch(e.key) {
                    case 'Escape':
                        UI.closeFullscreen();
                        break;
                    case 'ArrowLeft':
                        UI.prevFullscreenImage();
                        break;
                    case 'ArrowRight':
                        UI.nextFullscreenImage();
                        break;
                }
            },

            showClienteDetails: (id) => {
                const c = UI.data.clientes.find(x => x.id === id);
                if(!c) return;
                
                App.cliente.edit(id);
            },

            showVisitaDetails: (id) => {
                const v = UI.data.visitas.find(x => x.id === id);
                if(!v) return;
                
                // Se for plantão, mostrar detalhes específicos
                if(v.tipo === 'plantao' || v.tipo === 'reuniao-construtor' || v.tipo === 'reuniao-equipe' || v.tipo === 'generico') {
                    let detalhesHTML = `
                        <div class="details-card">
                            <div class="details-header">
                                <div class="details-title">${Utils.getTipoVisitaText(v.tipo).toUpperCase()} - ${Utils.formatDate(v.data)} ${v.horario}</div>
                                <span class="badge ${v.status === 'realizado' ? 'badge-success' : v.status === 'cancelado' ? 'badge-danger' : v.status === 'confirmado' ? 'badge-cyan' : 'badge-primary'}">
                                    ${Utils.getStatusVisitaText(v.status)}
                                </span>
                            </div>
                    `;
                    
                    // Detalhes específicos por tipo
                    switch(v.tipo) {
                        case 'plantao':
                            if(v.plantaoLocal) {
                                detalhesHTML += `
                                    <div class="details-section">
                                        <div class="details-section-title"><i class="fas fa-map-marker-alt"></i> LOCAL DO PLANTÃO</div>
                                        <div class="info-item">
                                            <div class="info-label">Endereço</div>
                                            <div class="info-value">${v.plantaoLocal}</div>
                                        </div>
                                    </div>
                                `;
                            }
                            
                            if(v.detalhesPlantoes) {
                                detalhesHTML += `
                                    <div class="details-section">
                                        <div class="details-section-title"><i class="fas fa-clipboard-list"></i> DETALHES DO PLANTÃO</div>
                                        <div class="info-item">
                                            <div class="info-label">Atividades</div>
                                            <div class="info-value">${v.detalhesPlantoes}</div>
                                        </div>
                                    </div>
                                `;
                            }
                            
                            if(v.clientesAtendidos) {
                                const clientes = v.clientesAtendidos.split('\n').filter(c => c.trim());
                                detalhesHTML += `
                                    <div class="details-section">
                                        <div class="details-section-title"><i class="fas fa-users"></i> CLIENTES ATENDIDOS (${clientes.length})</div>
                                        <div class="plantoes-info">
                                            ${clientes.map(cliente => `
                                                <div class="client-item">
                                                    <div class="client-name">${cliente.split(' - ')[0] || cliente}</div>
                                                    ${cliente.includes(' - ') ? `<div class="client-situation">${cliente.split(' - ').slice(1).join(' - ')}</div>` : ''}
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `;
                            }
                            
                            if(v.negociosGerados) {
                                detalhesHTML += `
                                    <div class="details-section">
                                        <div class="details-section-title"><i class="fas fa-handshake"></i> NEGÓCIOS GERADOS</div>
                                        <div class="info-item">
                                            <div class="info-label">Resultados</div>
                                            <div class="info-value">${v.negociosGerados}</div>
                                        </div>
                                    </div>
                                `;
                            }
                            break;
                            
                        case 'reuniao-construtor':
                            if(v.construtorNome) {
                                detalhesHTML += `
                                    <div class="details-section">
                                        <div class="details-section-title"><i class="fas fa-building"></i> CONSTRUTOR/INCORPORADORA</div>
                                        <div class="info-item">
                                            <div class="info-label">Nome</div>
                                            <div class="info-value">${v.construtorNome}</div>
                                        </div>
                                    </div>
                                `;
                            }
                            
                            if(v.construtorEmpreendimento) {
                                detalhesHTML += `
                                    <div class="details-section">
                                        <div class="details-section-title"><i class="fas fa-home"></i> EMPREENDIMENTO</div>
                                        <div class="info-item">
                                            <div class="info-label">Nome do Lançamento</div>
                                            <div class="info-value">${v.construtorEmpreendimento}</div>
                                        </div>
                                    </div>
                                `;
                            }
                            
                            if(v.construtorAssuntos) {
                                detalhesHTML += `
                                    <div class="details-section">
                                        <div class="details-section-title"><i class="fas fa-clipboard-list"></i> ASSUNTOS DA REUNIÃO</div>
                                        <div class="info-item">
                                            <div class="info-label">Tópicos Discutidos</div>
                                            <div class="info-value">${v.construtorAssuntos}</div>
                                        </div>
                                    </div>
                                `;
                            }
                            break;
                            
                        case 'reuniao-equipe':
                            if(v.equipeTipo) {
                                detalhesHTML += `
                                    <div class="details-section">
                                        <div class="details-section-title"><i class="fas fa-users"></i> TIPO DE REUNIÃO</div>
                                        <div class="info-item">
                                            <div class="info-label">Categoria</div>
                                            <div class="info-value">${v.equipeTipo}</div>
                                        </div>
                                    </div>
                                `;
                            }
                            
                            if(v.equipeParticipantes) {
                                detalhesHTML += `
                                    <div class="details-section">
                                        <div class="details-section-title"><i class="fas fa-user-friends"></i> PARTICIPANTES</div>
                                        <div class="info-item">
                                            <div class="info-label">Integrantes</div>
                                            <div class="info-value">${v.equipeParticipantes}</div>
                                        </div>
                                    </div>
                                `;
                            }
                            
                            if(v.equipeAssuntos) {
                                detalhesHTML += `
                                    <div class="details-section">
                                        <div class="details-section-title"><i class="fas fa-list-alt"></i> PAUTA/ASSUNTOS</div>
                                        <div class="info-item">
                                            <div class="info-label">Tópicos</div>
                                            <div class="info-value">${v.equipeAssuntos}</div>
                                        </div>
                                    </div>
                                `;
                            }
                            break;
                            
                        case 'generico':
                            if(v.genericoTitulo) {
                                detalhesHTML += `
                                    <div class="details-section">
                                        <div class="details-section-title"><i class="fas fa-heading"></i> TÍTULO</div>
                                        <div class="info-item">
                                            <div class="info-label">Descrição</div>
                                            <div class="info-value">${v.genericoTitulo}</div>
                                        </div>
                                    </div>
                                `;
                            }
                            
                            if(v.genericoLocal) {
                                detalhesHTML += `
                                    <div class="details-section">
                                        <div class="details-section-title"><i class="fas fa-map-marker-alt"></i> LOCAL</div>
                                        <div class="info-item">
                                            <div class="info-label">Endereço/Local</div>
                                            <div class="info-value">${v.genericoLocal}</div>
                                        </div>
                                    </div>
                                `;
                            }
                            
                            if(v.genericoDescricao) {
                                detalhesHTML += `
                                    <div class="details-section">
                                        <div class="details-section-title"><i class="fas fa-align-left"></i> DESCRIÇÃO DETALHADA</div>
                                        <div class="info-item">
                                            <div class="info-label">Detalhes</div>
                                            <div class="info-value">${v.genericoDescricao}</div>
                                        </div>
                                    </div>
                                `;
                            }
                            break;
                    }
                    
                    // Observações gerais
                    if(v.observacoes) {
                        detalhesHTML += `
                            <div class="details-section">
                                <div class="details-section-title"><i class="fas fa-sticky-note"></i> OBSERVAÇÕES GERAIS</div>
                                <div class="info-item">
                                    <div class="info-label">Anotações</div>
                                    <div class="info-value">${v.observacoes}</div>
                                </div>
                            </div>
                        `;
                    }
                    
                    detalhesHTML += `
                            <div class="details-actions">
                                <button class="btn-details btn-details-primary" onclick="App.agenda.edit('${v.id}')">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                                <button class="btn-details btn-details-secondary" onclick="UI.closeModals()">
                                    <i class="fas fa-times"></i> Fechar
                                </button>
                            </div>
                        </div>
                        <button class="btn-block" style="background: var(--light); color: var(--secondary); margin-top: 8px;" onclick="UI.closeModals()">Fechar</button>
                    `;
                    
                    document.getElementById('imovel-details-content').innerHTML = detalhesHTML;
                    UI.openModal('imovel-details');
                } else {
                    App.agenda.edit(id);
                }
            },

            renderAgenda: (filterType = null) => {
                const list = document.getElementById('agenda-list');
                const hoje = Utils.getToday();
                
                // Aplicar filtro
                let visitasFiltradas = UI.data.visitas;
                if(filterType && filterType !== 'todos') {
                    visitasFiltradas = visitasFiltradas.filter(v => v.tipo === filterType);
                }
                
                // Visitas futuras (a partir de hoje)
                const visitasFuturas = visitasFiltradas.filter(v => 
                    v.data >= hoje && v.status !== 'cancelado'
                ).sort((a,b) => {
                    if(a.data === b.data) return a.horario.localeCompare(b.horario);
                    return a.data.localeCompare(b.data);
                });
                
                if(visitasFuturas.length === 0) {
                    const filterText = filterType && filterType !== 'todos' ? ` de ${Utils.getTipoVisitaText(filterType).toLowerCase()}` : '';
                    list.innerHTML = `<div class="empty-state"><i class="fas fa-calendar-alt"></i><p>Nenhum agendamento${filterText} encontrado!</p></div>`;
                    return;
                }

                // Agrupar por data
                const visitasPorData = {};
                visitasFuturas.forEach(v => {
                    if(!visitasPorData[v.data]) visitasPorData[v.data] = [];
                    visitasPorData[v.data].push(v);
                });

                let html = '';
                Object.keys(visitasPorData).sort().forEach(data => {
                    const dataFormatada = Utils.formatDate(data);
                    const isToday = Utils.isToday(data);
                    
                    html += `<div class="section-title" style="margin-top: 20px;">${dataFormatada} ${isToday ? '<span class="badge badge-primary">HOJE</span>' : ''}</div>`;
                    
                    visitasPorData[data].forEach(v => {
                        html += UI.createVisitaCard(v);
                    });
                });
                
                list.innerHTML = html;
            },

            filterAgenda: (type) => {
                // Atualizar filtros ativos
                document.querySelectorAll('.filter-chip').forEach(chip => {
                    chip.classList.remove('active');
                });
                
                const activeChip = document.querySelector(`.filter-chip[data-type="${type}"]`);
                if(activeChip) {
                    activeChip.classList.add('active');
                }
                
                UI.currentAgendaFilter = type;
                UI.renderAgenda(type === 'todos' ? null : type);
            },

            renderRelatorios: () => {
                const imoveis = UI.data.imoveis;
                const visitas = UI.data.visitas;
                const hoje = new Date();
                const mesAtual = hoje.getMonth();
                const anoAtual = hoje.getFullYear();
                
                // Imóveis vendidos/alugados este mês
                const transacoesMes = imoveis.filter(i => 
                    (i.status === 'vendido' || i.status === 'alugado') &&
                    i.dataVenda
                ).filter(i => {
                    const dataVenda = new Date(i.dataVenda);
                    return dataVenda.getMonth() === mesAtual && dataVenda.getFullYear() === anoAtual;
                });
                
                const totalVendas = transacoesMes.filter(i => i.status === 'vendido')
                    .reduce((acc, i) => acc + (i.precoVenda || 0), 0);
                
                const totalAlugueis = transacoesMes.filter(i => i.status === 'alugado')
                    .reduce((acc, i) => acc + (i.precoAluguel || 0), 0);
                
                // Configurações para cálculo de comissão
                const settings = Storage.getSettings();
                const taxaComissao = settings.comissao || 5;
                const comissaoVendas = (totalVendas * taxaComissao) / 100;
                const comissaoAlugueis = (totalAlugueis * taxaComissao) / 100;
                const comissaoTotal = comissaoVendas + comissaoAlugueis;
                
                // Taxa de conversão
                const imoveisDisponiveis = imoveis.filter(i => i.status === 'disponivel').length;
                const imoveisVendidosAlugados = imoveis.filter(i => i.status === 'vendido' || i.status === 'alugado').length;
                const totalImoveis = imoveis.length;
                const taxaConversao = totalImoveis > 0 ? ((imoveisVendidosAlugados / totalImoveis) * 100).toFixed(1) : 0;
                
                // Atualizar UI
                document.getElementById('rel-vendas-mes').innerText = Utils.formatCurrency(totalVendas);
                document.getElementById('rel-alugueis-mes').innerText = Utils.formatCurrency(totalAlugueis);
                document.getElementById('rel-comissao').innerText = Utils.formatCurrency(comissaoTotal);
                document.getElementById('rel-conversao').innerText = `${taxaConversao}%`;
                
                // Renderizar gráfico principal
                UI.renderChart();
                
                // Renderizar relatório de agendamentos
                UI.renderAgendaReport();
            },

            renderChart: () => {
                const ctx = document.getElementById('performanceChart').getContext('2d');
                const imoveis = UI.data.imoveis;
                
                // Agrupar por mês
                const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
                const hoje = new Date();
                const anoAtual = hoje.getFullYear();
                
                const dadosVendas = new Array(12).fill(0);
                const dadosAlugueis = new Array(12).fill(0);
                
                imoveis.filter(i => i.dataVenda).forEach(i => {
                    const data = new Date(i.dataVenda);
                    if(data.getFullYear() === anoAtual) {
                        const mes = data.getMonth();
                        if(i.status === 'vendido') {
                            dadosVendas[mes] += (i.precoVenda || 0);
                        } else if(i.status === 'alugado') {
                            dadosAlugueis[mes] += (i.precoAluguel || 0);
                        }
                    }
                });
                
                if (UI.chartInstance) {
                    UI.chartInstance.destroy();
                }

                UI.chartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: meses,
                        datasets: [
                            {
                                label: 'Vendas',
                                data: dadosVendas,
                                backgroundColor: '#3b82f6',
                                borderRadius: 4,
                            },
                            {
                                label: 'Aluguéis',
                                data: dadosAlugueis,
                                backgroundColor: '#10b981',
                                borderRadius: 4,
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { 
                                display: true,
                                position: 'bottom',
                                labels: { boxWidth: 12, font: { size: 10 } }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) label += ': ';
                                        if (context.parsed.y !== null) {
                                            label += Utils.formatCurrency(context.parsed.y);
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { borderDash: [2, 4], color: '#e2e8f0' },
                                ticks: {
                                    callback: function(value) {
                                        if(value >= 1000000) return 'R$ ' + (value / 1000000).toFixed(1) + 'M';
                                        if(value >= 1000) return 'R$ ' + (value / 1000).toFixed(0) + 'k';
                                        return 'R$ ' + value;
                                    },
                                    font: { size: 10 }
                                }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { font: { size: 10 } }
                            }
                        }
                    }
                });
            },

            renderAgendaReport: () => {
                const visitas = UI.data.visitas;
                
                if(visitas.length === 0) {
                    document.getElementById('agenda-report').innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-calendar-alt" style="color: var(--primary);"></i>
                            <p>Nenhum agendamento registrado ainda.</p>
                        </div>
                    `;
                    
                    // Remover gráfico se não houver dados
                    const ctx = document.getElementById('agendaChart').getContext('2d');
                    if (UI.agendaChartInstance) {
                        UI.agendaChartInstance.destroy();
                    }
                    
                    // Criar gráfico vazio
                    UI.agendaChartInstance = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['Nenhum dado'],
                            datasets: [{
                                label: 'Agendamentos',
                                data: [0],
                                backgroundColor: '#2563eb',
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            }
                        }
                    });
                    
                    return;
                }

                // Agrupar agendamentos por tipo
                const tipos = ['visita', 'reuniao-construtor', 'reuniao-equipe', 'documentacao', 'plantao', 'generico', 'outro'];
                const contagemPorTipo = {};
                tipos.forEach(tipo => {
                    contagemPorTipo[tipo] = visitas.filter(v => v.tipo === tipo).length;
                });
                
                // Agrupar por mês
                const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
                const hoje = new Date();
                const anoAtual = hoje.getFullYear();
                
                const visitasPorMes = new Array(12).fill(0);
                
                visitas.forEach(v => {
                    if(v.data) {
                        const data = new Date(v.data);
                        if(data.getFullYear() === anoAtual) {
                            const mes = data.getMonth();
                            visitasPorMes[mes]++;
                        }
                    }
                });
                
                // Renderizar gráfico de agendamentos
                const ctx = document.getElementById('agendaChart').getContext('2d');
                if (UI.agendaChartInstance) {
                    UI.agendaChartInstance.destroy();
                }

                UI.agendaChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: meses,
                        datasets: [
                            {
                                label: 'Agendamentos',
                                data: visitasPorMes,
                                backgroundColor: '#2563eb',
                                borderRadius: 4,
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { 
                                display: true,
                                position: 'bottom',
                                labels: { boxWidth: 12, font: { size: 10 } }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { borderDash: [2, 4], color: '#e2e8f0' },
                                ticks: { font: { size: 10 } }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { font: { size: 10 } }
                            }
                        }
                    }
                });
                
                // Calcular estatísticas
                const totalAgendamentos = visitas.length;
                const realizados = visitas.filter(v => v.status === 'realizado').length;
                const cancelados = visitas.filter(v => v.status === 'cancelado').length;
                const confirmados = visitas.filter(v => v.status === 'confirmado').length;
                
                // Agendamentos mais recentes
                const agendamentosRecentes = visitas
                    .sort((a,b) => new Date(b.data) - new Date(a.data))
                    .slice(0, 5);
                
                // Renderizar relatório
                let html = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon bg-blue">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                            <div class="stat-value">${totalAgendamentos}</div>
                            <div class="stat-label">Total</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon bg-green">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="stat-value">${realizados}</div>
                            <div class="stat-label">Realizados</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon bg-red">
                                <i class="fas fa-times-circle"></i>
                            </div>
                            <div class="stat-value">${cancelados}</div>
                            <div class="stat-label">Cancelados</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon bg-cyan">
                                <i class="fas fa-check-double"></i>
                            </div>
                            <div class="stat-value">${confirmados}</div>
                            <div class="stat-label">Confirmados</div>
                        </div>
                    </div>
                    
                    <div class="section-title" style="margin-top: 20px;">Distribuição por Tipo</div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon" style="background: var(--type-visita, 0.1); color: var(--type-visita);">
                                <i class="fas fa-home"></i>
                            </div>
                            <div class="stat-value">${contagemPorTipo.visita}</div>
                            <div class="stat-label">Visitas</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="background: var(--type-reuniao-construtor, 0.1); color: var(--type-reuniao-construtor);">
                                <i class="fas fa-building"></i>
                            </div>
                            <div class="stat-value">${contagemPorTipo['reuniao-construtor']}</div>
                            <div class="stat-label">Reuniões Construtor</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="background: var(--type-reuniao-equipe, 0.1); color: var(--type-reuniao-equipe);">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-value">${contagemPorTipo['reuniao-equipe']}</div>
                            <div class="stat-label">Reuniões Equipe</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="background: var(--type-plantao, 0.1); color: var(--type-plantao);">
                                <i class="fas fa-calendar-check"></i>
                            </div>
                            <div class="stat-value">${contagemPorTipo.plantao}</div>
                            <div class="stat-label">Plantões</div>
                        </div>
                    </div>
                    
                    <div class="section-title" style="margin-top: 20px;">Agendamentos Recentes</div>
                `;
                
                if(agendamentosRecentes.length === 0) {
                    html += `<div class="empty-state"><i class="fas fa-calendar-alt"></i><p>Nenhum agendamento recente</p></div>`;
                } else {
                    agendamentosRecentes.forEach(v => {
                        html += UI.createVisitaCard(v);
                    });
                }
                
                document.getElementById('agenda-report').innerHTML = html;
            },

            generateAgendaReport: () => {
                const visitas = UI.data.visitas;
                
                if(visitas.length === 0) {
                    Utils.toast('Nenhum agendamento para gerar relatório', 'error');
                    return;
                }
                
                // Preparar dados para o PDF
                const agendaData = {
                    totalAgendamentos: visitas.length,
                    visitas: visitas.filter(v => v.tipo === 'visita').length,
                    reunioesConstrutor: visitas.filter(v => v.tipo === 'reuniao-construtor').length,
                    reunioesEquipe: visitas.filter(v => v.tipo === 'reuniao-equipe').length,
                    documentacao: visitas.filter(v => v.tipo === 'documentacao').length,
                    plantoes: visitas.filter(v => v.tipo === 'plantao').length,
                    genericos: visitas.filter(v => v.tipo === 'generico').length,
                    outros: visitas.filter(v => v.tipo === 'outro').length,
                    realizados: visitas.filter(v => v.status === 'realizado').length,
                    periodo: `${Utils.formatDate(visitas[visitas.length-1].data)} a ${Utils.formatDate(visitas[0].data)}`,
                    agendamentos: visitas.sort((a,b) => new Date(b.data) - new Date(a.data)).map(v => ({
                        tipo: v.tipo,
                        data: v.data,
                        horario: v.horario,
                        status: v.status,
                        localVisita: v.localVisita,
                        construtorNome: v.construtorNome,
                        construtorEmpreendimento: v.construtorEmpreendimento,
                        construtorAssuntos: v.construtorAssuntos,
                        equipeTipo: v.equipeTipo,
                        equipeParticipantes: v.equipeParticipantes,
                        equipeAssuntos: v.equipeAssuntos,
                        plantaoLocal: v.plantaoLocal,
                        detalhesPlantoes: v.detalhesPlantoes,
                        clientesAtendidos: v.clientesAtendidos,
                        negociosGerados: v.negociosGerados,
                        genericoTitulo: v.genericoTitulo,
                        genericoLocal: v.genericoLocal,
                        genericoDescricao: v.genericoDescricao,
                        outroDescricao: v.outroDescricao,
                        observacoes: v.observacoes
                    }))
                };
                
                Utils.generateAgendaReport(agendaData);
            },

            // --- MODALS ---
            openModal: (type) => {
                document.getElementById(`overlay-${type}`).classList.add('active');
                requestAnimationFrame(() => {
                    document.getElementById(`overlay-${type}`).classList.add('active');
                });
            },
            closeModals: () => {
                document.querySelectorAll('.modal-overlay').forEach(el => el.classList.remove('active'));
            },

            openNewCliente: (fromVisita = false) => {
                document.getElementById('form-cliente').reset();
                document.getElementById('c-id').value = '';
                document.getElementById('title-cliente').innerText = 'Novo Cliente';
                
                // Popular select de imóveis de interesse
                const imovelSelect = document.getElementById('c-imovel-interesse');
                imovelSelect.innerHTML = '<option value="">Selecione um imóvel...</option>';
                UI.data.imoveis.forEach(i => {
                    imovelSelect.innerHTML += `<option value="${i.id}">${i.titulo.substring(0, 40)}...</option>`;
                });
                
                // Popular select de etapas do funil
                const etapaSelect = document.getElementById('c-etapa-funil');
                etapaSelect.innerHTML = '';
                UI.data.funilEtapas.sort((a, b) => a.ordem - b.ordem).forEach(etapa => {
                    etapaSelect.innerHTML += `<option value="${etapa.id}">${etapa.nome}</option>`;
                });
                
                UI.openModal('cliente');
            },

            openNewImovel: () => {
                document.getElementById('form-imovel').reset();
                document.getElementById('i-id').value = '';
                document.getElementById('title-imovel').innerText = 'Novo Imóvel';
                
                // Reset image gallery
                const gallery = document.getElementById('image-gallery');
                gallery.innerHTML = `
                    <div class="image-gallery-item add-image-btn" onclick="document.getElementById('i-imagem-input').click()">
                        <i class="fas fa-plus"></i>
                        <span>Adicionar Foto</span>
                    </div>
                `;
                document.getElementById('image-counter').innerText = '0';
                document.getElementById('i-imagens-data').value = '';
                
                // Set today as default for data de entrega
                const hoje = Utils.getToday();
                document.getElementById('i-data-entrega').value = '';
                
                UI.openModal('imovel');
            },

            openNewVisita: () => {
                const clienteSelect = document.getElementById('v-cliente');
                const imovelSelect = document.getElementById('v-imovel');
                
                // Popular clientes
                clienteSelect.innerHTML = '<option value="">Selecione...</option>';
                UI.data.clientes.forEach(c => {
                    clienteSelect.innerHTML += `<option value="${c.id}">${c.nome}</option>`;
                });
                
                // Popular imóveis
                imovelSelect.innerHTML = '<option value="">Selecione...</option>';
                UI.data.imoveis.filter(i => i.status === 'disponivel').forEach(i => {
                    imovelSelect.innerHTML += `<option value="${i.id}">${i.titulo.substring(0, 30)}...</option>`;
                });
                
                // Reset form
                document.getElementById('form-visita').reset();
                document.getElementById('v-id').value = '';
                document.getElementById('title-visita').innerText = 'Novo Agendamento';
                
                // Set default date and time
                document.getElementById('v-data').value = Utils.getToday();
                document.getElementById('v-horario').value = Utils.getTodayTime();
                
                // Reset campos específicos
                document.querySelectorAll('.tipo-specific-group').forEach(group => {
                    group.style.display = 'none';
                    group.querySelectorAll('input, textarea, select').forEach(input => {
                        input.value = '';
                    });
                });
                
                // Mostrar campos padrão
                UI.toggleVisitaFields();
                
                UI.openModal('visita');
            },

            toggleVisitaFields: () => {
                const tipo = document.getElementById('v-tipo').value;
                
                // Ocultar todos os grupos específicos
                document.querySelectorAll('.tipo-specific-group').forEach(group => {
                    group.style.display = 'none';
                });
                
                // Mostrar grupo específico do tipo selecionado
                const grupoId = `grupo-${tipo}`;
                const grupoEspecifico = document.getElementById(grupoId);
                if(grupoEspecifico) {
                    grupoEspecifico.style.display = 'block';
                }
                
                // Mostrar/ocultar campos de cliente e imóvel dependendo do tipo
                const tiposComCliente = ['visita', 'documentacao'];
                const tiposComImovel = ['visita'];
                
                document.querySelectorAll('.cliente-dependent-group').forEach(el => {
                    el.style.display = tiposComCliente.includes(tipo) ? 'block' : 'none';
                });
                
                document.querySelectorAll('.imovel-dependent-group').forEach(el => {
                    el.style.display = tiposComImovel.includes(tipo) ? 'block' : 'none';
                });
                
                // Ajustar required
                document.getElementById('v-cliente').required = tiposComCliente.includes(tipo);
                document.getElementById('v-imovel').required = tiposComImovel.includes(tipo);
            },

            openNewVisitaFromImovel: (imovelId) => {
                UI.openNewVisita();
                setTimeout(() => {
                    document.getElementById('v-imovel').value = imovelId;
                    document.getElementById('v-tipo').value = 'visita';
                    UI.toggleVisitaFields();
                }, 100);
            },

            openSettings: () => {
                const s = Storage.getSettings();
                document.getElementById('s-nome').value = s.nome || '';
                document.getElementById('s-creci').value = s.creci || '';
                document.getElementById('s-telefone').value = s.telefone || '';
                document.getElementById('s-email').value = s.email || '';
                document.getElementById('s-imobiliaria').value = s.imobiliaria || '';
                document.getElementById('s-comissao').value = s.comissao || 5;
                
                UI.openModal('settings');
            }
        };

        // --- APP LOGIC ---
        const App = {
            cliente: {
                save: (e) => {
                    e.preventDefault();
                    const id = document.getElementById('c-id').value || Utils.id();
                    const nome = document.getElementById('c-nome').value;
                    const tipo = document.getElementById('c-tipo').value;
                    const etapaFunil = document.getElementById('c-etapa-funil').value || 'lead';
                    const telefone = document.getElementById('c-telefone').value;
                    const email = document.getElementById('c-email').value;
                    const imovelInteresseId = document.getElementById('c-imovel-interesse').value || null;
                    const dataNascimento = document.getElementById('c-data-nascimento').value || null;
                    const faixaPreco = document.getElementById('c-faixa-preco').value;
                    const observacoes = document.getElementById('c-observacoes').value;

                    const newClient = { 
                        id, nome, tipo, etapaFunil, telefone, email, 
                        imovelInteresseId, dataNascimento,
                        faixaPreco, observacoes,
                        dataCriacao: new Date().toISOString(),
                        dataEntradaFunil: new Date().toISOString().split('T')[0]
                    };
                    
                    const existingIdx = UI.data.clientes.findIndex(c => c.id === id);
                    if(existingIdx >= 0) {
                        // Mantém a data de entrada no funil se já existir
                        if(UI.data.clientes[existingIdx].dataEntradaFunil && UI.data.clientes[existingIdx].etapaFunil === etapaFunil) {
                            newClient.dataEntradaFunil = UI.data.clientes[existingIdx].dataEntradaFunil;
                        }
                        UI.data.clientes[existingIdx] = newClient;
                    } else {
                        UI.data.clientes.push(newClient);
                    }

                    Storage.set('clientes', UI.data.clientes);
                    Utils.toast('Cliente salvo!');
                    UI.closeModals();
                    UI.renderDashboard();
                    UI.renderClientes();
                    UI.renderFunil();
                },
                edit: (id) => {
                    const c = UI.data.clientes.find(x => x.id === id);
                    if(!c) return;
                    
                    document.getElementById('c-id').value = c.id;
                    document.getElementById('c-nome').value = c.nome;
                    document.getElementById('c-tipo').value = c.tipo;
                    document.getElementById('c-etapa-funil').value = c.etapaFunil || 'lead';
                    document.getElementById('c-telefone').value = c.telefone;
                    document.getElementById('c-email').value = c.email || '';
                    document.getElementById('c-data-nascimento').value = c.dataNascimento || '';
                    document.getElementById('c-faixa-preco').value = c.faixaPreco || '';
                    document.getElementById('c-observacoes').value = c.observacoes || '';
                    
                    // Popular select de imóveis de interesse
                    const imovelSelect = document.getElementById('c-imovel-interesse');
                    imovelSelect.innerHTML = '<option value="">Selecione um imóvel...</option>';
                    UI.data.imoveis.forEach(i => {
                        imovelSelect.innerHTML += `<option value="${i.id}">${i.titulo.substring(0, 40)}...</option>`;
                    });
                    document.getElementById('c-imovel-interesse').value = c.imovelInteresseId || '';
                    
                    // Popular select de etapas do funil
                    const etapaSelect = document.getElementById('c-etapa-funil');
                    etapaSelect.innerHTML = '';
                    UI.data.funilEtapas.sort((a, b) => a.ordem - b.ordem).forEach(etapa => {
                        etapaSelect.innerHTML += `<option value="${etapa.id}">${etapa.nome}</option>`;
                    });
                    etapaSelect.value = c.etapaFunil || 'lead';
                    
                    document.getElementById('title-cliente').innerText = 'Editar Cliente';
                    UI.openModal('cliente');
                },
                whatsapp: (id) => {
                    const c = UI.data.clientes.find(x => x.id === id);
                    if(!c || !c.telefone) {
                        Utils.toast('Cliente sem número de telefone', 'error');
                        return;
                    }
                    
                    const settings = Storage.getSettings();
                    const message = Utils.generateWhatsAppMessage(c, settings);
                    
                    Utils.openWhatsApp(c.telefone, message);
                    
                    Utils.toast(`Abrindo WhatsApp com ${c.nome.split(' ')[0]}`);
                }
            },

            imovel: {
                save: (e) => {
                    e.preventDefault();
                    const id = document.getElementById('i-id').value || Utils.id();
                    
                    const isNew = !document.getElementById('i-id').value;

                    // Obter imagens do input hidden
                    const imagensData = document.getElementById('i-imagens-data').value;
                    const imagens = imagensData ? JSON.parse(imagensData) : [];

                    const imovel = {
                        id,
                        titulo: document.getElementById('i-titulo').value,
                        tipo: document.getElementById('i-tipo').value,
                        transacao: document.getElementById('i-transacao').value,
                        precoVenda: Utils.parseCurrency(document.getElementById('i-preco-venda').value) || null,
                        precoAluguel: Utils.parseCurrency(document.getElementById('i-preco-aluguel').value) || null,
                        dataEntrega: document.getElementById('i-data-entrega').value || null,
                        construtora: document.getElementById('i-construtora').value || '',
                        formaPagamento: document.getElementById('i-forma-pagamento').value || '',
                        condominio: Utils.parseCurrency(document.getElementById('i-condominio').value) || null,
                        gasEncanado: document.getElementById('i-gas-encanado').value || 'nao',
                        endereco: document.getElementById('i-endereco').value,
                        area: parseInt(document.getElementById('i-area').value) || null,
                        quartos: parseInt(document.getElementById('i-quartos').value) || null,
                        banheiros: parseInt(document.getElementById('i-banheiros').value) || null,
                        vagas: parseInt(document.getElementById('i-vagas').value) || null,
                        status: document.getElementById('i-status').value,
                        descricao: document.getElementById('i-descricao').value,
                        observacoes: document.getElementById('i-observacoes').value,
                        imagens: imagens,
                        dataCriacao: new Date().toISOString()
                    };

                    // Se o imóvel foi vendido/alugado agora, registrar data
                    if((imovel.status === 'vendido' || imovel.status === 'alugado') && isNew) {
                        imovel.dataVenda = new Date().toISOString().split('T')[0];
                    }

                    const idx = UI.data.imoveis.findIndex(i => i.id === id);
                    if(idx >= 0) {
                        // Mantém dataVenda se já existir
                        if(UI.data.imoveis[idx].dataVenda && !imovel.dataVenda) {
                            imovel.dataVenda = UI.data.imoveis[idx].dataVenda;
                        }
                        UI.data.imoveis[idx] = imovel;
                    }
                    else UI.data.imoveis.push(imovel);

                    Storage.set('imoveis', UI.data.imoveis);
                    Utils.toast('Imóvel salvo!');
                    UI.closeModals();
                    UI.renderDashboard();
                    UI.renderImoveis();
                    UI.renderRelatorios();
                    
                    // Atualizar clientes que têm este imóvel como interesse
                    UI.data.clientes.forEach(cliente => {
                        if(cliente.imovelInteresseId === id) {
                            // O imóvel foi atualizado, pode-se enviar notificação se necessário
                        }
                    });
                },
                edit: (id) => {
                    const i = UI.data.imoveis.find(x => x.id === id);
                    if(!i) return;

                    document.getElementById('i-id').value = i.id;
                    document.getElementById('i-titulo').value = i.titulo;
                    document.getElementById('i-tipo').value = i.tipo;
                    document.getElementById('i-transacao').value = i.transacao;
                    document.getElementById('i-preco-venda').value = i.precoVenda ? Utils.formatCurrency(i.precoVenda) : '';
                    document.getElementById('i-preco-aluguel').value = i.precoAluguel ? Utils.formatCurrency(i.precoAluguel) : '';
                    document.getElementById('i-data-entrega').value = i.dataEntrega || '';
                    document.getElementById('i-construtora').value = i.construtora || '';
                    document.getElementById('i-forma-pagamento').value = i.formaPagamento || '';
                    document.getElementById('i-condominio').value = i.condominio ? Utils.formatCurrency(i.condominio) : '';
                    document.getElementById('i-gas-encanado').value = i.gasEncanado || 'nao';
                    document.getElementById('i-endereco').value = i.endereco;
                    document.getElementById('i-area').value = i.area || '';
                    document.getElementById('i-quartos').value = i.quartos || '';
                    document.getElementById('i-banheiros').value = i.banheiros || '';
                    document.getElementById('i-vagas').value = i.vagas || '';
                    document.getElementById('i-status').value = i.status;
                    document.getElementById('i-descricao').value = i.descricao || '';
                    document.getElementById('i-observacoes').value = i.observacoes || '';

                    // Atualizar galeria de imagens
                    const gallery = document.getElementById('image-gallery');
                    gallery.innerHTML = '';
                    
                    if(i.imagens && i.imagens.length > 0) {
                        i.imagens.forEach((img, index) => {
                            const item = document.createElement('div');
                            item.className = 'image-gallery-item';
                            item.innerHTML = `
                                <img src="${img}" class="image-gallery-img">
                                <button class="remove-image-btn" onclick="App.imovel.removeImage(${index})">
                                    <i class="fas fa-times"></i>
                                </button>
                            `;
                            gallery.appendChild(item);
                        });
                    }
                    
                    const addBtn = document.createElement('div');
                    addBtn.className = 'image-gallery-item add-image-btn';
                    addBtn.onclick = () => document.getElementById('i-imagem-input').click();
                    addBtn.innerHTML = `
                        <i class="fas fa-plus"></i>
                        <span>Adicionar Foto</span>
                    `;
                    gallery.appendChild(addBtn);
                    
                    document.getElementById('image-counter').innerText = i.imagens ? i.imagens.length : 0;
                    document.getElementById('i-imagens-data').value = i.imagens ? JSON.stringify(i.imagens) : '';
                    
                    // Toggle aluguel fields
                    App.imovel.toggleAluguelFields();
                    
                    document.getElementById('title-imovel').innerText = 'Editar Imóvel';
                    UI.openModal('imovel');
                },
                handleMultipleImages: async (input) => {
                    const files = Array.from(input.files).slice(0, 15); // Máximo 15 imagens
                    const currentImages = JSON.parse(document.getElementById('i-imagens-data').value || '[]');
                    
                    if (currentImages.length + files.length > 15) {
                        Utils.toast('Máximo de 15 imagens permitido', 'error');
                        return;
                    }
                    
                    for (const file of files) {
                        try {
                            const base64 = await Utils.readImage(file);
                            const compressed = await Utils.compressImage(base64);
                            currentImages.push(compressed);
                        } catch (error) {
                            console.error('Erro ao processar imagem:', error);
                        }
                    }
                    
                    // Atualizar galeria
                    const gallery = document.getElementById('image-gallery');
                    gallery.innerHTML = '';
                    
                    currentImages.forEach((img, index) => {
                        const item = document.createElement('div');
                        item.className = 'image-gallery-item';
                        item.innerHTML = `
                            <img src="${img}" class="image-gallery-img">
                            <button class="remove-image-btn" onclick="App.imovel.removeImage(${index})">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        gallery.appendChild(item);
                    });
                    
                    const addBtn = document.createElement('div');
                    addBtn.className = 'image-gallery-item add-image-btn';
                    addBtn.onclick = () => document.getElementById('i-imagem-input').click();
                    addBtn.innerHTML = `
                        <i class="fas fa-plus"></i>
                        <span>Adicionar Foto</span>
                    `;
                    gallery.appendChild(addBtn);
                    
                    document.getElementById('image-counter').innerText = currentImages.length;
                    document.getElementById('i-imagens-data').value = JSON.stringify(currentImages);
                    
                    // Reset input
                    input.value = '';
                },
                removeImage: (index) => {
                    const currentImages = JSON.parse(document.getElementById('i-imagens-data').value || '[]');
                    currentImages.splice(index, 1);
                    
                    // Atualizar galeria
                    const gallery = document.getElementById('image-gallery');
                    gallery.innerHTML = '';
                    
                    currentImages.forEach((img, idx) => {
                        const item = document.createElement('div');
                        item.className = 'image-gallery-item';
                        item.innerHTML = `
                            <img src="${img}" class="image-gallery-img">
                            <button class="remove-image-btn" onclick="App.imovel.removeImage(${idx})">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        gallery.appendChild(item);
                    });
                    
                    const addBtn = document.createElement('div');
                    addBtn.className = 'image-gallery-item add-image-btn';
                    addBtn.onclick = () => document.getElementById('i-imagem-input').click();
                    addBtn.innerHTML = `
                        <i class="fas fa-plus"></i>
                        <span>Adicionar Foto</span>
                    `;
                    gallery.appendChild(addBtn);
                    
                    document.getElementById('image-counter').innerText = currentImages.length;
                    document.getElementById('i-imagens-data').value = JSON.stringify(currentImages);
                },
                toggleAluguelFields: () => {
                    const transacao = document.getElementById('i-transacao').value;
                    const aluguelGroup = document.getElementById('i-aluguel-group');
                    
                    if(transacao === 'aluguel' || transacao === 'ambos') {
                        aluguelGroup.style.display = 'block';
                        document.getElementById('i-preco-aluguel').required = true;
                    } else {
                        aluguelGroup.style.display = 'none';
                        document.getElementById('i-preco-aluguel').required = false;
                    }
                }
            },

            agenda: {
                save: (e) => {
                    e.preventDefault();
                    const id = document.getElementById('v-id').value || Utils.id();
                    
                    const visita = {
                        id,
                        tipo: document.getElementById('v-tipo').value,
                        clienteId: document.getElementById('v-cliente').value || null,
                        imovelId: document.getElementById('v-imovel').value || null,
                        data: document.getElementById('v-data').value,
                        horario: document.getElementById('v-horario').value,
                        status: document.getElementById('v-status').value,
                        observacoes: document.getElementById('v-observacoes').value,
                        
                        // Campos específicos por tipo
                        localVisita: document.getElementById('v-local-visita')?.value || '',
                        construtorNome: document.getElementById('v-construtor-nome')?.value || '',
                        construtorEmpreendimento: document.getElementById('v-construtor-empreendimento')?.value || '',
                        construtorAssuntos: document.getElementById('v-construtor-assuntos')?.value || '',
                        equipeTipo: document.getElementById('v-equipe-tipo')?.value || '',
                        equipeParticipantes: document.getElementById('v-equipe-participantes')?.value || '',
                        equipeAssuntos: document.getElementById('v-equipe-assuntos')?.value || '',
                        plantaoLocal: document.getElementById('v-plantao-local')?.value || '',
                        detalhesPlantoes: document.getElementById('v-detalhes-plantoes')?.value || '',
                        clientesAtendidos: document.getElementById('v-clientes-atendidos')?.value || '',
                        negociosGerados: document.getElementById('v-negocios-gerados')?.value || '',
                        genericoTitulo: document.getElementById('v-generico-titulo')?.value || '',
                        genericoLocal: document.getElementById('v-generico-local')?.value || '',
                        genericoDescricao: document.getElementById('v-generico-descricao')?.value || '',
                        outroDescricao: document.getElementById('v-outro-descricao')?.value || '',
                        dataCriacao: new Date().toISOString()
                    };

                    const idx = UI.data.visitas.findIndex(v => v.id === id);
                    if(idx >= 0) UI.data.visitas[idx] = visita;
                    else UI.data.visitas.push(visita);

                    Storage.set('visitas', UI.data.visitas);
                    Utils.toast('Agendamento salvo!');
                    UI.closeModals();
                    UI.renderDashboard();
                    UI.renderAgenda(UI.currentAgendaFilter);
                },
                edit: (id) => {
                    const v = UI.data.visitas.find(x => x.id === id);
                    if(!v) return;
                    
                    document.getElementById('v-id').value = v.id;
                    document.getElementById('v-tipo').value = v.tipo;
                    document.getElementById('v-cliente').value = v.clienteId || '';
                    document.getElementById('v-imovel').value = v.imovelId || '';
                    document.getElementById('v-data').value = v.data;
                    document.getElementById('v-horario').value = v.horario;
                    document.getElementById('v-status').value = v.status;
                    document.getElementById('v-observacoes').value = v.observacoes || '';
                    
                    // Preencher campos específicos
                    if(document.getElementById('v-local-visita')) document.getElementById('v-local-visita').value = v.localVisita || '';
                    if(document.getElementById('v-construtor-nome')) document.getElementById('v-construtor-nome').value = v.construtorNome || '';
                    if(document.getElementById('v-construtor-empreendimento')) document.getElementById('v-construtor-empreendimento').value = v.construtorEmpreendimento || '';
                    if(document.getElementById('v-construtor-assuntos')) document.getElementById('v-construtor-assuntos').value = v.construtorAssuntos || '';
                    if(document.getElementById('v-equipe-tipo')) document.getElementById('v-equipe-tipo').value = v.equipeTipo || '';
                    if(document.getElementById('v-equipe-participantes')) document.getElementById('v-equipe-participantes').value = v.equipeParticipantes || '';
                    if(document.getElementById('v-equipe-assuntos')) document.getElementById('v-equipe-assuntos').value = v.equipeAssuntos || '';
                    if(document.getElementById('v-plantao-local')) document.getElementById('v-plantao-local').value = v.plantaoLocal || '';
                    if(document.getElementById('v-detalhes-plantoes')) document.getElementById('v-detalhes-plantoes').value = v.detalhesPlantoes || '';
                    if(document.getElementById('v-clientes-atendidos')) document.getElementById('v-clientes-atendidos').value = v.clientesAtendidos || '';
                    if(document.getElementById('v-negocios-gerados')) document.getElementById('v-negocios-gerados').value = v.negociosGerados || '';
                    if(document.getElementById('v-generico-titulo')) document.getElementById('v-generico-titulo').value = v.genericoTitulo || '';
                    if(document.getElementById('v-generico-local')) document.getElementById('v-generico-local').value = v.genericoLocal || '';
                    if(document.getElementById('v-generico-descricao')) document.getElementById('v-generico-descricao').value = v.genericoDescricao || '';
                    if(document.getElementById('v-outro-descricao')) document.getElementById('v-outro-descricao').value = v.outroDescricao || '';
                    
                    // Popular clientes e imóveis
                    const clienteSelect = document.getElementById('v-cliente');
                    clienteSelect.innerHTML = '<option value="">Selecione...</option>';
                    UI.data.clientes.forEach(c => {
                        clienteSelect.innerHTML += `<option value="${c.id}">${c.nome}</option>`;
                    });
                    
                    const imovelSelect = document.getElementById('v-imovel');
                    imovelSelect.innerHTML = '<option value="">Selecione...</option>';
                    UI.data.imoveis.filter(i => i.status === 'disponivel').forEach(i => {
                        imovelSelect.innerHTML += `<option value="${i.id}">${i.titulo.substring(0, 30)}...</option>`;
                    });
                    
                    // Atualizar campos dependentes do tipo
                    UI.toggleVisitaFields();
                    
                    document.getElementById('title-visita').innerText = 'Editar Agendamento';
                    UI.openModal('visita');
                }
            },

            settings: {
                save: (e) => {
                    e.preventDefault();
                    
                    const settings = {
                        nome: document.getElementById('s-nome').value,
                        creci: document.getElementById('s-creci').value,
                        telefone: document.getElementById('s-telefone').value,
                        email: document.getElementById('s-email').value,
                        imobiliaria: document.getElementById('s-imobiliaria').value,
                        comissao: parseFloat(document.getElementById('s-comissao').value) || 5
                    };
                    
                    Storage.saveSettings(settings);
                    Utils.toast('Configurações salvas!');
                    UI.closeModals();
                    UI.renderDashboard();
                }
            },

            whatsapp: {
                shareImovel: (id) => {
                    const i = UI.data.imoveis.find(x => x.id === id);
                    if(!i) return;
                    
                    const settings = Storage.getSettings();
                    
                    let message = `🏠 *${i.titulo}*\n\n`;
                    message += `*Endereço:* ${i.endereco}\n`;
                    message += `*Tipo:* ${Utils.getTipoText(i.tipo)}\n`;
                    message += `*Área:* ${i.area || 0}m²\n`;
                    message += `*Quartos:* ${i.quartos || 0}\n`;
                    message += `*Banheiros:* ${i.banheiros || 0}\n`;
                    message += `*Vagas:* ${i.vagas || 0}\n\n`;
                    
                    if(i.precoVenda) message += `*Preço de Venda:* ${Utils.formatCurrency(i.precoVenda)}\n`;
                    if(i.precoAluguel) message += `*Preço de Aluguel:* ${Utils.formatCurrency(i.precoAluguel)}/mês\n`;
                    
                    message += `\n*Descrição:* ${i.descricao || 'Sem descrição'}\n\n`;
                    message += `*Corretor:* ${settings.nome || ''}\n`;
                    message += `*Telefone:* ${settings.telefone || ''}\n`;
                    message += `*Imobiliária:* ${settings.imobiliaria || ''}\n`;
                    message += `*CRECI:* ${settings.creci || ''}\n\n`;
                    message += `_Para mais informações, entre em contato!_`;
                    
                    // Abrir WhatsApp com a mensagem
                    window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
                    
                    Utils.toast('Abrindo WhatsApp para compartilhar imóvel!');
                }
            },

            link: {
                save: (e) => {
                    e.preventDefault();
                    const id = document.getElementById('l-id').value || Utils.id();
                    
                    const link = {
                        id,
                        titulo: document.getElementById('l-titulo').value,
                        url: document.getElementById('l-url').value,
                        categoria: document.getElementById('l-categoria').value,
                        descricao: document.getElementById('l-descricao').value,
                        dataCriacao: new Date().toISOString()
                    };

                    const idx = UI.data.links.findIndex(l => l.id === id);
                    if(idx >= 0) UI.data.links[idx] = link;
                    else UI.data.links.push(link);

                    Storage.saveLinks(UI.data.links);
                    Utils.toast('Link salvo!');
                    UI.closeModals();
                    UI.renderLinks();
                },
                edit: (id) => {
                    const l = UI.data.links.find(x => x.id === id);
                    if(!l) return;
                    
                    document.getElementById('l-id').value = l.id;
                    document.getElementById('l-titulo').value = l.titulo;
                    document.getElementById('l-url').value = l.url;
                    document.getElementById('l-categoria').value = l.categoria;
                    document.getElementById('l-descricao').value = l.descricao || '';
                    
                    document.getElementById('title-link').innerText = 'Editar Link';
                    UI.openModal('link');
                },
                open: (id) => {
                    const l = UI.data.links.find(x => x.id === id);
                    if(!l) return;
                    
                    window.open(l.url, '_blank');
                    Utils.toast('Abrindo link...');
                },
                copy: (id) => {
                    const l = UI.data.links.find(x => x.id === id);
                    if(!l) return;
                    
                    navigator.clipboard.writeText(l.url).then(() => {
                        Utils.toast('Link copiado!');
                    });
                },
                delete: (id) => {
                    if(!confirm('Tem certeza que deseja excluir este link?')) return;
                    
                    UI.data.links = UI.data.links.filter(l => l.id !== id);
                    Storage.saveLinks(UI.data.links);
                    Utils.toast('Link excluído!');
                    UI.renderLinks();
                }
            },

            backup: {
                exportData: function() {
                    const data = {
                        clientes: Storage.get('clientes'),
                        imoveis: Storage.get('imoveis'),
                        visitas: Storage.get('visitas'),
                        links: Storage.getLinks(),
                        settings: Storage.getSettings(),
                        funilEtapas: Storage.getFunilEtapas()
                    };

                    const dataStr = JSON.stringify(data, null, 2);
                    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);

                    const exportFileDefaultName = `imobipro_backup_${new Date().toISOString().split('T')[0]}.json`;

                    const linkElement = document.createElement('a');
                    linkElement.setAttribute('href', dataUri);
                    linkElement.setAttribute('download', exportFileDefaultName);
                    linkElement.click();

                    Utils.toast('Backup exportado com sucesso!');
                },

                importTrigger: function() {
                    document.getElementById('import-file').click();
                },

                importData: function(input) {
                    const file = input.files[0];
                    if (!file) {
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);

                            // Validar se o JSON tem a estrutura esperada
                            if (data.clientes && data.imoveis && data.visitas && data.links && data.settings && data.funilEtapas) {
                                // Restaurar dados
                                Storage.set('clientes', data.clientes);
                                Storage.set('imoveis', data.imoveis);
                                Storage.set('visitas', data.visitas);
                                Storage.saveLinks(data.links);
                                Storage.saveSettings(data.settings);
                                Storage.saveFunilEtapas(data.funilEtapas);

                                // Atualizar a UI
                                UI.data.clientes = data.clientes;
                                UI.data.imoveis = data.imoveis;
                                UI.data.visitas = data.visitas;
                                UI.data.links = data.links;
                                UI.data.funilEtapas = data.funilEtapas;

                                // Re-renderizar tudo
                                UI.renderDashboard();
                                UI.renderClientes();
                                UI.renderImoveis();
                                UI.renderAgenda();
                                UI.renderFunil();
                                UI.renderLinks();
                                UI.renderRelatorios();

                                Utils.toast('Backup importado com sucesso!');
                            } else {
                                Utils.toast('Arquivo de backup inválido', 'error');
                            }
                        } catch (error) {
                            console.error(error);
                            Utils.toast('Erro ao importar backup', 'error');
                        }
                    };
                    reader.readAsText(file);
                },

                clearData: function() {
                    if (confirm('Tem certeza que deseja resetar todos os dados? Essa ação não pode ser desfeita.')) {
                        localStorage.clear();
                        // Recarregar a página para refletir o reset
                        location.reload();
                    }
                }
            }
        };

        // Inicializar a aplicação
        UI.init();
    </script>
</body>
</html>
